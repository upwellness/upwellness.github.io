<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradeWise Pro 2.6 - Ultimate Analysis</title>
    
    <!-- React & Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.js" crossorigin></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.js" crossorigin></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #020617; color: #e2e8f0; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .glass-panel {
            background: rgba(15, 23, 42, 0.75);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }
        .chart-box { height: 500px; width: 100%; position: relative; }
        .mini-chart-box { height: 160px; width: 100%; border-radius: 8px; overflow: hidden; background: #0f172a; border: 1px solid #1e293b; }
        .active-tf { border-color: #3b82f6; background: rgba(59, 130, 246, 0.15); box-shadow: 0 0 20px rgba(59, 130, 246, 0.25); transform: translateY(-2px); }
        .copy-feedback { animation: fadeUp 1.5s forwards; }
        @keyframes fadeUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-20px); } }
        .symbol-item .delete-btn { opacity: 0; transition: opacity 0.2s; }
        .symbol-item:hover .delete-btn { opacity: 1; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }
        .step-item { transition: all 0.3s ease; }
        .step-item:hover { transform: translateX(4px); background: rgba(255,255,255,0.03); }
        .power-bar-fill { transition: width 1s cubic-bezier(0.4, 0, 0.2, 1); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- 1. STORAGE HOOK (Supabase Support) ---
        const useStorage = () => {
            const [supabase, setSupabase] = useState(null);
            const [symbols, setSymbols] = useState([]);
            const [config, setConfig] = useState({
                lineToken: localStorage.getItem('tw_line_token') || '',
                sbUrl: localStorage.getItem('tw_sb_url') || '',
                sbKey: localStorage.getItem('tw_sb_key') || ''
            });

            useEffect(() => {
                if (config.sbUrl && config.sbKey && window.supabase) {
                    try {
                        const client = window.supabase.createClient(config.sbUrl, config.sbKey);
                        setSupabase(client);
                        fetchSupabaseSymbols(client);
                    } catch (e) { loadLocalSymbols(); }
                } else { setSupabase(null); loadLocalSymbols(); }
            }, [config.sbUrl, config.sbKey]);

            const loadLocalSymbols = () => {
                const local = JSON.parse(localStorage.getItem('tw_symbols') || '[]');
                setSymbols(local);
            };

            const fetchSupabaseSymbols = async (client) => {
                const { data, error } = await client.from('symbols').select('*').order('created_at', { ascending: true });
                if (error) loadLocalSymbols(); else setSymbols(data || []);
            };

            const addSymbol = async (name) => {
                const newSym = { name, created_at: new Date().toISOString() };
                if (supabase) {
                    const { data, error } = await supabase.from('symbols').insert([newSym]).select();
                    if (!error && data) setSymbols([...symbols, data[0]]);
                } else {
                    const updated = [...symbols, { ...newSym, id: Date.now() }];
                    setSymbols(updated); localStorage.setItem('tw_symbols', JSON.stringify(updated));
                }
            };

            const removeSymbol = async (id) => {
                if (supabase) {
                    const { error } = await supabase.from('symbols').delete().eq('id', id);
                    if (!error) setSymbols(symbols.filter(s => s.id !== id));
                } else {
                    const updated = symbols.filter(s => s.id !== id);
                    setSymbols(updated); localStorage.setItem('tw_symbols', JSON.stringify(updated));
                }
            };

            const updateConfig = (key, value) => {
                localStorage.setItem(key, value);
                setConfig(prev => ({ ...prev, [key === 'tw_line_token' ? 'lineToken' : (key === 'tw_sb_url' ? 'sbUrl' : 'sbKey')]: value }));
            };

            return { symbols, addSymbol, removeSymbol, config, updateConfig, isCloud: !!supabase };
        };

        // --- 2. CORE MATH & INDICATORS ---
        const calculateSMA = (data, count) => data.map((d, i, arr) => i < count - 1 ? { time: d.time, value: NaN } : { time: d.time, value: arr.slice(i - count + 1, i + 1).reduce((acc, val) => acc + val.close, 0) / count }).filter(d => !isNaN(d.value));
        const calculateATR = (data, period = 14) => {
            let trs = []; for(let i=1; i<data.length; i++) trs.push(Math.max(data[i].high - data[i].low, Math.abs(data[i].high - data[i-1].close), Math.abs(data[i].low - data[i-1].close)));
            return trs.slice(-period).reduce((a, b) => a + b, 0) / period;
        };
        const calculateVWAP = (candles, volumes) => {
            let cumVol = 0, cumVolPrice = 0;
            return candles.map((c, i) => {
                const vol = volumes[i].value || 1; cumVol += vol; cumVolPrice += ((c.high + c.low + c.close) / 3 * vol);
                return { time: c.time, value: cumVolPrice / cumVol };
            });
        };
        const calculateRSI = (prices, period = 14) => {
            let gains = 0, losses = 0;
            for (let i = 1; i <= period; i++) {
                const change = prices[i] - prices[i - 1];
                if (change > 0) gains += change; else losses -= Math.abs(change);
            }
            let avgGain = gains / period; let avgLoss = losses / period;
            const rsiArray = []; for(let i=0; i<period; i++) rsiArray.push(50);
            for (let i = period + 1; i < prices.length; i++) {
                const change = prices[i] - prices[i - 1];
                avgGain = (avgGain * (period - 1) + (change > 0 ? change : 0)) / period;
                avgLoss = (avgLoss * (period - 1) + (change < 0 ? -change : 0)) / period;
                const rs = avgGain / avgLoss; rsiArray.push(100 - (100 / (1 + rs)));
            }
            return rsiArray;
        };
        const findDivergence = (prices, rsis, lookback = 15) => {
            if(prices.length < lookback || rsis.length < lookback) return null;
            const currPrice = prices[prices.length-1]; const prevPricePeak = Math.max(...prices.slice(prices.length-lookback, prices.length-2));
            const currRSI = rsis[rsis.length-1]; const prevRSIPeak = Math.max(...rsis.slice(rsis.length-lookback, rsis.length-2));
            if (currPrice > prevPricePeak && currRSI < prevRSIPeak && currRSI > 65) return "Bearish Divergence";
            
            const currPriceLow = prices[prices.length-1]; const prevPriceLow = Math.min(...prices.slice(prices.length-lookback, prices.length-2));
            const currRSILow = rsis[rsis.length-1]; const prevRSILow = Math.min(...rsis.slice(rsis.length-lookback, rsis.length-2));
            if (currPriceLow < prevPriceLow && currRSILow > prevRSILow && currRSILow < 35) return "Bullish Divergence";
            return null;
        };
        const findZones = (data, window = 20) => {
            let res = [], sup = [];
            for(let i = window; i < data.length - window; i++) {
                const c = data[i]; let isHigh = true, isLow = true;
                for(let j = 1; j <= window; j++) {
                    if(data[i-j].high > c.high || data[i+j].high > c.high) isHigh = false;
                    if(data[i-j].low < c.low || data[i+j].low < c.low) isLow = false;
                }
                if(isHigh) res.push(c.high); if(isLow) sup.push(c.low);
            }
            return { res: res.slice(-2), sup: sup.slice(-2) };
        };
        const findFVG = (candles) => {
            const fvgs = [];
            for(let i = candles.length - 2; i > candles.length - 50; i--) {
                const c = candles[i], prev = candles[i-1], next = candles[i+1];
                if(prev && next) {
                    if (c.close > c.open && next.low > prev.high) fvgs.push({ type: 'BULL', top: next.low, bottom: prev.high, time: c.time });
                    else if (c.close < c.open && next.high < prev.low) fvgs.push({ type: 'BEAR', top: prev.low, bottom: next.high, time: c.time });
                }
            }
            return fvgs.slice(0, 3);
        };

        // --- MASTER ANALYSIS ENGINE ---
        const analyzeMarketData = (candles, volumes) => {
            if (!candles || candles.length < 100) return null;
            const len = candles.length, c = candles[len - 1], body = Math.abs(c.close - c.open);
            
            // Indicators
            const smaData = calculateSMA(candles, 50);
            const lastSMA = smaData.length > 0 ? smaData[smaData.length-1].value : c.close;
            const atr = calculateATR(candles, 14);
            const vwapData = calculateVWAP(candles, volumes);
            const lastVWAP = vwapData.length > 0 ? vwapData[vwapData.length-1].value : c.close;
            const zones = findZones(candles);
            const fvgs = findFVG(candles);
            const prices = candles.map(x => x.close);
            const rsis = calculateRSI(prices);
            const divergence = findDivergence(prices, rsis);

            const vCurrent = volumes[len - 1].value;
            const volAvg = volumes.slice(len - 20).reduce((a, b) => a + b.value, 0) / 20;
            const isHighVol = vCurrent > volAvg * 1.3;

            let pattern = "Normal Candle";
            const isGreen = c.close > c.open;
            
            if (isGreen && c.close > candles[len-2].open && c.open < candles[len-2].close) pattern = "Bullish Engulfing";
            else if (!isGreen && c.close < candles[len-2].open && c.open > candles[len-2].close) pattern = "Bearish Engulfing";
            else if (((Math.min(c.open, c.close) - c.low) > body * 2) && ((c.high - Math.max(c.open, c.close)) < body * 0.6)) pattern = "Hammer";
            else if (((c.high - Math.max(c.open, c.close)) > body * 2) && ((Math.min(c.open, c.close) - c.low) < body * 0.6)) pattern = "Shooting Star";

            // Scoring
            let score = 50; 
            const isUptrend = c.close > lastSMA;
            
            // Generate Descriptions
            let trendDesc = `‡∏£‡∏≤‡∏Ñ‡∏≤ (${c.close.toLocaleString()}) ${isUptrend ? '‡∏¢‡∏∑‡∏ô‡πÄ‡∏´‡∏ô‡∏∑‡∏≠' : '‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ï‡πâ'} ‡πÄ‡∏™‡πâ‡∏ô SMA50`;
            if(divergence) trendDesc += ` ‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡∏¥‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì ${divergence} (‡∏Å‡∏•‡∏±‡∏ö‡∏ï‡∏±‡∏ß)`;

            if (c.close > lastSMA) score += 20; else score -= 20;
            if (c.close > lastVWAP) score += 10; else score -= 10;
            if (divergence === "Bullish Divergence") score += 25;
            if (divergence === "Bearish Divergence") score -= 25;
            
            let instDesc = `‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö VWAP: ${c.close > lastVWAP ? 'Bullish' : 'Bearish'}`;
            const nearSupport = zones.sup.some(z => Math.abs(c.close - z) / c.close < 0.01);
            const nearResistance = zones.res.some(z => Math.abs(c.close - z) / c.close < 0.01);
            
            if (nearSupport) { score += 20; instDesc += " + ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô Demand Zone"; } 
            else if (nearResistance) { score -= 20; instDesc += " + ‡∏ä‡∏ô Supply Zone"; }

            if (pattern.includes("Bullish") || pattern.includes("Hammer")) score += 15;
            else if (pattern.includes("Bearish") || pattern.includes("Shooting")) score -= 15;

            if (isHighVol) { if (isGreen) score += 5; else score -= 5; instDesc += " + High Volume"; }

            score = Math.max(5, Math.min(95, score));
            let bias = score >= 55 ? "BULLISH" : (score <= 45 ? "BEARISH" : "NEUTRAL");
            let action = score >= 65 ? "BUY" : (score <= 35 ? "SELL" : "WAIT");

            const slDist = atr * 2;
            const sl = action === 'BUY' || bias === 'BULLISH' ? c.close - slDist : c.close + slDist;
            const tp1 = action === 'BUY' || bias === 'BULLISH' ? c.close + slDist * 1.5 : c.close - slDist * 1.5;
            const tp2 = action === 'BUY' || bias === 'BULLISH' ? c.close + slDist * 3 : c.close - slDist * 3;

            return {
                candles, volumes, smaData, fvgs, zones, divergence,
                action, entry: c.close, sl, tp1, tp2,
                confidenceScore: score, bias, pattern,
                trendDesc, instDesc, lastVWAP
            };
        };

        const sendLineNotify = async (token, message) => {
            if (!token) return { success: false, error: "No Token" };
            const PROXY_URL = "https://corsproxy.io/?"; 
            const LINE_API = "https://notify-api.line.me/api/notify";
            try {
                const formData = new URLSearchParams(); formData.append('message', message);
                const response = await fetch(PROXY_URL + LINE_API, { method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/x-www-form-urlencoded' }, body: formData });
                return response.ok ? { success: true } : { success: false, error: "API Error" };
            } catch (error) { return { success: false, error: error.message }; }
        };

        // --- 3. UI COMPONENTS ---

        const CopyablePrice = ({ label, value, colorClass }) => {
            const [copied, setCopied] = useState(false);
            const handleCopy = () => {
                const valStr = value.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 5});
                const textArea = document.createElement("textarea"); textArea.value = valStr.replace(/,/g, '');
                document.body.appendChild(textArea); textArea.select(); try { document.execCommand('copy'); setCopied(true); } catch (err) {} document.body.removeChild(textArea);
                setTimeout(() => setCopied(false), 1500);
            };
            return (
                <div onClick={handleCopy} className={`relative cursor-pointer group bg-slate-900/50 p-3 rounded-lg border border-slate-700/50 hover:border-${colorClass.split('-')[1]}-500/50 transition-all hover:bg-slate-800`}>
                    <div className={`text-[10px] uppercase font-bold tracking-wider mb-1 ${colorClass.replace('text-', 'text-opacity-70 text-')}`}>{label}</div>
                    <div className={`font-mono text-xl font-bold ${colorClass} flex items-center gap-2`}>{value.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 5})}</div>
                    {copied && <div className="absolute top-0 right-0 -mt-2 -mr-2 bg-green-500 text-white text-[10px] px-2 py-1 rounded shadow-lg copy-feedback font-bold z-50">COPIED!</div>}
                </div>
            );
        };

        const AnalysisStep = ({ number, title, status, description, isPositive }) => (
            <div className="step-item flex gap-3 p-3 bg-slate-800/30 rounded-lg border border-slate-700/50 hover:bg-slate-800/50 transition-colors">
                <div className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold shrink-0 mt-0.5 ${isPositive ? 'bg-blue-500/20 text-blue-400' : 'bg-slate-700 text-slate-400'}`}>{number}</div>
                <div>
                    <div className="flex items-center gap-2 mb-1">
                        <h4 className="text-xs font-bold text-slate-200">{title}</h4>
                        <span className={`text-[10px] px-1.5 py-0.5 rounded font-bold ${isPositive ? 'bg-emerald-500/10 text-emerald-400' : 'bg-rose-500/10 text-rose-400'}`}>{status}</span>
                    </div>
                    <p className="text-[11px] text-slate-400 leading-relaxed font-light">{description}</p>
                </div>
            </div>
        );

        const SettingsModal = ({ isOpen, onClose, config, updateConfig }) => {
            if(!isOpen) return null;
            const [testStatus, setTestStatus] = useState(null);
            const testLine = async () => {
                setTestStatus('Sending...'); const res = await sendLineNotify(config.lineToken, "\n‚úÖ TradeWise Test: Connected!"); setTestStatus(res.success ? 'Success!' : 'Failed');
            };
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm modal-enter">
                    <div className="glass-panel p-6 rounded-xl w-full max-w-lg border border-slate-700 m-4">
                        <div className="flex justify-between items-center mb-6"><h2 className="text-xl font-bold text-white">‚öôÔ∏è Configuration</h2><button onClick={onClose} className="text-slate-400 hover:text-white">‚úï</button></div>
                        <div className="mb-6">
                            <h3 className="text-sm font-bold text-green-400 mb-2">LINE Notify</h3>
                            <div className="flex gap-2"><input type="text" className="flex-grow bg-slate-900 border border-slate-700 rounded p-2 text-white text-xs" placeholder="Paste Token..." value={config.lineToken} onChange={(e) => updateConfig('tw_line_token', e.target.value)} /><button onClick={testLine} className="px-3 py-1 bg-slate-700 rounded text-xs text-white">Test</button></div>
                            {testStatus && <span className="text-[10px] text-slate-400 mt-1 block">{testStatus}</span>}
                        </div>
                        <div className="mb-6 pt-6 border-t border-slate-700/50">
                            <h3 className="text-sm font-bold text-emerald-400 mb-2">Supabase (Optional)</h3>
                            <input type="text" className="w-full bg-slate-900 border border-slate-700 rounded p-2 text-white text-xs mb-2" placeholder="URL" value={config.sbUrl} onChange={(e) => updateConfig('tw_sb_url', e.target.value)} />
                            <input type="password" className="w-full bg-slate-900 border border-slate-700 rounded p-2 text-white text-xs" placeholder="Anon Key" value={config.sbKey} onChange={(e) => updateConfig('tw_sb_key', e.target.value)} />
                        </div>
                        <div className="flex justify-end"><button onClick={onClose} className="px-6 py-2 rounded bg-blue-600 hover:bg-blue-500 text-white text-sm font-bold">Done</button></div>
                    </div>
                </div>
            );
        };

        const Dashboard = ({ analyses, activeTf, onSelectTf }) => {
            const tfs = ['15m', '1h', '4h', '1d'];
            return (
                <div className="grid grid-cols-4 gap-3 mb-6">
                    {tfs.map(tf => {
                        const data = analyses[tf];
                        const score = data ? data.confidenceScore : 0;
                        const isActive = tf === activeTf;
                        let color = 'text-slate-500', barGradient = 'from-slate-700 to-slate-600';
                        if(score >= 55) { color = 'text-emerald-400'; barGradient = 'from-emerald-500 to-emerald-400'; }
                        else if(score <= 45) { color = 'text-rose-400'; barGradient = 'from-rose-500 to-rose-400'; }
                        else { color = 'text-yellow-400'; barGradient = 'from-yellow-500 to-yellow-400'; }

                        return (
                            <button key={tf} onClick={() => onSelectTf(tf)} className={`glass-panel p-3 rounded-xl flex flex-col items-center border transition-all duration-300 group ${isActive ? 'active-tf border-blue-500/50' : 'border-slate-800 hover:bg-slate-800/50'}`}>
                                <div className="flex justify-between w-full text-[10px] font-bold text-slate-400 mb-2">
                                    <span>{tf}</span> {data && <span className={color}>{score}%</span>}
                                </div>
                                <span className={`text-xs font-bold mb-2 ${color}`}>{data ? data.bias : '...'}</span>
                                <div className="w-full h-1.5 bg-slate-900 rounded-full overflow-hidden shadow-inner">
                                    {data && <div className={`h-full rounded-full bg-gradient-to-r ${barGradient} power-bar-fill ${score > 70 ? 'shadow-[0_0_10px_rgba(16,185,129,0.5)]' : ''}`} style={{width: `${score}%`}}></div>}
                                </div>
                            </button>
                        )
                    })}
                </div>
            );
        };

        const SetupCard = ({ setup }) => {
            if (!setup) return <div className="h-full flex items-center justify-center text-slate-500">Processing...</div>;
            const score = setup.confidenceScore;
            const isBuy = score > 50;
            const accent = isBuy ? 'text-emerald-400' : (score < 50 ? 'text-rose-400' : 'text-yellow-400');
            const borderTop = isBuy ? 'border-t-emerald-500' : (score < 50 ? 'border-t-rose-500' : 'border-t-yellow-500');

            return (
                <div className="h-full flex flex-col gap-4">
                    <div className={`glass-panel p-5 rounded-xl border-t-4 ${borderTop} relative overflow-hidden`}>
                        <div className={`absolute top-0 right-0 w-32 h-32 blur-[60px] rounded-full ${isBuy ? 'bg-emerald-500/10' : 'bg-rose-500/10'} -translate-y-1/2 translate-x-1/2 pointer-events-none`}></div>
                        <div className="relative z-10">
                            <div className="flex justify-between items-start mb-4">
                                <div>
                                    <div className="text-[10px] text-slate-400 font-bold tracking-widest uppercase mb-1">AI SIGNAL</div>
                                    <div className={`text-3xl font-bold ${accent} flex items-center gap-2`}>
                                        {setup.action} <span className="text-sm font-normal text-slate-400 mt-1">({setup.bias})</span>
                                    </div>
                                </div>
                                <div className="relative w-12 h-12 flex items-center justify-center rounded-full border-2 border-slate-700 bg-slate-900">
                                    <span className="text-xs font-bold text-white">{setup.confidenceScore}</span>
                                    <svg className="absolute inset-0 w-full h-full -rotate-90" viewBox="0 0 36 36">
                                        <path className={`${isBuy ? 'text-emerald-500' : 'text-rose-500'} transition-all duration-1000`} strokeDasharray={`${setup.confidenceScore}, 100`} d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" strokeWidth="3" />
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-2 gap-3">
                        <div className="col-span-2"><CopyablePrice label="Entry Price" value={setup.entry} colorClass="text-white" /></div>
                        <CopyablePrice label="Stop Loss" value={setup.sl} colorClass="text-rose-400" />
                        <CopyablePrice label="TP 1" value={setup.tp1} colorClass="text-emerald-400" />
                        <div className="col-span-2 pt-1 px-1 flex justify-between text-slate-500 text-[10px]">
                            <span>Extended TP2</span>
                            <span className="font-mono text-emerald-400 cursor-pointer hover:underline" onClick={() => {
                                const ta = document.createElement("textarea"); ta.value = setup.tp2; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); alert('Copied TP2');
                            }}>{setup.tp2.toLocaleString(undefined, {minimumFractionDigits: 2})}</span>
                        </div>
                    </div>

                    <div className="glass-panel p-4 rounded-xl flex-grow overflow-y-auto custom-scrollbar">
                        <div className="text-xs text-slate-400 font-bold mb-3 flex items-center gap-2">
                            <span className="w-1.5 h-1.5 bg-blue-500 rounded-full animate-pulse"></span> LOGIC BREAKDOWN
                        </div>
                        <div className="space-y-3">
                            <AnalysisStep number="1" title="Structure & Trend" status={score > 50 ? 'BULL' : 'BEAR'} description={setup.trendDesc} isPositive={score > 50} />
                            <AnalysisStep number="2" title="Institutional View" status="INST" description={setup.instDesc} isPositive={true} />
                            <AnalysisStep number="3" title="Price Action" status={setup.pattern} description={`‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÅ‡∏ó‡πà‡∏á‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô: ${setup.pattern}`} isPositive={!setup.pattern.includes("Normal")} />
                        </div>
                        <div className="mt-4 pt-4 border-t border-slate-700/50">
                            <PatternSnapshot data={setup.candles} patternName={setup.pattern} />
                        </div>
                    </div>
                </div>
            );
        };

        const PatternSnapshot = ({ data, patternName }) => {
            const ref = useRef();
            useEffect(() => {
                if(!ref.current || !data || data.length === 0) return;
                const chart = LightweightCharts.createChart(ref.current, {
                    layout: { background: { type: 'solid', color: '#0f172a' }, textColor: '#94a3b8' },
                    grid: { visible: false }, width: ref.current.clientWidth, height: 160,
                    timeScale: { visible: false }, rightPriceScale: { visible: false, scaleMargins: { top: 0.15, bottom: 0.15 } },
                    handleScroll: false, handleScale: false, crosshair: { visible: false } 
                });
                const series = chart.addCandlestickSeries({ upColor: '#10b981', downColor: '#f43f5e', borderVisible: false });
                const zoomedData = data.slice(-8);
                series.setData(zoomedData);
                const last = zoomedData[zoomedData.length-1];
                if(last) {
                    series.createPriceLine({ price: last.high, color: '#facc15', lineWidth: 1, lineStyle: 0, axisLabelVisible: false });
                    series.createPriceLine({ price: last.low, color: '#facc15', lineWidth: 1, lineStyle: 0, axisLabelVisible: false });
                }
                chart.timeScale().fitContent();
                return () => chart.remove();
            }, [data]);
            return <div className="relative mt-2 p-1 bg-slate-800/50 rounded-lg border border-slate-700/50"><div ref={ref} className="mini-chart-box"></div><div className="absolute top-2 left-2 px-3 py-1 bg-slate-900/90 border border-yellow-500/50 rounded text-[10px] text-white backdrop-blur shadow">DETECTED: <span className="text-yellow-400 font-bold">{patternName}</span></div></div>;
        };

        const MainChart = ({ activeAnalysis }) => {
            const chartContainerRef = useRef(null);
            useEffect(() => {
                if(!chartContainerRef.current || !activeAnalysis) return;
                const chart = LightweightCharts.createChart(chartContainerRef.current, {
                    layout: { background: { type: 'solid', color: '#020617' }, textColor: '#94a3b8' },
                    grid: { vertLines: { color: '#1e293b' }, horzLines: { color: '#1e293b' } },
                    width: chartContainerRef.current.clientWidth, height: 500,
                    rightPriceScale: { borderVisible: false, scaleMargins: { top: 0.1, bottom: 0.2 } },
                    timeScale: { borderVisible: false, timeVisible: true, secondsVisible: false },
                });
                const candleSeries = chart.addCandlestickSeries({ upColor: '#10b981', downColor: '#f43f5e', borderVisible: false });
                const volumeSeries = chart.addHistogramSeries({ color: '#26a69a', priceFormat: { type: 'volume' }, priceScaleId: '', scaleMargins: { top: 0.8, bottom: 0 } });
                const vwapSeries = chart.addLineSeries({ color: '#a855f7', lineWidth: 1, lineStyle: 2, title: 'VWAP' });

                candleSeries.setData(activeAnalysis.candles);
                volumeSeries.setData(activeAnalysis.volumes);
                let cumVol = 0, cumVolPrice = 0;
                const vwapLine = activeAnalysis.candles.map((c, i) => {
                    const vol = activeAnalysis.volumes[i].value; cumVol += vol; cumVolPrice += ((c.high + c.low + c.close)/3 * vol);
                    return { time: c.time, value: cumVolPrice / cumVol };
                });
                vwapSeries.setData(vwapLine);

                activeAnalysis.fvgs.forEach(fvg => {
                    const color = fvg.type === 'BULL' ? '#3b82f6' : '#f97316';
                    candleSeries.createPriceLine({ price: fvg.top, color: color, lineWidth: 1, lineStyle: 1, axisLabelVisible: false });
                    candleSeries.createPriceLine({ price: fvg.bottom, color: color, lineWidth: 1, lineStyle: 1, axisLabelVisible: false, title: `FVG` });
                });

                if (activeAnalysis.confidenceScore > 50 || activeAnalysis.confidenceScore < 50) {
                    candleSeries.createPriceLine({ price: activeAnalysis.tp1, color: '#22c55e', lineWidth: 2, title: 'TP1', axisLabelVisible: true });
                    candleSeries.createPriceLine({ price: activeAnalysis.tp2, color: '#22c55e', lineWidth: 1, lineStyle: 2, title: 'TP2', axisLabelVisible: true });
                    candleSeries.createPriceLine({ price: activeAnalysis.sl, color: '#ef4444', lineWidth: 2, title: 'SL', axisLabelVisible: true });
                    candleSeries.createPriceLine({ price: activeAnalysis.entry, color: '#ffffff', lineWidth: 1, lineStyle: 2, title: 'ENTRY', axisLabelVisible: true });
                }
                chart.timeScale().fitContent();
                return () => chart.remove();
            }, [activeAnalysis]);
            return <div className="glass-panel p-1 rounded-2xl relative"><div ref={chartContainerRef} className="chart-box rounded-xl bg-[#020617]"></div></div>;
        };

        const App = () => {
            const { symbols: storedSymbols, addSymbol: addStorageSymbol, removeSymbol, config, updateConfig, isCloud } = useStorage();
            const [symbol, setSymbol] = useState("BTCUSDT");
            const [defaultSymbols] = useState(["BTCUSDT", "ETHUSDT", "SOLUSDT", "PAXGUSDT"]);
            const [activeTf, setActiveTf] = useState("1h");
            const [analyses, setAnalyses] = useState({});
            const [isAnalysing, setIsAnalysing] = useState(true);
            const [isAdding, setIsAdding] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [newSymbolInput, setNewSymbolInput] = useState("");
            const [alertMsg, setAlertMsg] = useState(null);
            const lastNotifyRef = useRef(0);

            const displaySymbols = [...defaultSymbols];
            storedSymbols.forEach(s => { if(!displaySymbols.includes(s.name)) displaySymbols.push(s.name); });

            const resolveSymbol = (input) => {
                const upper = input.toUpperCase().trim();
                const map = { 'EURUSD': 'EURUSDT', 'GBPUSD': 'GBPUSDT', 'XAUUSD': 'PAXGUSDT', 'GOLD': 'PAXGUSDT' };
                return map[upper] || upper;
            };

            const handleAddSymbol = async () => {
                if(!newSymbolInput.trim()) { setIsAdding(false); return; }
                const finalSymbol = resolveSymbol(newSymbolInput);
                setAlertMsg("Checking...");
                try {
                    const res = await fetch(`https://api.binance.com/api/v3/klines?symbol=${finalSymbol}&interval=1h&limit=1`);
                    const data = await res.json();
                    if (data.code || !Array.isArray(data)) {
                        setAlertMsg(`Error: Symbol ${finalSymbol} not found.`); setTimeout(() => setAlertMsg(null), 3000); return;
                    }
                    if(!displaySymbols.includes(finalSymbol)) {
                        await addStorageSymbol(finalSymbol);
                        setSymbol(finalSymbol);
                    } else {
                        setSymbol(finalSymbol);
                    }
                    setNewSymbolInput(""); setIsAdding(false); setAlertMsg(null);
                } catch (e) { setAlertMsg("Network Error"); setTimeout(() => setAlertMsg(null), 3000); }
            };

            const handleRemoveSymbol = (symName) => {
                const target = storedSymbols.find(s => s.name === symName);
                if(target) removeSymbol(target.id);
            };

            useEffect(() => {
                const fetchAllData = async () => {
                    setIsAnalysing(true);
                    const timeframes = ['15m', '1h', '4h', '1d'];
                    const results = {};
                    await Promise.all(timeframes.map(async (tf) => {
                        try {
                            const res = await fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${tf}&limit=100`);
                            const dataRaw = await res.json();
                            const candles = []; const volumes = [];
                            dataRaw.forEach(d => {
                                const time = d[0] / 1000; const open = parseFloat(d[1]); const close = parseFloat(d[4]);
                                candles.push({ time, open, high: parseFloat(d[2]), low: parseFloat(d[3]), close });
                                volumes.push({ time, value: parseFloat(d[5]), color: close >= open ? 'rgba(16, 185, 129, 0.4)' : 'rgba(244, 63, 94, 0.4)' });
                            });
                            results[tf] = analyzeMarketData(candles, volumes);
                        } catch (e) { results[tf] = null; }
                    }));
                    setAnalyses(results);
                    setIsAnalysing(false);

                    const active = results[activeTf];
                    if (active && (active.action === 'BUY' || active.action === 'SELL') && active.confidenceScore >= 70 && config.lineToken) {
                        const now = Date.now();
                        if (now - lastNotifyRef.current > 3600000) {
                            sendLineNotify(config.lineToken, `\nüî• TradeWise: ${symbol} (${activeTf})\nSignal: ${active.action}\nScore: ${active.confidenceScore}%`);
                            lastNotifyRef.current = now;
                        }
                    }
                };
                fetchAllData();
                const interval = setInterval(fetchAllData, 60000);
                return () => clearInterval(interval);
            }, [symbol, activeTf, config.lineToken]);

            return (
                <div className="max-w-7xl mx-auto p-4 md:p-6 min-h-screen flex flex-col">
                    <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <div>
                            <h1 className="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-indigo-400">TradeWise 2.6</h1>
                            <div className="flex items-center gap-2">
                                <p className="text-xs text-slate-500">Supabase Edition</p>
                                {isCloud && <span className="px-1.5 py-0.5 rounded bg-emerald-500/20 text-emerald-400 text-[10px] border border-emerald-500/30">Cloud On</span>}
                            </div>
                        </div>
                        <div className="flex flex-col items-end">
                            <div className="flex flex-wrap items-center gap-2">
                                {displaySymbols.map(s => {
                                    const isDefault = defaultSymbols.includes(s);
                                    return (
                                        <div key={s} className="relative group symbol-item">
                                            <button onClick={() => setSymbol(s)} className={`px-4 py-2 rounded-lg text-sm font-bold transition-all ${symbol === s ? 'bg-blue-600 text-white shadow-lg shadow-blue-500/30' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}>
                                                {s.replace('USDT','')}
                                            </button>
                                            {!isDefault && <button onClick={(e) => { e.stopPropagation(); handleRemoveSymbol(s); }} className="delete-btn absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-4 h-4 flex items-center justify-center text-[10px] shadow-sm hover:bg-red-600">‚úï</button>}
                                        </div>
                                    );
                                })}
                                {isAdding ? (
                                    <div className="flex items-center gap-1 bg-slate-800 p-1 rounded-lg">
                                        <input autoFocus type="text" className="bg-transparent text-white text-sm w-24 px-2 outline-none uppercase" value={newSymbolInput} onChange={(e) => setNewSymbolInput(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleAddSymbol()} />
                                        <button onClick={handleAddSymbol} className="text-emerald-400 px-1">‚úì</button>
                                        <button onClick={() => setIsAdding(false)} className="text-rose-400 px-1">‚úï</button>
                                    </div>
                                ) : <button onClick={() => setIsAdding(true)} className="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-400 border border-dashed border-slate-600">+ ADD</button>}
                                <button onClick={() => setShowSettings(true)} className="p-2 text-slate-400 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg></button>
                            </div>
                            {alertMsg && <span className="text-xs text-rose-400 mt-1">{alertMsg}</span>}
                        </div>
                    </div>
                    
                    <Dashboard analyses={analyses} activeTf={activeTf} onSelectTf={setActiveTf} />

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 flex-grow">
                        <div className="lg:col-span-2 flex flex-col gap-4">
                            {isAnalysing ? <div className="h-[500px] glass-panel rounded-2xl flex items-center justify-center text-slate-400 animate-pulse">Initializing...</div> : (
                                <>
                                    <MainChart activeAnalysis={analyses[activeTf]} />
                                    <div className="flex justify-between px-4 text-xs text-slate-500">
                                        <span><span className="text-purple-400 font-bold">---</span> VWAP</span>
                                        <span><span className="text-blue-500 font-bold">---</span> Bull FVG</span> 
                                        <span><span className="text-orange-500 font-bold">---</span> Bear FVG</span>
                                    </div>
                                </>
                            )}
                        </div>
                        <div className="lg:col-span-1 h-full">
                            <SetupCard setup={analyses[activeTf]} />
                        </div>
                    </div>
                    <SettingsModal isOpen={showSettings} onClose={() => setShowSettings(false)} config={config} updateConfig={updateConfig} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
