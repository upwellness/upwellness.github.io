<!DOCTYPE html>
<html lang="th">
<!-- 
  UP Full Course Designer - Baseline 3.2.1 (Ultimate Precision)
  - Fixed Discount Logic: Excluded All Plant 900, DX Refill, etc.
  - Editable Summary Table (v2.9.9 Style) in Step 4
  - Pack Size: DoubleX Box (62u), Refill (124u)
  - Full Reactive Two-way Sync (Wizard <-> Summary Table)
  - Font: Noto Sans Thai (14-18px Normal)
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UP Wellness Designer - Baseline 3.2.1</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root { --font-primary: 'Noto Sans Thai', sans-serif; }
        body { 
            font-family: var(--font-primary); 
            background-color: #F1F5F9; 
            color: #1E293B; 
            font-size: 15px; 
            -webkit-print-color-adjust: exact; 
        }
        h1, h2, h3, h4 { font-weight: 700; }
        .capture-mode { display: block !important; position: absolute; left: 0; top: 0; width: 1800px !important; height: auto !important; z-index: -100; background-color: white !important; overflow: visible !important; }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .step-bg-orange { background-color: #fffaf5; }
        .step-bg-emerald { background-color: #f0fdf4; }
        .step-bg-indigo { background-color: #f5f7ff; }
        .step-bg-rose { background-color: #fff1f2; }
        .step-bg-slate { background-color: #f8fafc; }

        .card-selected-orange { border-color: #f97316 !important; background-color: #fff7ed !important; }
        .card-selected-emerald { border-color: #10b981 !important; background-color: #ecfdf5 !important; }
        .card-selected-indigo { border-color: #6366f1 !important; background-color: #eef2ff !important; }
        .card-selected-rose { border-color: #f43f5e !important; background-color: #fff1f2 !important; }

        .product-card { transition: all 0.2s ease; border-width: 2px; }
        input:focus { border-color: #6366f1; outline: none; box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;

        const PV_RATE = 3.23;
        
        // --- Updated Product Database with Correct Discount Rules ---
        const PRODUCT_DATA = [
            { id: 'p1', name: 'BodyKey (BK)', price: 1700, cat: 'Calories Restriction', pack: 14, color: 'orange', canDisc: true },
            { id: 'p2', name: 'All Plant 900g', price: 2300, cat: 'Calories Restriction', pack: 53, color: 'orange', canDisc: false },
            { id: 'p3', name: 'All Plant 450g', price: 1209, cat: 'Calories Restriction', pack: 26, color: 'orange', canDisc: true },
            { id: 'p4', name: 'GT/Choc Protein', price: 1500, cat: 'Calories Restriction', pack: 26, color: 'orange', canDisc: true },
            { id: 'p5', name: 'Green Tea Plus', price: 1732, cat: 'Calories Restriction', pack: 60, color: 'orange', canDisc: true },
            { id: 'p6', name: 'DoubleX Box', price: 2364, cat: 'Nutrients', pack: 62, color: 'emerald', canDisc: true },
            { id: 'p7', name: 'DoubleX Refill', price: 4486, cat: 'Nutrients', pack: 124, color: 'emerald', canDisc: false },
            { id: 'p9', name: 'Triple Omega', price: 975, cat: 'Nutrients', pack: 60, color: 'emerald', canDisc: true },
            { id: 'p10', name: 'Vitamin B Plus', price: 527, cat: 'Nutrients', pack: 60, color: 'emerald', canDisc: false },
            { id: 'p11', name: 'BioC Plus', price: 990, cat: 'Nutrients', pack: 60, color: 'emerald', canDisc: true },
            { id: 'p12', name: 'Fiber Blend', price: 1168, cat: 'Hormone Balance', pack: 60, color: 'indigo', canDisc: false },
            { id: 'p14', name: 'Fiber Powder', price: 1627, cat: 'Hormone Balance', pack: 30, color: 'indigo', canDisc: true },
            { id: 'p15', name: 'Probiotics', price: 1650, cat: 'Hormone Balance', pack: 30, color: 'indigo', canDisc: true },
            { id: 'p16', name: 'Garlic', price: 1195, cat: 'NCDs', pack: 150, color: 'rose', canDisc: true },
            { id: 'p17', name: 'CoQ10', price: 2209, cat: 'NCDs', pack: 60, color: 'rose', canDisc: true },
            { id: 'p18', name: 'Ginseng', price: 1300, cat: 'NCDs', pack: 60, color: 'rose', canDisc: false },
            { id: 'p19', name: 'CVF (Immune)', price: 1468, cat: 'NCDs', pack: 60, color: 'rose', canDisc: false },
            { id: 'p20', name: 'Calow', price: 1314, cat: 'NCDs', pack: 90, color: 'rose', canDisc: false },
            { id: 'p22', name: 'Lesterol', price: 1486, cat: 'NCDs', pack: 60, color: 'rose', canDisc: false },
            { id: 'p21', name: 'แก้ว UP Labs', price: 100, cat: 'Etc', pack: 1, color: 'slate', canDisc: false },
        ];

        const MAIN_SPEC_60D = {
            'p1': { q60: 6, dM: '1', dE: '1', rmk: 'ทาน 14 วัน สลับ 14 วัน' },
            'p2': { q60: 1, dM: '1', dE: '1.5', rmk: 'ทาน 14 วัน สลับ 14 วัน' },
            'p4': { q60: 1, dM: '1' },
            'p5': { q60: 3, dM: '1', dE: '1' },
            'p7': { q60: 1, dM: '1', dE: '1' },
            'p9': { q60: 2, dM: '1', dE: '1' },
            'p11': { q60: 2, dM: '1', dE: '1' },
            'p10': { q60: 2, dM: '1', dE: '1' },
            'p12': { q60: 1, dN: '2', rmk: 'ทาน 2 เม็ด + น้ำ 300cc' },
            'p14': { q60: 2, dM: '1' },
            'p15': { q60: 2, dM: '1' },
            'p21': { q60: 1 }
        };

        const CONDITION_ADDONS = [
            { id: 'hyp', name: 'มีความดัน', items: { 'p16': { q60: 1, dM: '1', dN: '1', dE: '1', rmk: 'ดูแลหลอดเลือด' } } },
            { id: 'cho', name: 'ไขมันสูง', items: { 'p22': { q60: 1, dN: '2', rmk: 'ทานพร้อมมื้ออาหาร' } } },
            { id: 'plt', name: 'ลดน้ำหนักไม่ลง', items: { 'p18': { q60: 1, dM: '1', dN: '1', dE: '1', rmk: 'กระตุ้นการเผาผลาญ (โสม)' } } },
            { id: 'hun', name: 'หิวบ่อย/คุมหิว', items: { 'p20': { q60: 1, dM: '1', dN: '1', dE: '1', rmk: 'ก่อนอาหาร 20 นาที' } } },
            { id: 'can', name: 'มะเร็ง/ภูมิคุ้มกัน', items: { 'p19': { q60: 1, dM: '1', dN: '1', dE: '1', rmk: 'ดูแลภูมิต้านทาน' } } }
        ];

        const WIZARD_STEPS = [
            { id: 0, title: "Energy Block", desc: "กลุ่มโปรตีนและมื้อทดแทน", color: "orange", cats: ['Calories Restriction'], bg: "step-bg-orange" },
            { id: 1, title: "Cell Nutrients", desc: "วิตามินและสารอาหารพื้นฐาน", color: "emerald", cats: ['Nutrients'], bg: "step-bg-emerald" },
            { id: 2, title: "Gut Balance", desc: "สมดุลลำไส้และฮอร์โมน", color: "indigo", cats: ['Hormone Balance'], bg: "step-bg-indigo" },
            { id: 3, title: "Targeted Care", desc: "เสริมพิเศษรายโรค/อาการ", color: "rose", cats: ['NCDs'], bg: "step-bg-rose" },
            { id: 4, title: "Final Summary", desc: "สรุปงบประมาณ (Editable View)", color: "slate", cats: ['Etc'], bg: "step-bg-slate" }
        ];

        const Icon = ({ name, size = 18, className = "" }) => {
            const icons = {
                zap: <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" />,
                check: <path d="M20 6L9 17l-5-5" />,
                plus: <path d="M12 5v14M5 12h14" />,
                minus: <path d="M5 12H19" />,
                trash: <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012 2v2" />,
                chevronRight: <path d="M9 18l6-6-6-6" />,
                chevronLeft: <path d="M15 18l-6-6 6-6" />,
                download: <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3" />,
                list: <path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01" />,
                heart: <path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z" />,
                clock: <React.Fragment><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2" /></React.Fragment>
            };
            return (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name]}
                </svg>
            );
        };

        const App = () => {
            const [step, setStep] = useState(0);
            const [duration, setDuration] = useState(60);
            const [name, setName] = useState('');
            const [isStd, setIsStd] = useState(false);
            const [activeConds, setActiveConds] = useState([]);
            const [items, setItems] = useState(PRODUCT_DATA.map(p => ({ 
                ...p, dM: '', dN: '', dE: '', qty: 0, rmk: '', isManual: false, disc: p.canDisc 
            })));
            const [fees, setFees] = useState({ reg: false, estart: false, ajoy: false });
            const [isSaving, setIsSaving] = useState(false);
            const printableRef = useRef(null);

            // --- Calculation Engine ---
            const processedItems = useMemo(() => {
                return items.map(item => {
                    const dSum = (parseFloat(item.dM) || 0) + (parseFloat(item.dN) || 0) + (parseFloat(item.dE) || 0);
                    if (dSum === 0 && !item.rmk && item.id !== 'p21' && item.qty === 0) return { ...item, qty: 0 };
                    if (item.id === 'p21') return item;

                    let suggested = 0;
                    let multiplier = duration;
                    if (isStd && (item.id === 'p1' || item.id === 'p2')) multiplier = (duration/60)*42;

                    if (dSum > 0) suggested = Math.ceil((dSum * multiplier) / item.pack);

                    if (isStd && MAIN_SPEC_60D[item.id]) {
                        const s = MAIN_SPEC_60D[item.id];
                        const sSum = (parseFloat(s.dM)||0) + (parseFloat(s.dN)||0) + (parseFloat(s.dE)||0);
                        if (dSum === sSum) suggested = duration === 60 ? s.q60 : Math.ceil(s.q60 / 2);
                    }

                    CONDITION_ADDONS.filter(c => activeConds.includes(c.id)).forEach(c => {
                        const spec = c.items[item.id];
                        if (spec) suggested += (duration === 60 ? spec.q60 : Math.ceil(spec.q60 / 2));
                    });

                    if (suggested === 0 && (dSum > 0 || item.rmk)) suggested = 1;
                    return { ...item, suggested, qty: item.isManual ? item.qty : suggested };
                });
            }, [items, duration, isStd, activeConds]);

            const summary = useMemo(() => {
                const active = processedItems.filter(i => i.qty > 0);
                const rawTotal = active.reduce((s, i) => s + (i.price * i.qty), 0);
                
                // Detailed item discounts
                const itemDetails = active.map(i => {
                    const limit = (i.id === 'p1') ? 3 : 1;
                    const discountableQty = i.disc ? Math.min(i.qty, limit) : 0;
                    const discountVal = i.price * discountableQty * 0.15;
                    return { ...i, discountVal, lineTotal: (i.price * i.qty) - discountVal };
                });

                const totalItemDisc = itemDetails.reduce((s, i) => s + i.discountVal, 0);
                let net = rawTotal - totalItemDisc + (fees.reg ? 900 : 0) - (fees.estart ? 300 : 0) - (fees.ajoy ? 500 : 0);
                const pv = Math.max(0, net - (fees.reg ? 900 : 0)) / PV_RATE;
                let rate = 0; if (pv >= 150000) rate = 21; else if (pv >= 30000) rate = 12; else if (pv >= 15000) rate = 9; else if (pv >= 5000) rate = 6; else if (pv >= 2500) rate = 3;
                
                return { rawTotal, totalItemDisc, net, pv, rate, cb: pv * (rate/100) * PV_RATE, itemDetails };
            }, [processedItems, fees]);

            // --- Handlers ---
            const updateItem = (id, field, val) => {
                setItems(prev => prev.map(i => {
                    if (i.id === id) {
                        const upd = { ...i, [field]: val };
                        if (field === 'qty') upd.isManual = true;
                        if (['dM', 'dN', 'dE'].includes(field)) upd.isManual = false;
                        return upd;
                    }
                    return i;
                }));
            };

            const toggleStd = () => {
                const next = !isStd; setIsStd(next);
                if (next) {
                    setItems(prev => prev.map(i => {
                        const s = MAIN_SPEC_60D[i.id];
                        return s ? { ...i, dM: s.dM||'', dN: s.dN||'', dE: s.dE||'', rmk: s.rmk||'', isManual: false } : i;
                    }));
                } else {
                    setItems(prev => prev.map(i => ({...i, dM:'', dN:'', dE:'', qty:0, rmk:'', isManual:false})));
                    setActiveConds([]);
                }
            };

            const toggleCond = (cid) => {
                const isRem = activeConds.includes(cid);
                const next = isRem ? activeConds.filter(x => x !== cid) : [...activeConds, cid];
                setActiveConds(next);
                if (!isRem) {
                    const cond = CONDITION_ADDONS.find(c => c.id === cid);
                    setItems(prev => prev.map(i => cond.items[i.id] ? { ...i, ...cond.items[i.id], isManual: false } : i));
                } else {
                    const condRem = CONDITION_ADDONS.find(c => c.id === cid);
                    setItems(prev => prev.map(item => {
                        if (condRem.items[item.id]) {
                            const neededByStd = isStd && MAIN_SPEC_60D[item.id];
                            const neededByOther = CONDITION_ADDONS.some(c => next.includes(c.id) && c.items[item.id]);
                            if (!neededByStd && !neededByOther) return { ...item, dM:'', dN:'', dE:'', rmk:'', qty:0, isManual:false };
                        }
                        return item;
                    }));
                }
            };

            const handleSaveImage = async () => {
                setIsSaving(true);
                const el = printableRef.current;
                el.classList.remove('hidden'); el.classList.add('capture-mode');
                setTimeout(async () => {
                    try {
                        const canvas = await html2canvas(el, { scale: 1, useCORS: true, width: 1800 });
                        const link = document.createElement('a');
                        link.href = canvas.toDataURL('image/png');
                        link.download = `UP-Wellness-V321.png`;
                        link.click();
                    } catch (e) {} finally { el.classList.remove('capture-mode'); el.classList.add('hidden'); setIsSaving(false); }
                }, 100);
            };

            return (
                <div className="min-h-screen flex flex-col font-main bg-[#F1F5F9] pb-20 antialiased">
                    <header className="bg-white border-b border-slate-200 sticky top-0 z-[100] px-4 py-3 shadow-sm font-prompt">
                        <div className="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-3">
                            <div className="flex items-center gap-4">
                                <div className="bg-indigo-600 p-2.5 rounded-2xl text-white shadow-lg"><Icon name="zap" size={22} /></div>
                                <div>
                                    <h1 className="text-xl font-black text-slate-900 leading-none">UP Full Course</h1>
                                    <p className="text-[10px] uppercase tracking-widest text-indigo-500 font-bold mt-0.5 font-prompt uppercase">Baseline V3.2.1</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-3 font-bold">
                                <button onClick={toggleStd} className={`px-4 py-2 rounded-xl text-[12px] font-black transition-all border-2 ${isStd ? 'bg-indigo-600 border-indigo-600 text-white shadow-md' : 'bg-white border-slate-200 text-slate-500 hover:border-indigo-400'}`}>
                                    {isStd ? "✓ คอร์สมาตรฐาน Active" : "+ เลือกคอร์สมาตรฐาน 60D"}
                                </button>
                                <div className="flex bg-slate-200 rounded-xl p-0.5 shadow-inner border border-slate-300 font-prompt">
                                    <button onClick={()=>setDuration(30)} className={`px-4 py-1.5 rounded-lg text-xs font-bold transition-all ${duration === 30 ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500'}`}>30 วัน</button>
                                    <button onClick={()=>setDuration(60)} className={`px-4 py-1.5 rounded-lg text-xs font-bold transition-all ${duration === 60 ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500'}`}>60 วัน</button>
                                </div>
                            </div>
                        </div>
                    </header>

                    <div className="bg-white border-b border-slate-100 py-8 px-4 font-prompt">
                        <div className="max-w-5xl mx-auto flex justify-between relative items-center">
                            <div className="absolute top-5 left-0 w-full h-1 bg-slate-100 rounded-full"></div>
                            <div className="absolute top-5 left-0 h-1 bg-indigo-500 transition-all duration-700 rounded-full" style={{ width: `${(step/4)*100}%` }}></div>
                            {WIZARD_STEPS.map((s, idx) => (
                                <div key={idx} className="relative z-10 flex flex-col items-center gap-2">
                                    <button onClick={()=>setStep(idx)} className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-xs transition-all duration-300 ${step >= idx ? 'bg-indigo-600 text-white shadow-md' : 'bg-white border-2 border-slate-200 text-slate-300'}`}>
                                        {step > idx ? <Icon name="check" size={16} /> : idx + 1}
                                    </button>
                                    <p className={`text-[10px] font-black uppercase tracking-wider text-center w-24 ${step === idx ? 'text-indigo-600' : 'text-slate-400'}`}>{s.title}</p>
                                </div>
                            ))}
                        </div>
                    </div>

                    <main className="max-w-7xl mx-auto w-full p-4 grid grid-cols-1 xl:grid-cols-12 gap-6 flex-1 mt-6">
                        <div className="xl:col-span-3">
                            <div className="bg-white p-6 rounded-[2.5rem] border border-slate-200 shadow-sm sticky top-24 space-y-8 font-prompt">
                                <div>
                                    <h3 className="text-standard font-black text-slate-400 uppercase tracking-widest mb-6 flex items-center gap-2 font-prompt"><Icon name="list" size={14} /> ผลิตภัณฑ์ที่เลือก</h3>
                                    <div className="space-y-2.5 max-h-[45vh] overflow-y-auto custom-scrollbar pr-1">
                                        {processedItems.filter(i => i.qty > 0).length === 0 ? <p className="text-standard text-slate-300 italic py-6 text-center border-2 border-dashed border-slate-50 rounded-xl uppercase font-standard tracking-tighter">จัดคอร์สตามขั้นตอน...</p> : 
                                            processedItems.filter(i => i.qty > 0).map(i => (
                                                <div key={i.id} className="flex justify-between items-center bg-slate-50 p-3.5 rounded-2xl border border-slate-100 animate-in fade-in slide-in-from-right-1 font-prompt font-bold">
                                                    <div>
                                                        <p className="text-[12px] font-black text-slate-800 leading-tight">{i.name}</p>
                                                        <p className="text-[10px] font-bold text-indigo-500 uppercase mt-0.5 tracking-tighter">จำนวน {i.qty} units</p>
                                                    </div>
                                                </div>
                                            ))
                                        }
                                    </div>
                                </div>
                                <div className="pt-6 border-t border-slate-100 font-prompt">
                                    <p className="text-standard font-black text-slate-400 uppercase tracking-widest mb-1 italic font-prompt font-bold">ยอดสุทธิ (NET)</p>
                                    <p className="text-3xl font-black text-slate-900 tracking-tighter font-prompt font-black italic tracking-widest">฿{summary.net.toLocaleString()}</p>
                                </div>
                            </div>
                        </div>

                        <div className="xl:col-span-9 flex flex-col gap-6">
                            <div className={`${WIZARD_STEPS[step].bg} p-10 rounded-[3rem] shadow-sm border border-slate-200 min-h-[550px] flex flex-col transition-colors duration-500 font-prompt font-bold`}>
                                <div className="mb-10 font-prompt">
                                    <h2 className={`text-3xl font-black text-${WIZARD_STEPS[step].color}-600 uppercase tracking-tight`}>{WIZARD_STEPS[step].title}</h2>
                                    <p className="text-slate-400 mt-1 text-standard font-bold tracking-widest uppercase italic font-prompt uppercase italic">{WIZARD_STEPS[step].desc}</p>
                                </div>

                                {step < 4 ? (
                                    <div className="space-y-8 animate-in fade-in duration-500 font-prompt">
                                        {step === 3 && (
                                            <div className="bg-rose-50 p-8 rounded-[2.5rem] border-2 border-rose-100 mb-6 font-bold shadow-sm font-prompt uppercase italic">
                                                <h4 className="text-rose-600 font-black text-standard uppercase mb-6 flex items-center gap-2"><Icon name="heart" size={16} /> เสริมเพิ่มตามสภาวะสุขภาพ</h4>
                                                <div className="flex flex-wrap gap-4">
                                                    {CONDITION_ADDONS.map(c => (
                                                        <button key={c.id} onClick={()=>toggleCond(c.id)} className={`px-6 py-3 rounded-2xl text-standard font-black transition-all border-2 ${activeConds.includes(c.id) ? 'bg-rose-600 border-rose-600 text-white shadow-md scale-105' : 'bg-white border-rose-200 text-rose-400 hover:border-rose-400'}`}>
                                                            {activeConds.includes(c.id) ? "✓ " : "+ "} {c.name}
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 font-prompt">
                                            {PRODUCT_DATA.filter(p => WIZARD_STEPS[step].cats.includes(p.cat)).map(prod => {
                                                const act = processedItems.find(i => i.id === prod.id);
                                                const isSel = act && act.qty > 0;
                                                const hl = isSel ? `card-selected-${prod.color}` : 'bg-white border-slate-100';
                                                return (
                                                    <div key={prod.id} className={`product-card p-8 rounded-[3rem] border-2 transition-all cursor-pointer ${hl}`} onClick={() => !isSel && updateItem(prod.id, 'qty', 1)}>
                                                        <div className="flex justify-between items-start mb-4">
                                                            <div>
                                                                <h4 className="font-black text-slate-800 text-medium leading-none uppercase font-prompt">{prod.name}</h4>
                                                                <p className="text-[11px] text-slate-400 uppercase mt-2 tracking-widest font-bold italic font-prompt">Pack: {prod.pack} Units</p>
                                                            </div>
                                                            <div className="flex items-center gap-2">
                                                                {isSel && (
                                                                    <div className="flex bg-white rounded-xl border border-slate-200 p-1 shadow-sm overflow-hidden" onClick={(e)=>e.stopPropagation()}>
                                                                        <button onClick={() => updateItem(act.id, 'qty', Math.max(0, act.qty-1))} className="w-8 h-8 flex items-center justify-center text-slate-300 hover:text-rose-500 hover:bg-slate-50 transition-colors"><Icon name="minus" size={14}/></button>
                                                                        <span className="w-8 h-8 flex items-center justify-center font-black text-slate-700 text-standard font-prompt italic">{act.qty}</span>
                                                                        <button onClick={() => updateItem(act.id, 'qty', act.qty+1)} className="w-8 h-8 flex items-center justify-center text-slate-300 hover:text-emerald-500 hover:bg-slate-50 transition-colors"><Icon name="plus" size={14}/></button>
                                                                    </div>
                                                                )}
                                                                <div className={`p-3 rounded-2xl transition-all ${isSel ? 'bg-indigo-600 text-white shadow-xl' : 'bg-white text-slate-300 border border-slate-100'}`}><Icon name={isSel ? "check" : "plus"} size={22} /></div>
                                                            </div>
                                                        </div>
                                                        {isSel && (
                                                            <div className="mt-6 space-y-6 pt-6 border-t border-indigo-100 animate-in slide-in-from-top-1 duration-300 font-prompt">
                                                                <div className="space-y-3">
                                                                    <span className="text-standard font-black uppercase text-indigo-500 tracking-wider block font-prompt italic font-prompt italic">โดสการทาน (ช/ก/ย)</span>
                                                                    <div className="flex gap-2 font-prompt">
                                                                        {['dM','dN','dE'].map(f => (
                                                                            <div key={f} className="flex flex-col items-center gap-1">
                                                                                <span className="text-[9px] text-slate-400 uppercase font-black">{f.slice(1)}</span>
                                                                                <input type="text" placeholder="-" className="w-11 h-11 text-center text-medium font-black border-2 border-slate-200 rounded-2xl bg-white focus:border-indigo-500 outline-none transition-all shadow-inner font-main" value={act[f]} onClick={(e)=>e.stopPropagation()} onChange={e => updateItem(act.id, f, e.target.value)} />
                                                                            </div>
                                                                        ))}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                ) : (
                                    <div className="space-y-10 animate-in fade-in duration-500 font-prompt">
                                        {/* --- EDITABLE SUMMARY TABLE (Baseline v2.9.9 Style) --- */}
                                        <div className="bg-white rounded-[2.5rem] border-2 border-slate-200 overflow-hidden shadow-sm font-prompt">
                                            <div className="bg-slate-50 px-8 py-5 border-b border-slate-200 font-black text-slate-400 text-[11px] uppercase tracking-widest font-prompt uppercase tracking-widest italic">Personalized Full Program Table (Editable)</div>
                                            <div className="overflow-x-auto">
                                                <table className="w-full text-left border-collapse">
                                                    <thead className="bg-slate-50/50 border-b border-slate-200">
                                                        <tr className="text-[11px] font-black text-slate-400 uppercase tracking-widest font-prompt uppercase tracking-widest italic">
                                                            <th className="px-8 py-5 w-[30%]">รายการผลิตภัณฑ์</th>
                                                            <th className="px-4 py-5 text-center w-[20%] font-prompt uppercase italic">โดส ช/ก/ย</th>
                                                            <th className="px-4 py-5 text-center w-[12%] font-prompt uppercase italic">จำนวน</th>
                                                            <th className="px-4 py-5 text-right w-[15%] font-prompt uppercase italic">ส่วนลด 15%</th>
                                                            <th className="px-8 py-5 text-right w-[23%] font-prompt uppercase italic">ยอดสุทธิ</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody className="divide-y divide-slate-50 font-prompt">
                                                        {summary.itemDetails.map(i => (
                                                            <tr key={i.id} className="hover:bg-slate-50/40 transition-colors">
                                                                <td className="px-8 py-5">
                                                                    <div className="font-bold text-slate-800 leading-tight">{i.name}</div>
                                                                    <div className="text-[10px] text-slate-400 italic mt-0.5">{i.cat}</div>
                                                                </td>
                                                                <td className="px-4 py-5">
                                                                    <div className="flex justify-center gap-1.5 font-standard italic font-bold">
                                                                        {['dM','dN','dE'].map(f => (
                                                                            <input key={f} type="text" className="w-8 h-8 text-center text-xs font-black border border-slate-200 rounded-lg bg-slate-50 focus:bg-white outline-none" value={i[f]} onChange={(e) => updateItem(i.id, f, e.target.value)} />
                                                                        ))}
                                                                    </div>
                                                                </td>
                                                                <td className="px-4 py-5">
                                                                    <div className="flex items-center justify-center gap-2 font-prompt italic font-bold">
                                                                        <button onClick={() => updateItem(i.id, 'qty', Math.max(0, i.qty-1))} className="text-slate-300 hover:text-rose-500 font-prompt"><Icon name="minus" size={12}/></button>
                                                                        <span className="font-black text-slate-700 w-4 text-center">{i.qty}</span>
                                                                        <button onClick={() => updateItem(i.id, 'qty', i.qty+1)} className="text-slate-300 hover:text-emerald-500 font-prompt"><Icon name="plus" size={12}/></button>
                                                                    </div>
                                                                </td>
                                                                <td className="px-4 py-5 text-right font-bold text-emerald-600 font-prompt uppercase tracking-widest italic">
                                                                    {i.discountVal > 0 ? `-฿${i.discountVal.toLocaleString()}` : '-'}
                                                                </td>
                                                                <td className="px-8 py-5 text-right font-black text-slate-900 font-prompt uppercase tracking-widest italic">฿{i.lineTotal.toLocaleString()}</td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>

                                        <div className="p-12 bg-slate-900 text-white rounded-[4rem] shadow-2xl flex flex-col items-center text-center relative overflow-hidden font-prompt italic">
                                            <p className="text-standard font-black uppercase tracking-[0.5em] text-indigo-400 mb-6 italic font-prompt italic">Total Investment Plan</p>
                                            <p className="text-[100px] font-black italic tracking-tighter leading-none text-white font-prompt italic tracking-widest">฿{summary.net.toLocaleString()}</p>
                                            <div className="mt-14 flex gap-16 font-bold uppercase italic tracking-widest opacity-80 font-prompt italic font-bold">
                                                <div className="text-center font-prompt italic font-bold"><p className="text-[12px] mb-2 opacity-60">PV Accumulation</p><p className="text-4xl font-black">{summary.pv.toLocaleString(undefined, {maximumFractionDigits:0})}</p></div>
                                                <div className="h-16 w-px bg-white/10 font-prompt italic font-bold"></div>
                                                <div className="text-center font-prompt italic font-bold"><p className="text-[12px] mb-2 opacity-60">Cashback ({summary.rate}%)</p><p className="text-4xl font-black">฿{summary.cb.toLocaleString(undefined, {maximumFractionDigits:0})}</p></div>
                                            </div>
                                        </div>

                                        <div className="bg-white p-10 rounded-[3rem] border-2 border-slate-100 font-bold uppercase font-prompt shadow-sm">
                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-5 font-black text-center font-prompt uppercase">
                                                {[ {id:'reg', l:'สมัครสมาชิกใหม่ (฿900)', v:900}, {id:'estart', l:'e-Starter (-฿300)', v:300}, {id:'ajoy', l:'A-Joy (-฿500)', v:500} ].map(f => (
                                                    <div key={f.id} onClick={() => setFees(p => ({...p, [f.id]: !p[f.id]}))} className={`p-8 rounded-[2rem] border-2 cursor-pointer transition-all flex flex-col gap-3 items-center ${fees[f.id] ? 'bg-indigo-600 border-indigo-600 text-white shadow-md scale-105' : 'bg-slate-50 border-slate-100 text-slate-400 font-prompt italic font-black'}`}>
                                                        <span className="text-[13px] uppercase tracking-tight font-black">{f.l}</span>
                                                        <div className={`w-8 h-8 rounded-xl flex items-center justify-center ${fees[f.id] ? 'bg-white text-indigo-600' : 'bg-white text-slate-100'}`}>{fees[f.id] && <Icon name="check" size={18} />}</div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>

                                        <div className="flex flex-col gap-5 font-prompt italic font-black uppercase">
                                            <input type="text" placeholder="ระบุชื่อผู้รับบริการ..." className="w-full bg-white border-2 border-slate-100 rounded-[2.5rem] px-10 py-7 text-large font-black text-slate-900 outline-none focus:border-indigo-400 transition-all text-center italic uppercase shadow-sm" value={name} onChange={e => setName(e.target.value)} />
                                            <button onClick={handleSaveImage} disabled={isSaving} className="w-full py-10 bg-slate-900 text-white rounded-[3.5rem] font-black text-large shadow-xl hover:bg-black transition-all active:scale-95 flex items-center justify-center gap-8 uppercase tracking-widest font-prompt font-black italic tracking-widest">
                                                {isSaving ? "Saving Report..." : <><Icon name="download" size={32} /> บันทึกรูปแผนงาน HD Pro (1800px)</>}
                                            </button>
                                        </div>
                                    </div>
                                )}

                                <div className="mt-auto pt-14 flex justify-between items-center border-t border-slate-100 font-prompt font-black tracking-widest uppercase italic">
                                    <button onClick={()=>setStep(s=>Math.max(0, s-1))} disabled={step === 0} className={`px-10 py-5 rounded-3xl text-standard flex items-center gap-3 transition-all ${step === 0 ? 'opacity-0 pointer-events-none' : 'text-slate-400 hover:text-slate-900 font-prompt uppercase'}`}><Icon name="chevronLeft" size={20} /> Back</button>
                                    <div className="flex gap-4">{[0,1,2,3,4].map(i => <div key={i} className={`h-2.5 rounded-full transition-all duration-700 ${step === i ? 'w-20 bg-indigo-600' : 'w-4 bg-slate-200'}`}></div>)}</div>
                                    <button onClick={()=>setStep(s=>Math.min(4, s+1))} className={`px-20 py-5 bg-indigo-600 text-white rounded-[1.5rem] text-standard shadow-xl shadow-indigo-100 flex items-center gap-3 transition-all hover:bg-indigo-700 active:scale-95 ${step === 4 ? 'hidden' : ''}`}>Checkout <Icon name="chevronRight" size={20} /></button>
                                </div>
                            </div>
                        </div>
                    </main>

                    {/* --- ULTRA-HD PRINTABLE AREA (1800px) --- */}
                    <div ref={printableRef} id="printable-area" className="hidden bg-white text-slate-900 font-prompt italic font-black uppercase" style={{ padding: '120px', width: '1800px', boxSizing: 'border-box', overflow: 'hidden' }}>
                        <div className="flex justify-between items-start border-b-[20px] border-slate-900 pb-16 mb-24 font-prompt font-black uppercase italic">
                            <div className="space-y-10 font-prompt font-black uppercase italic">
                                <h1 className="text-[135px] font-black text-slate-900 tracking-tighter leading-none italic uppercase font-prompt italic font-black uppercase">UP Wellness</h1>
                                <p className="text-[58px] font-black text-indigo-600 uppercase tracking-[0.4em] ml-5 leading-none text-nowrap font-prompt font-black uppercase italic tracking-widest">METABOLIC RESET PROGRAM ({duration} DAYS)</p>
                            </div>
                            <div className="text-right flex flex-col items-end pt-5 uppercase font-bold font-prompt font-black uppercase italic">
                                <div className="bg-slate-900 text-white px-20 py-10 text-[36px] font-black uppercase tracking-[0.3em] rounded-full mb-16 shadow-lg italic tracking-widest font-prompt uppercase italic font-black uppercase">HD Precision Designer V3</div>
                                <div className="space-y-5 font-prompt font-black uppercase italic">
                                    <p className="text-[36px] font-black text-slate-300 uppercase tracking-widest leading-none text-right font-prompt uppercase italic font-black uppercase">Recipient Profile:</p>
                                    <p className="text-[115px] font-black text-slate-900 border-b-[18px] border-slate-100 px-14 py-4 min-w-[850px] leading-tight italic uppercase font-main font-black uppercase italic">{name || '...........................................'}</p>
                                    <p className="text-[38px] font-bold text-slate-400 mt-16 opacity-80 font-prompt uppercase italic">Plan Date: {new Date().toLocaleDateString('th-TH', { year:'numeric', month:'long', day:'numeric'})}</p>
                                </div>
                            </div>
                        </div>

                        <div className="overflow-hidden mb-44 border-[12px] border-slate-200 rounded-[9rem] shadow-2xl bg-white font-bold uppercase font-prompt italic font-black uppercase">
                            <table className="w-full text-left border-collapse table-fixed font-prompt font-black uppercase italic">
                                <thead className="bg-slate-900 text-white font-black uppercase tracking-[0.1em] font-bold italic font-prompt font-black uppercase italic">
                                    <tr>
                                        <th className="px-24 py-28 text-[64px] text-left w-[32%] font-prompt uppercase font-black italic font-prompt font-black uppercase italic">รายการผลิตภัณฑ์</th>
                                        <th className="px-6 py-28 text-[64px] text-center w-[12%] font-prompt uppercase font-black font-prompt font-black uppercase italic">จำนวน</th>
                                        <th className="px-6 py-28 text-[64px] text-center bg-indigo-700 font-prompt uppercase font-black italic font-prompt font-black uppercase italic">เช้า</th>
                                        <th className="px-6 py-28 text-[64px] text-center bg-orange-600 font-prompt uppercase font-black italic font-prompt font-black uppercase italic text-nowrap">กลางวัน</th>
                                        <th className="px-6 py-28 text-[64px] text-center bg-indigo-900 text-nowrap font-prompt uppercase font-black italic font-prompt font-black uppercase italic">เย็น</th>
                                        <th className="px-20 py-28 text-[64px] text-left w-[24%] font-prompt uppercase font-black tracking-widest font-prompt font-black uppercase italic font-bold">หมายเหตุ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {processedItems.filter(i => i.qty > 0).map((i, idx) => (
                                        <tr key={i.id} className={`text-slate-800 ${idx % 2 === 0 ? 'bg-white' : 'bg-slate-50'} font-prompt font-black uppercase italic`}>
                                            <td className="px-24 py-24 border-b-[8px] border-slate-100 uppercase font-prompt italic font-black uppercase italic">
                                                <div className="text-[72px] font-black leading-tight italic font-main uppercase italic font-black font-prompt font-black uppercase italic">{i.name}</div>
                                                <div className="text-[28px] font-bold text-slate-300 uppercase tracking-widest mt-3 font-prompt italic uppercase font-standard font-black uppercase italic font-standard font-black uppercase italic">{i.cat}</div>
                                            </td>
                                            <td className="px-6 py-24 text-center text-slate-400 text-[88px] font-black border-b-[8px] border-slate-100 font-prompt font-black font-prompt font-black uppercase italic tracking-tighter">{i.qty}</td>
                                            <td className="px-6 py-24 text-center text-indigo-700 text-[115px] font-black border-b-[8px] border-slate-100 bg-indigo-50/20 italic font-bold font-prompt font-black uppercase italic font-prompt font-black uppercase italic">{i.dM || '-'}</td>
                                            <td className="px-6 py-24 text-center text-orange-600 text-[115px] font-black border-b-[8px] border-slate-100 bg-orange-50/30 italic font-bold font-prompt font-black uppercase italic font-prompt font-black uppercase italic">{i.dN || '-'}</td>
                                            <td className="px-6 py-24 text-center text-indigo-900 text-[115px] font-black border-b-[8px] border-slate-100 bg-indigo-100/30 italic font-bold font-prompt font-black uppercase italic font-prompt font-black uppercase italic">{i.dE || '-'}</td>
                                            <td className="px-20 py-24 border-b-[8px] border-slate-100 text-[46px] text-slate-500 font-bold italic leading-snug font-main font-black uppercase italic font-main font-black uppercase italic">{i.rmk || '-'}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>

                        <div className="bg-slate-50 p-36 rounded-[11rem] border-[18px] border-slate-100 relative mb-36 shadow-inner mt-auto uppercase font-bold italic font-prompt font-black uppercase italic">
                            <h4 className="text-[80px] font-black text-indigo-700 uppercase tracking-[0.3em] mb-28 flex items-center gap-24 font-prompt font-black italic uppercase font-prompt font-black italic uppercase">
                                <div className="w-12 h-36 bg-indigo-700 rounded-full shadow-md font-bold italic font-prompt font-black uppercase italic font-prompt font-black italic uppercase"></div>
                                METABOLIC GUIDELINES (แนวทางปฏิบัติ)
                            </h4>
                            <div className="grid grid-cols-2 gap-x-36 gap-y-28 font-black uppercase font-prompt italic font-black uppercase font-prompt italic">
                                {[ 
                                    { t: "เน้นกระบวนการ Metabolic Reset", st: "(ลดคาร์โบไฮเดรตและอินซูลินช่วงแรก)" },
                                    { t: "สัดส่วนเวลาทานอาหาร 2-4-6", st: "(เพื่อเพิ่มความยืดหยุ่นของระบบเผาผลาญ)" },
                                    { t: "พักผ่อนให้เพียงพอ 7-8 ชั่วโมง", st: "(เพื่อให้ร่างกายฟื้นฟูระบบอย่างเต็มที่)" },
                                    { t: "เดินสะสมวันละ 10,000 ก้าว", st: "(เพื่อกระตุ้น Metabolic Flexibility)" }
                                ].map((item, idx) => (
                                    <div key={idx} className="flex gap-24 items-start p-24 bg-white rounded-[7rem] shadow-sm border border-slate-100 font-black uppercase font-prompt font-black uppercase font-prompt">
                                        <div className="space-y-10 pt-10 font-bold font-prompt font-black italic uppercase font-main font-black uppercase font-prompt">
                                            <p className="text-[76px] font-black text-slate-800 leading-none italic font-black uppercase font-prompt font-black uppercase font-prompt">{item.t}</p>
                                            <p className="text-[46px] opacity-60 font-medium font-black italic font-black uppercase font-prompt font-black italic uppercase">{item.st}</p>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div className="pt-36 border-t-[10px] border-slate-100 opacity-40 flex justify-between items-center uppercase italic tracking-[0.2em] font-black text-slate-300 font-prompt font-black uppercase italic font-black font-prompt">
                                <p className="text-[64px] font-black text-slate-900 uppercase italic font-black uppercase italic tracking-[0.3em] font-black text-slate-300 font-prompt">UP Labs Wellness</p>
                                <p className="text-[42px] font-bold text-slate-500 tracking-widest leading-none uppercase font-black font-prompt font-black uppercase italic font-black">Professional Baseline V3.2.1</p>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
