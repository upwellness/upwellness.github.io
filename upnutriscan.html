<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UP NutriScan AI</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font: Noto Sans Thai -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans Thai', sans-serif; -webkit-tap-highlight-color: transparent; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
        .animate-slideUp { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
    </style>

    <!-- Import Map for React & Firebase -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.344.0",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
      }
    }
    </script>

    <!-- Babel for JSX (Fixed Version) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <!-- Fixed: Removed 'env' from data-presets to prevent require() transpilation -->
    <script type="text/babel" data-type="module" data-presets="react">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Camera, Trash2, Target, Coffee, Sun, Moon, Zap, Info, 
            UtensilsCrossed, Sparkles, Search, PlusCircle, BookOpen, 
            CheckCircle2, Edit2, Save, Download, X, Settings, Flame, 
            ArrowRight, Image as ImageIcon
        } from 'lucide-react';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import { getFirestore, collection, doc, setDoc, onSnapshot, deleteDoc } from 'firebase/firestore';

        // --- Configuration ---
        // TODO: ใส่ Gemini API Key ของคุณที่นี่
        const apiKey = "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"; 

        // TODO: ใส่ Firebase Config ของคุณที่นี่ (เอามาจาก Firebase Console > Project Settings)
        const firebaseConfig = {
            apiKey: "YOUR_FIREBASE_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Fallback for demo environment if config is missing (You can remove this block in production)
        const activeFirebaseConfig = (typeof __firebase_config !== 'undefined') ? JSON.parse(__firebase_config) : firebaseConfig;
        const appId = (typeof __app_id !== 'undefined') ? __app_id : 'nutri-scan-ai-v4';
        
        // Initialize Firebase
        let app, auth, db;
        try {
            app = initializeApp(activeFirebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase Init Error: Please check your config.", e);
        }

        const MEAL_TYPES = [
            { id: 'breakfast', label: 'มื้อเช้า', icon: <Sun size={20} className="text-orange-500" /> },
            { id: 'lunch', label: 'มื้อเที่ยง', icon: <Zap size={20} className="text-yellow-500" /> },
            { id: 'dinner', label: 'มื้อเย็น', icon: <Moon size={20} className="text-indigo-500" /> },
            { id: 'snack', label: 'มื้อว่าง', icon: <Coffee size={20} className="text-emerald-500" /> },
        ];

        function App() {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('scan');
            const [meals, setMeals] = useState({});
            const [scanResult, setScanResult] = useState(null);
            const [isScanning, setIsScanning] = useState(false);
            const [statusMsg, setStatusMsg] = useState(null);
            const [showPresetModal, setShowPresetModal] = useState(false);
            const [presetConfig, setPresetConfig] = useState({
                bodykey: 1, 
                allPlant: 1, 
                greenTea: 1, 
                targetMeal: 'breakfast'
            });
            const fileInputRef = useRef(null);
            const resultCardRef = useRef(null);

            // --- Auth & Sync ---
            useEffect(() => {
                if (!auth) return;
                const initAuth = async () => {
                    try {
                        await signInAnonymously(auth);
                    } catch (err) { console.error("Auth failed", err); }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, setUser);
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user || !db) return;
                const q = collection(db, 'artifacts', appId, 'users', user.uid, 'daily_meals');
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const mealData = {};
                    snapshot.forEach(doc => { mealData[doc.id] = doc.data(); });
                    setMeals(mealData);
                }, (error) => console.error("Firestore error:", error));
                return () => unsubscribe();
            }, [user]);

            // --- Image Utility ---
            const resizeImage = (file) => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (event) => {
                        const img = new Image();
                        img.src = event.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const MAX_SIZE = 800; 
                            let width = img.width;
                            let height = img.height;

                            if (width > height) {
                                if (width > MAX_SIZE) {
                                    height *= MAX_SIZE / width;
                                    width = MAX_SIZE;
                                }
                            } else {
                                if (height > MAX_SIZE) {
                                    width *= MAX_SIZE / height;
                                    height = MAX_SIZE;
                                }
                            }

                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            resolve(canvas.toDataURL('image/jpeg', 0.7)); 
                        };
                    };
                });
            };

            // --- AI Analysis Logic ---
            const analyzeImage = async (file) => {
                if (!apiKey) {
                    setStatusMsg("กรุณาใส่ API Key ในโค้ดก่อนใช้งาน");
                    return;
                }
                setIsScanning(true);
                setStatusMsg("UP AI กำลังย่อไฟล์และวิเคราะห์...");
                
                try {
                    const base64Image = await resizeImage(file);
                    
                    const systemPrompt = `คุณคือผู้เชี่ยวชาญด้านโภชนาการ วิเคราะห์รูปภาพอาหารอย่างละเอียด แยกแยะส่วนประกอบ (Components) ในจาน
                    ให้ผลลัพธ์เป็น JSON เท่านั้น:
                    {
                        "foodName": "ชื่อเมนูหลัก",
                        "total_calories": number,
                        "total_carbs_g": number,
                        "total_protein_g": number,
                        "total_fat_g": number,
                        "components": [
                        { "name": "ชื่อวัตถุดิบ (เช่น ข้าวสวย, ปลาทูทอด)", "weight_g": ปริมาณเป็นกรัมโดยประมาณ, "carbs_g": number, "protein_g": number, "fat_g": number, "calories": number }
                        ]
                    }`;

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                        contents: [{
                            parts: [
                            { text: "วิเคราะห์ภาพนี้แบบละเอียด แยกส่วนประกอบ" },
                            { inlineData: { mimeType: "image/jpeg", data: base64Image.split(',')[1] } }
                            ]
                        }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        generationConfig: { responseMimeType: "application/json" }
                        })
                    });
                    const result = await response.json();
                    
                    if (!result.candidates) throw new Error("API Error");

                    const data = JSON.parse(result.candidates[0].content.parts[0].text);
                    
                    const componentsWithRatios = (data.components || []).map(c => ({
                        ...c,
                        ratio_c: c.carbs_g / c.weight_g,
                        ratio_p: c.protein_g / c.weight_g,
                        ratio_f: c.fat_g / c.weight_g,
                        ratio_kcal: c.calories / c.weight_g
                    }));

                    const normalizedData = {
                        foodName: data.foodName,
                        carbs_g: data.total_carbs_g,
                        protein_g: data.total_protein_g,
                        fat_g: data.total_fat_g,
                        calories: data.total_calories,
                        components: componentsWithRatios,
                        image: base64Image,
                        timestamp: Date.now()
                    };

                    setScanResult(normalizedData);
                    setStatusMsg(null);
                } catch (error) {
                    setStatusMsg("เกิดข้อผิดพลาดในการวิเคราะห์ โปรดลองใหม่");
                    console.error(error);
                } finally {
                    setIsScanning(false);
                }
            };

            const updateComponentWeight = (index, newWeight) => {
                if (!scanResult) return;
                const updatedComponents = [...scanResult.components];
                const comp = updatedComponents[index];
                const weight = parseFloat(newWeight) || 0;

                comp.weight_g = weight;
                comp.carbs_g = Math.round(weight * comp.ratio_c);
                comp.protein_g = Math.round(weight * comp.ratio_p);
                comp.fat_g = Math.round(weight * comp.ratio_f);
                comp.calories = Math.round(weight * comp.ratio_kcal);

                const totals = updatedComponents.reduce((acc, curr) => ({
                    c: acc.c + curr.carbs_g,
                    p: acc.p + curr.protein_g,
                    f: acc.f + curr.fat_g,
                    kcal: acc.kcal + curr.calories
                }), { c: 0, p: 0, f: 0, kcal: 0 });

                setScanResult({
                    ...scanResult,
                    components: updatedComponents,
                    carbs_g: totals.c,
                    protein_g: totals.p,
                    fat_g: totals.f,
                    calories: totals.kcal
                });
            };

            // --- Presets ---
            const calculatePreset = () => {
                const bk = presetConfig.bodykey * 1; 
                const bk_c = 17 * bk; const bk_p = 17 * bk; const bk_f = 6 * bk; const bk_kcal = 200 * bk;
                const ap = presetConfig.allPlant * 1;
                const ap_c = 0.5 * ap; const ap_p = 13.5 * ap; const ap_f = 0.5 * ap; const ap_kcal = 65 * ap;
                const gt = presetConfig.greenTea * 1;
                const gt_c = 1 * gt; const gt_p = 4 * gt; const gt_f = 0 * gt; const gt_kcal = 25 * gt;

                return {
                    foodName: `UP Set: Bodykey x${bk} + AP x${ap} + GT x${gt}`,
                    carbs_g: Math.round(bk_c + ap_c + gt_c),
                    protein_g: Math.round(bk_p + ap_p + gt_p),
                    fat_g: Math.round(bk_f + ap_f + gt_f),
                    calories: Math.round(bk_kcal + ap_kcal + gt_kcal),
                    isPreset: true,
                    timestamp: Date.now()
                };
            };

            const savePreset = async () => {
                if (!user || !db) return;
                const mealId = presetConfig.targetMeal;
                const data = calculatePreset();
                setStatusMsg(`กำลังบันทึก ${data.foodName}...`);
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'daily_meals', mealId), data);
                    setShowPresetModal(false);
                    setStatusMsg("บันทึกสำเร็จ!");
                    setTimeout(() => setStatusMsg(null), 1500);
                    setActiveTab('diary');
                } catch (e) {
                    setStatusMsg("บันทึกไม่สำเร็จ");
                }
            };

            const saveToDiary = async (mealId) => {
                if (!user || !scanResult || !db) return;
                setStatusMsg(`กำลังบันทึก...`);
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'daily_meals', mealId), scanResult);
                    setStatusMsg(`บันทึกลง ${MEAL_TYPES.find(m => m.id === mealId).label} เรียบร้อย`);
                    setScanResult(null);
                    setActiveTab('diary');
                    setTimeout(() => setStatusMsg(null), 2000);
                } catch (error) {
                    setStatusMsg("เกิดข้อผิดพลาดในการบันทึก");
                }
            };

            const deleteMeal = async (mealId) => {
                if (!user || !db) return;
                await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'daily_meals', mealId));
            };

            // --- Professional Image Generation ---
            const downloadImage = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                img.crossOrigin = "anonymous";
                img.src = scanResult.image;

                img.onload = () => {
                    const width = 1200; 
                    const scale = width / img.width;
                    const imgHeight = img.height * scale;
                    
                    const padding = 60;
                    const headerHeight = 160; 
                    const contentStart = headerHeight + imgHeight + padding;
                    const rowHeight = 80;
                    const componentsCount = scanResult.components.length;
                    const componentsSectionHeight = (componentsCount * rowHeight) + 150; 
                    const totalHeight = contentStart + 400 + componentsSectionHeight + 150;

                    canvas.width = width;
                    canvas.height = totalHeight;

                    // 1. Background
                    const grd = ctx.createLinearGradient(0, 0, 0, totalHeight);
                    grd.addColorStop(0, '#f8fafc'); 
                    grd.addColorStop(1, '#e2e8f0'); 
                    ctx.fillStyle = grd;
                    ctx.fillRect(0, 0, width, totalHeight);

                    // 2. Header
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, width, headerHeight);
                    
                    ctx.fillStyle = '#0d9488';
                    ctx.font = 'bold 50px sans-serif';
                    ctx.fillText("UP NutriScan", padding, 100);
                    
                    ctx.fillStyle = '#94a3b8';
                    ctx.font = '36px sans-serif';
                    ctx.textAlign = 'right';
                    ctx.fillText("AI Food Analysis", width - padding, 100);
                    ctx.textAlign = 'left';
                    
                    // 3. Image
                    ctx.drawImage(img, 0, headerHeight, width, imgHeight);

                    // 4. Food Title
                    let currentY = contentStart;
                    ctx.fillStyle = '#1e293b'; 
                    ctx.font = 'bold 80px sans-serif';
                    ctx.fillText(scanResult.foodName, padding, currentY);
                    
                    // 5. Macro Summary Cards
                    currentY += 100;
                    const cardWidth = (width - (padding * 2) - 60) / 4; 
                    
                    const drawStatCard = (label, val, unit, color, x) => {
                        ctx.fillStyle = 'rgba(0,0,0,0.05)';
                        ctx.fillRect(x+10, currentY+10, cardWidth, 200);

                        ctx.fillStyle = '#ffffff';
                        ctx.fillRect(x, currentY, cardWidth, 200);
                        
                        ctx.fillStyle = color;
                        ctx.fillRect(x, currentY, cardWidth, 12);

                        ctx.fillStyle = '#64748b';
                        ctx.font = 'bold 28px sans-serif';
                        ctx.textAlign = 'center';
                        ctx.fillText(label, x + cardWidth/2, currentY + 60);

                        ctx.fillStyle = '#0f172a';
                        ctx.font = 'bold 64px sans-serif';
                        ctx.fillText(val, x + cardWidth/2, currentY + 130);
                        
                        ctx.font = '24px sans-serif';
                        ctx.fillStyle = '#94a3b8';
                        ctx.fillText(unit, x + cardWidth/2, currentY + 170);
                        
                        ctx.textAlign = 'left';
                    };

                    drawStatCard("CALORIES", scanResult.calories, "kcal", '#0d9488', padding);
                    drawStatCard("PROTEIN", scanResult.protein_g, "g", '#f43f5e', padding + cardWidth + 20); 
                    drawStatCard("CARBS", scanResult.carbs_g, "g", '#f97316', padding + (cardWidth + 20)*2); 
                    drawStatCard("FAT", scanResult.fat_g, "g", '#f59e0b', padding + (cardWidth + 20)*3); 

                    // 6. Components Table
                    currentY += 300;
                    ctx.fillStyle = '#334155';
                    ctx.font = 'bold 44px sans-serif';
                    ctx.fillText("Detailed Breakdown (แจกแจงส่วนประกอบ)", padding, currentY);
                    
                    currentY += 60;
                    ctx.fillStyle = '#cbd5e1';
                    ctx.fillRect(padding, currentY, width - padding*2, 70);
                    ctx.fillStyle = '#475569';
                    ctx.font = 'bold 30px sans-serif';
                    ctx.fillText("ITEM / วัตถุดิบ", padding + 30, currentY + 45);
                    ctx.textAlign = 'right';
                    ctx.fillText("WEIGHT", width - padding - 350, currentY + 45);
                    ctx.fillText("CALORIES", width - padding - 30, currentY + 45);
                    ctx.textAlign = 'left';

                    currentY += 70;
                    
                    scanResult.components.forEach((comp, i) => {
                        ctx.fillStyle = i % 2 === 0 ? '#ffffff' : '#f1f5f9';
                        ctx.fillRect(padding, currentY, width - padding*2, rowHeight);

                        ctx.fillStyle = '#1e293b';
                        ctx.font = '34px sans-serif';
                        ctx.fillText(comp.name, padding + 30, currentY + 50);
                        
                        ctx.textAlign = 'right';
                        ctx.fillStyle = '#64748b';
                        ctx.fillText(`${comp.weight_g} g`, width - padding - 350, currentY + 50);
                        
                        ctx.fillStyle = '#0f172a';
                        ctx.font = 'bold 34px sans-serif';
                        ctx.fillText(`${comp.calories}`, width - padding - 30, currentY + 50);

                        ctx.textAlign = 'left';
                        currentY += rowHeight;
                    });

                    // 7. Footer
                    const footerY = totalHeight - 120;
                    ctx.fillStyle = '#cbd5e1';
                    ctx.fillRect(padding + 100, footerY, width - (padding*2 + 200), 2); 
                    
                    ctx.fillStyle = '#64748b';
                    ctx.font = '32px sans-serif';
                    ctx.textAlign = 'center';
                    const dateStr = new Date().toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute:'2-digit'});
                    ctx.fillText(`Scanned on ${dateStr}`, width/2, footerY + 60);
                    
                    ctx.fillStyle = '#0d9488';
                    ctx.font = 'bold 32px sans-serif';
                    ctx.fillText("Generated by UP NutriScan App", width/2, footerY + 110);

                    const link = document.createElement('a');
                    link.download = `UP-NutriScan-${Date.now()}.jpg`;
                    link.href = canvas.toDataURL('image/jpeg', 0.95);
                    link.click();
                };
            };

            // --- Smart Advice ---
            const getMealAdvice = (mealData) => {
                if (!mealData || mealData.isPreset) return null;

                const totalKcal = mealData.calories;
                if (totalKcal === 0) return null;

                const pPct = (mealData.protein_g * 4 / totalKcal) * 100;
                const cPct = (mealData.carbs_g * 4 / totalKcal) * 100;
                const fPct = (mealData.fat_g * 9 / totalKcal) * 100;

                const suggestions = [];
                const components = mealData.components || [];
                
                if (cPct > 45) {
                    const carbHeavyItem = components.sort((a,b) => b.carbs_g - a.carbs_g)[0];
                    if (carbHeavyItem) suggestions.push(`ลด ${carbHeavyItem.name} ลงครึ่งหนึ่งเพื่อตัดแป้งส่วนเกิน`);
                    else suggestions.push("ลดปริมาณข้าวหรือแป้งในมื้อนี้ลง");
                }
                if (fPct > 35) {
                    const fatHeavyItem = components.sort((a,b) => b.fat_g - a.fat_g)[0];
                    if (fatHeavyItem) suggestions.push(`เลี่ยง ${fatHeavyItem.name} หรือซับน้ำมันออก`);
                    else suggestions.push("เลี่ยงของทอดหรือกะทิ");
                }
                if (pPct < 35) suggestions.push("เพิ่มไข่ขาว 2 ฟอง หรือ ปลาทูอีกครึ่งตัว");

                if (suggestions.length === 0) return { status: 'good', text: "มื้อนี้สัดส่วนดีเยี่ยม! เหมาะสำหรับ Weight Loss แล้ว" };
                return { status: 'warning', text: suggestions.join(", ") };
            };

            const getDailyStats = () => {
                return Object.values(meals).reduce((acc, curr) => {
                acc.c += (curr.carbs_g || 0);
                acc.p += (curr.protein_g || 0);
                acc.f += (curr.fat_g || 0);
                acc.kcal += (curr.calories || 0);
                return acc;
                }, { c: 0, p: 0, f: 0, kcal: 0 });
            };

            const stats = getDailyStats();
            const totalGrams = (stats.c * 4) + (stats.p * 4) + (stats.f * 9);
            const pPct = totalGrams ? Math.round(((stats.p * 4) / totalGrams) * 100) : 0;
            const cPct = totalGrams ? Math.round(((stats.c * 4) / totalGrams) * 100) : 0;
            const fPct = totalGrams ? Math.round(((stats.f * 9) / totalGrams) * 100) : 0;

            const getModeInfo = (p, c, f) => {
                if (stats.kcal === 0) return { label: "UP Start", color: "text-slate-400" };
                if (p >= 35 && c <= 45 && f <= 35) return { label: "Fat Burn Mode", color: "text-rose-500", key: 'WL' };
                if (p >= 30 && c >= 40 && f <= 25) return { label: "Muscle Build Mode", color: "text-indigo-500", key: 'MG' };
                return { label: "Maintenance", color: "text-emerald-500", key: 'MT' };
            };

            const mode = getModeInfo(pPct, cPct, fPct);

            return (
                <div className="min-h-screen bg-slate-50 font-sans text-slate-900 pb-24">
                {/* Header */}
                <header className="bg-white sticky top-0 z-30 px-4 py-4 shadow-sm border-b border-slate-100 flex justify-between items-center">
                    <div className="flex items-center gap-2">
                    <div className="bg-gradient-to-tr from-teal-500 to-emerald-400 p-2 rounded-xl shadow-lg shadow-teal-100">
                        <Sparkles className="text-white" size={20} />
                    </div>
                    <div>
                        <h1 className="text-lg font-black bg-clip-text text-transparent bg-gradient-to-r from-teal-700 to-emerald-600 leading-none">UP NutriScan</h1>
                        <p className="text-[10px] text-slate-400 font-medium">Metabolic Reset Tool</p>
                    </div>
                    </div>
                    {activeTab === 'diary' && (
                        <button 
                        onClick={() => setShowPresetModal(true)}
                        className="text-xs bg-slate-100 text-slate-600 px-3 py-1.5 rounded-lg font-bold flex items-center gap-1 hover:bg-teal-50 hover:text-teal-600 transition-colors"
                    >
                        <Settings size={14} /> Presets
                    </button>
                    )}
                </header>

                <main className="max-w-md mx-auto p-4 space-y-6">
                    
                    {/* --- TAB 1: QUICK SCAN (HOME) --- */}
                    {activeTab === 'scan' && (
                    <div className="space-y-6 animate-fadeIn">
                        {!scanResult ? (
                        <div className="flex flex-col items-center justify-center min-h-[60vh] text-center space-y-6">
                            <div 
                            onClick={() => fileInputRef.current?.click()}
                            className="w-64 h-64 rounded-full bg-gradient-to-br from-teal-50 to-emerald-50 border-4 border-dashed border-teal-200 flex flex-col items-center justify-center cursor-pointer hover:scale-105 transition-transform shadow-inner relative overflow-hidden group"
                            >
                            {isScanning ? (
                                <div className="absolute inset-0 flex items-center justify-center bg-white/80 z-10">
                                <div className="animate-spin rounded-full h-16 w-16 border-b-4 border-teal-600"></div>
                                </div>
                            ) : (
                                <>
                                <div className="bg-white p-6 rounded-full shadow-lg shadow-teal-100 mb-4 group-hover:shadow-xl transition-shadow">
                                    <Camera size={48} className="text-teal-600" />
                                </div>
                                <h3 className="text-lg font-bold text-slate-700">Scan Meal</h3>
                                <p className="text-xs text-slate-400 px-8">ถ่ายภาพ หรือ เลือกรูปจากอัลบั้ม</p>
                                </>
                            )}
                            </div>
                            <input 
                            type="file" 
                            ref={fileInputRef}
                            accept="image/*" 
                            /* capture="environment" removed to allow gallery selection */
                            className="hidden" 
                            onChange={(e) => e.target.files[0] && analyzeImage(e.target.files[0])}
                            />
                        </div>
                        ) : (
                        <div className="space-y-6" ref={resultCardRef}>
                            {/* Result Card */}
                            <div className="bg-white rounded-[2rem] overflow-hidden shadow-xl shadow-slate-200 border border-slate-100">
                            <div className="h-64 relative">
                                <img src={scanResult.image} className="w-full h-full object-cover" alt="Scanned Food" />
                                <div className="absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent flex flex-col justify-end p-6">
                                <h2 className="text-white font-black text-2xl leading-none mb-2">{scanResult.foodName}</h2>
                                <div className="flex items-center gap-4 text-white/90 text-sm font-medium">
                                    <span className="flex items-center gap-1 bg-white/20 px-2 py-1 rounded-lg backdrop-blur-sm"><Zap size={14} className="text-yellow-400" fill="currentColor" /> {scanResult.calories} kcal</span>
                                    <span className="flex items-center gap-1 bg-white/20 px-2 py-1 rounded-lg backdrop-blur-sm"><Flame size={14} className="text-rose-400" fill="currentColor" /> P: {scanResult.protein_g}g</span>
                                </div>
                                </div>
                                <div className="absolute top-4 right-4 flex gap-2">
                                    <button 
                                        onClick={downloadImage}
                                        className="bg-black/30 backdrop-blur-md p-2 rounded-full text-white hover:bg-black/50 transition-colors"
                                        title="Save Image with Details"
                                    >
                                        <Download size={18} />
                                    </button>
                                    <button 
                                    onClick={() => setScanResult(null)}
                                    className="bg-black/30 backdrop-blur-md p-2 rounded-full text-white hover:bg-rose-500 transition-colors"
                                    >
                                    <X size={18} />
                                    </button>
                                </div>
                            </div>

                            {/* Component Editor */}
                            <div className="p-6">
                                <h3 className="text-xs font-black text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                                <Edit2 size={14} /> ปรับปริมาณ (กรัม)
                                </h3>
                                
                                <div className="space-y-3">
                                {scanResult.components.map((comp, idx) => (
                                    <div key={idx} className="flex items-center justify-between p-3 bg-slate-50 rounded-xl border border-slate-100 group focus-within:ring-2 focus-within:ring-teal-100 transition-all">
                                    <div className="flex-1 min-w-0 pr-2">
                                        <p className="font-bold text-slate-700 text-sm truncate">{comp.name}</p>
                                        <div className="flex gap-1 text-[9px] font-bold text-slate-400 uppercase mt-0.5">
                                            <span>P:{comp.protein_g}</span>
                                            <span>C:{comp.carbs_g}</span>
                                            <span>F:{comp.fat_g}</span>
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-2 bg-white px-2 py-1 rounded-lg border border-slate-200">
                                        <input 
                                        type="number" 
                                        value={comp.weight_g}
                                        onChange={(e) => updateComponentWeight(idx, e.target.value)}
                                        className="w-12 text-right font-black text-slate-800 text-sm outline-none bg-transparent"
                                        />
                                        <span className="text-xs text-slate-400 font-bold">g</span>
                                    </div>
                                    </div>
                                ))}
                                </div>

                                <div className="mt-6 pt-6 border-t border-slate-100">
                                <h3 className="text-xs font-black text-slate-400 uppercase tracking-widest mb-3">ยอดรวมสุทธิ</h3>
                                <div className="grid grid-cols-3 gap-2">
                                    <MacroPill label="Carb" val={scanResult.carbs_g} color="bg-orange-100 text-orange-600" />
                                    <MacroPill label="Protein" val={scanResult.protein_g} color="bg-rose-100 text-rose-600" />
                                    <MacroPill label="Fat" val={scanResult.fat_g} color="bg-amber-100 text-amber-600" />
                                </div>
                                </div>
                            </div>
                            </div>

                            {/* Save Actions */}
                            <div className="bg-white p-5 rounded-3xl shadow-lg border border-slate-100">
                            <p className="text-center text-sm font-bold text-slate-500 mb-4 flex items-center justify-center gap-2">
                                <Save size={16} /> บันทึกลงสมุดประจำวัน
                            </p>
                            <div className="grid grid-cols-2 gap-3">
                                {MEAL_TYPES.map(type => (
                                <button
                                    key={type.id}
                                    onClick={() => saveToDiary(type.id)}
                                    className="flex items-center justify-center gap-2 py-3 rounded-xl bg-slate-50 hover:bg-teal-500 hover:text-white hover:shadow-lg hover:shadow-teal-200 text-slate-600 transition-all text-sm border border-transparent font-bold"
                                >
                                    {type.icon} <span className="inherit-color">{type.label}</span>
                                </button>
                                ))}
                            </div>
                            </div>
                        </div>
                        )}
                    </div>
                    )}

                    {/* --- TAB 2: DIARY (DASHBOARD) --- */}
                    {activeTab === 'diary' && (
                    <div className="space-y-6 animate-fadeIn">
                        {/* Daily Summary Card */}
                        <section className="bg-white rounded-[2rem] p-6 shadow-xl shadow-slate-200 border border-slate-100 relative overflow-hidden">
                        <div className="flex justify-between items-start mb-6">
                            <div>
                            <p className="text-slate-400 text-xs font-bold uppercase tracking-wider mb-1">พลังงานรวมวันนี้</p>
                            <h2 className="text-4xl font-black text-slate-800">
                                {stats.kcal} <span className="text-lg font-normal text-slate-300">kcal</span>
                            </h2>
                            </div>
                            <div className={`px-3 py-1.5 rounded-xl text-[10px] font-black uppercase tracking-tighter flex items-center gap-1 border ${mode.color.replace('text', 'border')} ${mode.color.replace('text', 'bg-opacity-10 bg')}`}>
                            <Target size={12} /> {mode.label}
                            </div>
                        </div>

                        <div className="grid grid-cols-3 gap-3 mb-6">
                            <MacroBox label="CARB" val={stats.c} totalG={totalGrams} color="bg-orange-400" />
                            <MacroBox label="PROTEIN" val={stats.p} totalG={totalGrams} color="bg-rose-500" />
                            <MacroBox label="FAT" val={stats.f} totalG={totalGrams} color="bg-amber-400" />
                        </div>

                        {/* Progress Bar */}
                        <div className="h-3 w-full bg-slate-100 rounded-full flex overflow-hidden mb-2">
                            <div style={{ width: `${cPct}%` }} className="bg-orange-400 h-full" />
                            <div style={{ width: `${pPct}%` }} className="bg-rose-500 h-full" />
                            <div style={{ width: `${fPct}%` }} className="bg-amber-400 h-full" />
                        </div>
                        </section>

                        {/* Meal List */}
                        <div className="space-y-4 pb-20">
                        <h3 className="font-black text-slate-400 text-xs uppercase tracking-widest px-2">บันทึกรายวัน</h3>
                        {MEAL_TYPES.map((type) => {
                            const mealData = meals[type.id];
                            const advice = mealData ? getMealAdvice(mealData) : null;
                            
                            return (
                            <div key={type.id} className="space-y-2">
                            <div className={`bg-white p-4 rounded-2xl border ${mealData ? 'border-teal-100' : 'border-slate-100'} flex flex-col`}>
                                <div className="flex items-center justify-between mb-2">
                                    <div className="flex items-center gap-4 overflow-hidden">
                                        <div className={`p-3 rounded-xl shrink-0 ${mealData ? 'bg-teal-50' : 'bg-slate-50'}`}>
                                            {type.icon}
                                        </div>
                                        <div className="min-w-0 flex-1">
                                            <p className="text-xs font-bold text-slate-400 uppercase tracking-tighter">{type.label}</p>
                                            {mealData ? (
                                                <div>
                                                <p className="text-sm font-black text-slate-800 truncate">{mealData.foodName}</p>
                                                <p className="text-[10px] text-slate-400 font-bold mt-0.5">
                                                    {mealData.calories} kcal • P{mealData.protein_g} C{mealData.carbs_g} F{mealData.fat_g}
                                                </p>
                                                </div>
                                            ) : (
                                            <p className="text-sm text-slate-300 italic font-medium">ยังไม่มีข้อมูล</p>
                                            )}
                                        </div>
                                    </div>

                                    {mealData ? (
                                    <button onClick={() => deleteMeal(type.id)} className="p-2 text-slate-300 hover:text-rose-500 transition-colors">
                                        <Trash2 size={18} />
                                    </button>
                                    ) : (
                                        <div className="flex gap-2">
                                            {(type.id === 'breakfast' || type.id === 'dinner') && (
                                                <button 
                                                    onClick={() => {
                                                        setPresetConfig(prev => ({...prev, targetMeal: type.id}));
                                                        setShowPresetModal(true);
                                                    }}
                                                    className="p-2 bg-teal-50 text-teal-600 rounded-lg hover:bg-teal-100"
                                                >
                                                    <Sparkles size={18} />
                                                </button>
                                            )}
                                            <button 
                                            onClick={() => { setActiveTab('scan'); }}
                                            className="p-2 bg-slate-50 rounded-lg text-slate-400 hover:text-teal-600"
                                            >
                                                <PlusCircle size={20} />
                                            </button>
                                        </div>
                                    )}
                                </div>
                                
                                {/* Smart Advice Box */}
                                {advice && advice.status === 'warning' && (
                                    <div className="mt-2 bg-rose-50 border border-rose-100 rounded-xl p-3 flex items-start gap-2">
                                        <Info size={16} className="text-rose-500 shrink-0 mt-0.5" />
                                        <div>
                                            <p className="text-[10px] font-bold text-rose-500 uppercase">Weight Loss Tip:</p>
                                            <p className="text-xs text-rose-700">{advice.text}</p>
                                        </div>
                                    </div>
                                )}
                                {advice && advice.status === 'good' && (
                                    <div className="mt-2 bg-emerald-50 border border-emerald-100 rounded-xl p-2 flex items-center gap-2">
                                        <CheckCircle2 size={14} className="text-emerald-500 shrink-0" />
                                        <p className="text-xs text-emerald-700 font-bold">{advice.text}</p>
                                    </div>
                                )}
                            </div>
                            </div>
                        )})}
                        </div>
                    </div>
                    )}

                </main>

                {/* Preset Modal */}
                {showPresetModal && (
                    <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/50 p-4 backdrop-blur-sm animate-fadeIn">
                        <div className="bg-white w-full max-w-sm rounded-[2rem] p-6 shadow-2xl animate-slideUp">
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="font-black text-lg text-slate-800 flex items-center gap-2">
                                    <Sparkles className="text-teal-500" /> UP Custom Preset
                                </h3>
                                <button onClick={() => setShowPresetModal(false)} className="p-2 bg-slate-100 rounded-full text-slate-400 hover:text-slate-600"><X size={16}/></button>
                            </div>

                            <div className="space-y-6">
                                {/* Bodykey Selector */}
                                <div className="space-y-2">
                                    <label className="text-xs font-bold text-slate-400 uppercase">Bodykey (ซอง)</label>
                                    <div className="flex bg-slate-100 p-1 rounded-xl">
                                        {[0.5, 1, 1.5, 2].map(val => (
                                            <button
                                                key={val}
                                                onClick={() => setPresetConfig({...presetConfig, bodykey: val})}
                                                className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${presetConfig.bodykey === val ? 'bg-white shadow text-teal-600' : 'text-slate-400'}`}
                                            >
                                                {val}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {/* All Plant Selector */}
                                <div className="space-y-2">
                                    <label className="text-xs font-bold text-slate-400 uppercase">All Plant (ช้อน)</label>
                                    <div className="flex items-center justify-between bg-slate-50 p-3 rounded-xl border border-slate-100">
                                        <span className="text-xs text-slate-400">(1 ช้อน = 17g)</span>
                                        <div className="flex items-center gap-4">
                                            <button onClick={() => setPresetConfig(prev => ({...prev, allPlant: Math.max(0, prev.allPlant - 1)}))} className="w-8 h-8 rounded-full bg-white shadow flex items-center justify-center text-slate-600">-</button>
                                            <span className="font-black text-xl w-8 text-center">{presetConfig.allPlant}</span>
                                            <button onClick={() => setPresetConfig(prev => ({...prev, allPlant: prev.allPlant + 1}))} className="w-8 h-8 rounded-full bg-teal-500 shadow flex items-center justify-center text-white">+</button>
                                        </div>
                                    </div>
                                </div>

                                {/* Green Tea Selector */}
                                <div className="space-y-2">
                                    <label className="text-xs font-bold text-slate-400 uppercase">Green Tea Protein (ช้อน)</label>
                                    <div className="flex items-center justify-between bg-slate-50 p-3 rounded-xl border border-slate-100">
                                        <span className="text-xs text-slate-400">(1 ช้อน = P 4g)</span>
                                        <div className="flex items-center gap-4">
                                            <button onClick={() => setPresetConfig(prev => ({...prev, greenTea: Math.max(0, prev.greenTea - 1)}))} className="w-8 h-8 rounded-full bg-white shadow flex items-center justify-center text-slate-600">-</button>
                                            <span className="font-black text-xl w-8 text-center">{presetConfig.greenTea}</span>
                                            <button onClick={() => setPresetConfig(prev => ({...prev, greenTea: prev.greenTea + 1}))} className="w-8 h-8 rounded-full bg-teal-500 shadow flex items-center justify-center text-white">+</button>
                                        </div>
                                    </div>
                                </div>

                                {/* Preview Total */}
                                <div className="bg-slate-800 rounded-xl p-4 text-white">
                                    <div className="flex justify-between items-end">
                                        <div>
                                            <p className="text-xs text-slate-400">Total Estimate</p>
                                            <p className="text-2xl font-black">{calculatePreset().calories} kcal</p>
                                        </div>
                                        <div className="text-right text-xs font-bold text-slate-300">
                                            P: {calculatePreset().protein_g}g
                                        </div>
                                    </div>
                                </div>

                                <button 
                                    onClick={savePreset}
                                    className="w-full py-4 rounded-xl bg-teal-500 text-white font-bold text-lg shadow-lg shadow-teal-200 hover:bg-teal-600 transition-all"
                                >
                                    บันทึก {MEAL_TYPES.find(m => m.id === presetConfig.targetMeal)?.label}
                                </button>
                            </div>
                        </div>
                    </div>
                )}

                {/* Bottom Navigation */}
                <nav className="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-100 pb-safe pt-2 px-6 z-40">
                    <div className="max-w-md mx-auto grid grid-cols-2 gap-8 h-16 items-start">
                    <NavButton 
                        active={activeTab === 'scan'} 
                        onClick={() => setActiveTab('scan')} 
                        icon={<Camera size={24} />} 
                        label="สแกนอาหาร" 
                    />
                    <NavButton 
                        active={activeTab === 'diary'} 
                        onClick={() => setActiveTab('diary')} 
                        icon={<BookOpen size={24} />} 
                        label="สมุดบันทึก" 
                    />
                    </div>
                </nav>

                {/* Status Toast */}
                {statusMsg && (
                    <div className="fixed top-20 left-1/2 -translate-x-1/2 bg-slate-800/90 backdrop-blur text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 animate-bounce z-50 whitespace-nowrap">
                    {statusMsg.includes("กำลัง") ? <div className="animate-spin h-4 w-4 border-2 border-white rounded-full border-t-transparent" /> : <CheckCircle2 size={18} className="text-emerald-400" />}
                    <span className="text-xs font-bold">{statusMsg}</span>
                    </div>
                )}
                </div>
            );
        }

        // --- Sub Components ---

        function NavButton({ active, onClick, icon, label }) {
            return (
                <button 
                onClick={onClick}
                className={`flex flex-col items-center gap-1 transition-all ${active ? 'text-teal-600 -translate-y-1' : 'text-slate-300 hover:text-slate-400'}`}
                >
                <div className={`p-2 rounded-2xl ${active ? 'bg-teal-50 shadow-sm' : ''}`}>
                    {icon}
                </div>
                <span className="text-[10px] font-bold tracking-wide">{label}</span>
                </button>
            );
        }

        function MacroPill({ label, val, color }) {
            return (
                <div className={`flex flex-col items-center justify-center p-2 rounded-xl ${color}`}>
                <span className="text-[10px] font-bold uppercase opacity-70">{label}</span>
                <span className="text-lg font-black leading-none mt-1">{val}g</span>
                </div>
            );
        }

        function MacroBox({ label, val, totalG, color }) {
            const pct = totalG ? Math.round(((val * (label === 'FAT' ? 9 : 4)) / totalG) * 100) : 0;
            return (
                <div className="bg-slate-50 p-3 rounded-2xl border border-slate-100 flex flex-col items-center text-center">
                <span className={`text-[9px] font-black mb-1 px-2 py-0.5 rounded-full text-white ${color}`}>{label}</span>
                <span className="text-xl font-black text-slate-800">{val}<span className="text-[10px] font-normal ml-0.5 text-slate-400">g</span></span>
                <span className="text-[10px] font-bold text-slate-400 mt-1">{pct}%</span>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
