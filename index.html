import React, { useState, useMemo, useRef, useEffect } from 'react';
import { 
  Plus, Trash2, TrendingUp, Calendar, DollarSign, Car, 
  Save, X, MapPin, Clock, BarChart3, ChevronLeft, Navigation,
  LayoutDashboard, PieChart, Upload, Image as ImageIcon, Eye,
  Sparkles, Loader2, MessageSquareQuote, ScanLine, CheckCircle2,
  LogOut, Database, Cloud, Download, FileSpreadsheet
} from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { 
  getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, 
  query, orderBy, Timestamp 
} from 'firebase/firestore';
import { 
  getAuth, signInAnonymously, onAuthStateChanged, 
  signInWithCustomToken, User 
} from 'firebase/auth';

// --- Configuration ---
const apiKey = ""; // System provides this at runtime
const firebaseConfig = JSON.parse(__firebase_config || '{}');
const appId = typeof __app_id !== 'undefined' ? __app_id : 'driver-analytics-pro';

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// --- Data Models ---

interface Trip {
  id: string;
  startTime: string; // HH:mm
  endTime: string;   // HH:mm
  pickup: string;
  dropoff: string;
  distance: number;
  earnings: number;
  zone: string;      // e.g., CBD, Sukhumvit, Thonburi
  screenshot?: string; // Base64 string of the image
}

interface DailyLog {
  id: string;
  date: string;
  startOdometer: number;
  endOdometer: number;
  trips: Trip[];
  dailyBonus: number; 
  notes: string;
  aiAnalysis?: string; // Cache AI analysis result
  updatedAt?: number; // timestamp
}

// --- API Helpers ---

async function callGeminiVision(base64Image: string): Promise<Partial<Trip>> {
  try {
    const base64Data = base64Image.split(',')[1];
    
    const promptText = `
      Analyze this image of a ride-hailing receipt (e.g., Grab, Bolt, LineMan) which may contain Thai text.
      Extract the following data precisely:
      1. earnings: The net earnings or total fare (number only, remove currency symbols).
      2. distance: Trip distance in km (number only).
      3. startTime: Job start time (HH:mm 24-hour format).
      4. endTime: Job finish time (HH:mm 24-hour format). If only one time is shown, use it as endTime and estimate startTime based on distance (approx 2 mins/km).
      5. pickup: Origin location name (in Thai or English).
      6. dropoff: Destination location name (in Thai or English).
      7. zone: Infer the broader zone/area based on the locations (e.g., 'Sukhumvit', 'Sathorn', 'CBD', 'Thonburi', 'Ladprao', 'Airport', 'Rama 9', 'Siam'). Use 'Other' if unsure.

      Return ONLY a raw JSON object with these keys: earnings, distance, startTime, endTime, pickup, dropoff, zone.
      Do not wrap in markdown code blocks.
    `;

    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{
          parts: [
            { text: promptText },
            { inlineData: { mimeType: "image/jpeg", data: base64Data } }
          ]
        }],
        generationConfig: { responseMimeType: "application/json" }
      })
    });

    const data = await response.json();
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
    if (!text) throw new Error("No data returned");
    
    const cleanText = text.replace(/```json/g, '').replace(/```/g, '').trim();
    return JSON.parse(cleanText);
  } catch (error) {
    console.error("Gemini Vision Error:", error);
    throw error;
  }
}

async function callGeminiAnalysis(log: DailyLog): Promise<string> {
  try {
    const tripSummary = log.trips.map(t => 
      `Time: ${t.startTime}-${t.endTime}, Earnings: ${t.earnings}, Zone: ${t.zone}, Dist: ${t.distance}`
    ).join('\n');

    const prompt = `
      Act as a professional driver coach for a ride-hailing driver in Thailand.
      Analyze this daily log:
      Date: ${log.date}
      Total Daily Bonus: ${log.dailyBonus}
      Trips:
      ${tripSummary}

      Please provide a short, encouraging summary in Thai language (3-4 sentences).
      Highlight:
      1. What went well (e.g. high earnings per trip, good zone selection).
      2. One suggestion for improvement or observation (e.g. gap in schedule, potential better zones).
      Use emojis. Keep it friendly.
    `;

    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }]
      })
    });

    const data = await response.json();
    return data.candidates?.[0]?.content?.parts?.[0]?.text || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ";
  } catch (error) {
    console.error("Gemini Analysis Error:", error);
    return "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ AI";
  }
}

// --- Components ---

export default function App() {
  const [user, setUser] = useState<User | null>(null);
  const [logs, setLogs] = useState<DailyLog[]>([]);
  const [view, setView] = useState<'list' | 'analytics' | 'day_detail'>('list');
  const [selectedDateId, setSelectedDateId] = useState<string | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  
  // Export State
  const [isExportModalOpen, setIsExportModalOpen] = useState(false);

  // Auth & Data Subscription
  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();

    const unsubscribeAuth = onAuthStateChanged(auth, (currentUser) => {
      setUser(currentUser);
      if (!currentUser) setIsLoading(false);
    });
    return () => unsubscribeAuth();
  }, []);

  useEffect(() => {
    if (!user) return;
    
    // Firestore Path: artifacts/{appId}/users/{userId}/dailyLogs
    const logsRef = collection(db, 'artifacts', appId, 'users', user.uid, 'dailyLogs');
    
    // Using onSnapshot to keep data synced, but we need to handle form inputs carefully
    const unsubscribe = onSnapshot(logsRef, (snapshot) => {
      const fetchedLogs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() } as DailyLog));
      fetchedLogs.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
      setLogs(fetchedLogs);
      setIsLoading(false);
    }, (error) => {
      console.error("Firestore Error:", error);
      setIsLoading(false);
    });

    return () => unsubscribe();
  }, [user]);

  const currentLog = useMemo(() => logs.find(l => l.id === selectedDateId), [logs, selectedDateId]);

  // --- Database Actions ---

  const handleAddDay = async () => {
    if (!user) return;
    const newId = Date.now().toString();
    const today = new Date().toISOString().split('T')[0];
    
    const newLog: DailyLog = {
      id: newId,
      date: today,
      startOdometer: 0,
      endOdometer: 0,
      dailyBonus: 0,
      notes: '',
      trips: [],
      updatedAt: Date.now()
    };
    
    // Save to Firestore
    try {
      await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'dailyLogs', newId), newLog);
      setSelectedDateId(newId);
      setView('day_detail');
    } catch (err) {
      alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ: " + err);
    }
  };

  const updateLog = async (updatedLog: DailyLog) => {
    if (!user) return;
    try {
      await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'dailyLogs', updatedLog.id), {
        ...updatedLog,
        updatedAt: Date.now()
      }, { merge: true });
    } catch (err) {
      console.error("Save error:", err);
      alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï");
    }
  };

  const deleteLog = async (id: string) => {
    if (!user) return;
    if (confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏ñ‡∏≤‡∏ß‡∏£')) {
      try {
        await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'dailyLogs', id));
        if (selectedDateId === id) setView('list');
      } catch (err) {
        alert("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err);
      }
    }
  };

  // --- Export Logic ---
  const handleExportCSV = (startDate: string, endDate: string) => {
    // Filter logs by date range
    const filteredLogs = logs.filter(log => 
      log.date >= startDate && log.date <= endDate
    );

    if (filteredLogs.length === 0) {
      alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å");
      return;
    }

    // Generate CSV Content
    // Headers suitable for Excel opening
    const headers = [
      "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà", "‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏£‡∏¥‡πà‡∏°", "‡πÑ‡∏°‡∏•‡πå‡∏à‡∏ö", "‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏ß‡∏¥‡πà‡∏á‡∏£‡∏ß‡∏°(‡πÑ‡∏°‡∏•‡πå)", "‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô", 
      "‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô", "‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏ö‡∏á‡∏≤‡∏ô", "‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö", "‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á", "‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á(‡∏Å‡∏°.)", "‡∏Ñ‡πà‡∏≤‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£", "‡πÇ‡∏ã‡∏ô"
    ];

    let csvContent = "\uFEFF"; // BOM for UTF-8 in Excel
    csvContent += headers.join(",") + "\n";

    filteredLogs.forEach(log => {
      const dailyOdometerDist = (log.endOdometer > 0 && log.startOdometer > 0) 
        ? log.endOdometer - log.startOdometer 
        : 0;

      // If no trips, print just the daily summary line
      if (!log.trips || log.trips.length === 0) {
        const row = [
          log.date,
          log.startOdometer,
          log.endOdometer,
          dailyOdometerDist,
          log.dailyBonus,
          "-", "-", "-", "-", "-", "-", "-" // Empty trip data
        ];
        csvContent += row.map(item => `"${item}"`).join(",") + "\n";
      } else {
        // Print each trip with daily info repeated (or you could leave blank for cleaner look)
        log.trips.forEach(trip => {
          const row = [
            log.date,
            log.startOdometer,
            log.endOdometer,
            dailyOdometerDist,
            log.dailyBonus,
            trip.startTime,
            trip.endTime,
            trip.pickup.replace(/"/g, '""'), // Escape quotes
            trip.dropoff.replace(/"/g, '""'),
            trip.distance,
            trip.earnings,
            trip.zone
          ];
          csvContent += row.map(item => `"${item}"`).join(",") + "\n";
        });
      }
    });

    // Trigger Download
    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.setAttribute("href", url);
    link.setAttribute("download", `driver_data_${startDate}_to_${endDate}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    setIsExportModalOpen(false);
  };

  if (isLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-slate-50 text-slate-500 flex-col gap-4">
        <Loader2 className="w-10 h-10 animate-spin text-emerald-600" />
        <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Cloud...</p>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-slate-50 text-slate-800 font-sans pb-20">
      
      {/* Header */}
      <header className="bg-emerald-600 text-white p-4 shadow-lg sticky top-0 z-20">
        <div className="max-w-md mx-auto flex justify-between items-center">
          {view !== 'list' ? (
            <button onClick={() => setView('list')} className="flex items-center gap-1 font-semibold text-white/90 hover:text-white group">
              <ChevronLeft className="w-6 h-6 group-hover:-translate-x-1 transition-transform" />
              <span>‡∏Å‡∏•‡∏±‡∏ö</span>
            </button>
          ) : (
            <h1 className="text-xl font-bold flex items-center gap-2">
              <Car className="w-6 h-6" /> Driver Analytics
            </h1>
          )}
          
          <div className="flex items-center gap-2">
             {view === 'day_detail' && (
                <span className="font-bold text-lg">
                  {currentLog && new Date(currentLog.date).toLocaleDateString('th-TH', { day: 'numeric', month: 'short' })}
                </span>
             )}
             
             {view === 'list' && (
               <>
                 <button 
                   onClick={() => setIsExportModalOpen(true)}
                   className="bg-emerald-700/50 p-2 rounded-full hover:bg-emerald-700 transition backdrop-blur-sm"
                   title="Export CSV"
                 >
                   <Download className="w-5 h-5" />
                 </button>
                 <button 
                   onClick={() => setView('analytics')}
                   className="bg-emerald-700/50 p-2 rounded-full hover:bg-emerald-700 transition backdrop-blur-sm"
                   title="‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥"
                 >
                   <BarChart3 className="w-5 h-5" />
                 </button>
                 <button 
                   onClick={handleAddDay}
                   className="bg-white text-emerald-700 px-3 py-1.5 rounded-full font-bold text-sm shadow hover:bg-emerald-50 flex items-center gap-1 transition-transform active:scale-95"
                 >
                   <Plus className="w-4 h-4" /> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô
                 </button>
               </>
             )}
          </div>
        </div>
      </header>

      <main className="max-w-md mx-auto p-4">
        {view === 'list' && <DailyListView logs={logs} onSelectDay={(id) => { setSelectedDateId(id); setView('day_detail'); }} />}
        {view === 'day_detail' && currentLog && (
          <DayDetailView 
            key={currentLog.id} 
            log={currentLog} 
            onUpdate={updateLog} 
            onDelete={() => deleteLog(currentLog.id)} 
            onClose={() => setView('list')}
          />
        )}
        {view === 'analytics' && <AnalyticsView logs={logs} />}
      </main>

      {/* Export Modal */}
      {isExportModalOpen && (
        <ExportModal 
          onClose={() => setIsExportModalOpen(false)} 
          onExport={handleExportCSV}
          defaultStartDate={logs.length > 0 ? logs[logs.length-1].date : new Date().toISOString().split('T')[0]}
          defaultEndDate={new Date().toISOString().split('T')[0]}
        />
      )}

    </div>
  );
}

// --- Component: Export Modal ---

function ExportModal({ onClose, onExport, defaultStartDate, defaultEndDate }: { onClose: () => void, onExport: (start: string, end: string) => void, defaultStartDate: string, defaultEndDate: string }) {
  const [startDate, setStartDate] = useState(defaultStartDate);
  const [endDate, setEndDate] = useState(defaultEndDate);

  return (
    <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in">
      <div className="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl">
        <div className="flex justify-between items-center mb-6">
          <h3 className="text-xl font-bold text-slate-800 flex items-center gap-2">
            <FileSpreadsheet className="w-6 h-6 text-emerald-600" /> Export Data
          </h3>
          <button onClick={onClose} className="text-slate-400 hover:text-slate-600">
            <X className="w-6 h-6" />
          </button>
        </div>
        
        <div className="space-y-4">
          <div>
            <label className="block text-sm font-bold text-slate-500 mb-1">‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
            <input 
              type="date" 
              value={startDate}
              onChange={(e) => setStartDate(e.target.value)}
              className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none"
            />
          </div>
          <div>
            <label className="block text-sm font-bold text-slate-500 mb-1">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
            <input 
              type="date" 
              value={endDate}
              onChange={(e) => setEndDate(e.target.value)}
              className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none"
            />
          </div>
          
          <button 
            onClick={() => onExport(startDate, endDate)}
            className="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-emerald-200 hover:bg-emerald-700 active:scale-95 transition-all mt-2 flex justify-center items-center gap-2"
          >
            <Download className="w-5 h-5" /> ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV
          </button>
        </div>
      </div>
    </div>
  );
}


// --- View: Daily List ---

function DailyListView({ logs, onSelectDay }: { logs: DailyLog[], onSelectDay: (id: string) => void }) {
  const totalEarnings = logs.reduce((sum, log) => sum + log.dailyBonus + log.trips.reduce((tSum, t) => tSum + t.earnings, 0), 0);
  const totalTrips = logs.reduce((sum, log) => sum + log.trips.length, 0);

  if (logs.length === 0) {
    return (
      <div className="flex flex-col items-center justify-center py-20 text-slate-400 animate-in fade-in">
        <div className="bg-white p-6 rounded-full shadow-sm mb-4">
          <Database className="w-12 h-12 text-emerald-200" />
        </div>
        <h3 className="text-lg font-bold text-slate-600">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
        <p className="text-sm mb-6">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
        <p className="text-xs text-slate-400 flex items-center gap-1">
          <Cloud className="w-3 h-3 text-emerald-500" /> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏ö‡∏ô Cloud
        </p>
      </div>
    );
  }

  return (
    <div className="space-y-5 animate-in fade-in slide-in-from-bottom-4 duration-500">
      <div className="bg-gradient-to-br from-emerald-500 to-teal-700 rounded-2xl p-6 text-white shadow-xl shadow-emerald-200">
        <div className="flex justify-between items-start mb-6">
          <div>
            <p className="text-emerald-100 text-sm font-medium mb-1">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
            <h2 className="text-4xl font-bold tracking-tight">‡∏ø{totalEarnings.toLocaleString()}</h2>
          </div>
          <div className="bg-white/20 p-2 rounded-lg">
             <DollarSign className="w-6 h-6 text-white" />
          </div>
        </div>
        
        <div className="grid grid-cols-2 gap-4 border-t border-white/20 pt-4">
          <div>
            <p className="text-2xl font-bold">{totalTrips}</p>
            <p className="text-xs text-emerald-100">‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏ß‡∏¥‡πà‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
          </div>
          <div>
            <p className="text-2xl font-bold">{logs.length}</p>
            <p className="text-xs text-emerald-100">‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</p>
          </div>
        </div>
      </div>

      <div>
        <h3 className="font-bold text-slate-700 mb-3 flex items-center gap-2">
          <Calendar className="w-4 h-4" /> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
        </h3>
        <div className="space-y-3">
          {logs.map(log => {
             const dayEarnings = log.trips.reduce((s, t) => s + t.earnings, 0) + log.dailyBonus;
             const mileage = log.endOdometer - log.startOdometer;
             
             return (
              <div 
                key={log.id} 
                onClick={() => onSelectDay(log.id)}
                className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 hover:shadow-md hover:border-emerald-200 transition-all cursor-pointer active:scale-[0.98]"
              >
                <div className="flex justify-between items-start">
                  <div>
                    <div className="font-bold text-lg text-slate-800">
                      {new Date(log.date).toLocaleDateString('th-TH', { weekday: 'short', day: 'numeric', month: 'short' })}
                    </div>
                    <div className="text-sm text-slate-500 mt-1 flex flex-wrap gap-2">
                       <span className="bg-slate-100 px-2 py-0.5 rounded-md text-slate-600 text-xs font-medium">{log.trips.length} ‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß</span>
                       {mileage > 0 && <span className="bg-blue-50 text-blue-600 px-2 py-0.5 rounded-md text-xs font-medium">üöó {mileage} ‡∏Å‡∏°.</span>}
                    </div>
                  </div>
                  <div className="text-right">
                    <div className="font-bold text-emerald-600 text-lg">‡∏ø{dayEarnings.toLocaleString()}</div>
                    {log.dailyBonus > 0 && <div className="text-xs text-amber-500 font-medium">+‡πÇ‡∏ö‡∏ô‡∏±‡∏™ {log.dailyBonus}</div>}
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      </div>
    </div>
  );
}

// --- View: Day Detail ---

function DayDetailView({ log, onUpdate, onDelete, onClose }: { log: DailyLog, onUpdate: (l: DailyLog) => void, onDelete: () => void, onClose: () => void }) {
  // Use Local State for form fields to prevent "jumping" cursor due to async Firestore updates
  const [localLog, setLocalLog] = useState<DailyLog>(log);
  const [isSaving, setIsSaving] = useState(false);
  const [isAddingTrip, setIsAddingTrip] = useState(false);
  const [viewingImage, setViewingImage] = useState<string | null>(null);
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  
  // Update local state if the prop changes externally (e.g. from another device), 
  // but be careful not to overwrite user's active typing. 
  // Simple strategy: Only sync trips and AI analysis from props, keep text inputs local until saved.
  useEffect(() => {
    setLocalLog(prev => ({
      ...prev,
      trips: log.trips, // Always sync trips as they are added via modal
      aiAnalysis: log.aiAnalysis // Sync AI results
    }));
  }, [log.trips, log.aiAnalysis]);

  // Trip Form
  const [tripForm, setTripForm] = useState<Omit<Trip, 'id'>>({
    startTime: '', endTime: '', pickup: '', dropoff: '', distance: 0, earnings: 0, zone: '', screenshot: ''
  });
  const [isScanning, setIsScanning] = useState(false);
  const fileInputRef = useRef<HTMLInputElement>(null);

  // --- Handlers ---

  const saveToCloud = async () => {
    setIsSaving(true);
    await onUpdate(localLog);
    // Simulate short delay for visual feedback
    setTimeout(() => setIsSaving(false), 500);
  };

  const handleManualChange = (field: keyof DailyLog, value: any) => {
    setLocalLog(prev => ({ ...prev, [field]: value }));
  };

  const handleBlur = () => {
    // Auto-save when leaving a field
    saveToCloud();
  };

  const handleTripSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    const newTrip: Trip = { ...tripForm, id: Date.now().toString() };
    const sortedTrips = [newTrip, ...localLog.trips].sort((a, b) => b.startTime.localeCompare(a.startTime));
    
    // Update both local and cloud immediately for trips
    const updatedLog = { ...localLog, trips: sortedTrips };
    setLocalLog(updatedLog);
    await onUpdate(updatedLog);
    
    setIsAddingTrip(false);
    setTripForm({ startTime: '', endTime: '', pickup: '', dropoff: '', distance: 0, earnings: 0, zone: '', screenshot: '' });
  };

  const removeTrip = (tripId: string) => {
    if(!confirm("‡∏•‡∏ö‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏ß‡∏¥‡πà‡∏á‡∏ô‡∏µ‡πâ?")) return;
    const updatedTrips = localLog.trips.filter(t => t.id !== tripId);
    const updatedLog = { ...localLog, trips: updatedTrips };
    setLocalLog(updatedLog);
    onUpdate(updatedLog);
  };

  const handleImageUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = async () => {
        const base64 = reader.result as string;
        setTripForm(prev => ({ ...prev, screenshot: base64 }));
        
        setIsScanning(true);
        try {
            const aiData = await callGeminiVision(base64);
            setTripForm(prev => ({
              ...prev,
              ...aiData,
              earnings: aiData.earnings || prev.earnings,
              distance: aiData.distance || prev.distance,
              startTime: aiData.startTime || prev.startTime,
              endTime: aiData.endTime || prev.endTime,
              pickup: aiData.pickup || prev.pickup,
              dropoff: aiData.dropoff || prev.dropoff,
              zone: aiData.zone || prev.zone
            }));
        } catch (err) {
          alert("AI ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°");
        } finally {
          setIsScanning(false);
        }
      };
      reader.readAsDataURL(file);
    }
  };

  const handleAIAnalysis = async () => {
    if (localLog.trips.length === 0) return alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πà‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏´‡πâ AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö");
    setIsAnalyzing(true);
    const analysis = await callGeminiAnalysis(localLog);
    const updatedLog = { ...localLog, aiAnalysis: analysis };
    setLocalLog(updatedLog);
    await onUpdate(updatedLog);
    setIsAnalyzing(false);
  };

  const odometerDistance = (localLog.endOdometer > 0 && localLog.startOdometer > 0) ? localLog.endOdometer - localLog.startOdometer : 0;

  return (
    <div className="space-y-6 animate-in fade-in zoom-in-95 duration-300">
      
      {/* 1. Odometer & Summary Section */}
      <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 relative">
        {/* Status Indicator */}
        <div className={`absolute top-5 right-12 text-[10px] flex items-center gap-1 font-medium px-2 py-1 rounded-full transition-all ${isSaving ? 'bg-amber-100 text-amber-700' : 'bg-emerald-50 text-emerald-600'}`}>
           {isSaving ? (
             <><Loader2 className="w-3 h-3 animate-spin" /> Saving...</>
           ) : (
             <><CheckCircle2 className="w-3 h-3" /> Cloud Sync</>
           )}
        </div>

        <div className="flex justify-between items-center mb-4">
           <h3 className="font-bold text-slate-700 flex items-center gap-2">
             <LayoutDashboard className="w-5 h-5 text-emerald-600" /> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô
           </h3>
           <button onClick={onDelete} className="text-slate-400 hover:text-red-500 transition-colors">
             <Trash2 className="w-5 h-5" />
           </button>
        </div>

        {/* Date Picker */}
        <div className="mb-4">
          <label className="text-xs font-semibold text-slate-500 uppercase block mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
          <input 
              type="date" 
              value={localLog.date}
              onChange={(e) => handleManualChange('date', e.target.value)}
              onBlur={handleBlur}
              className="w-full p-2.5 bg-slate-50 rounded-lg border border-slate-200 focus:ring-2 focus:ring-emerald-500 outline-none font-bold text-slate-700"
            />
        </div>

        <div className="grid grid-cols-2 gap-4 mb-4">
          <div className="space-y-1">
            <label className="text-xs font-semibold text-slate-500 uppercase">‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏£‡∏¥‡πà‡∏°</label>
            <input 
              type="number" 
              value={localLog.startOdometer || ''}
              onChange={(e) => handleManualChange('startOdometer', Number(e.target.value))}
              onBlur={handleBlur}
              placeholder="00000"
              className="w-full p-2.5 bg-slate-50 rounded-lg border border-slate-200 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none text-center font-mono"
            />
          </div>
          <div className="space-y-1">
            <label className="text-xs font-semibold text-slate-500 uppercase">‡πÑ‡∏°‡∏•‡πå‡∏à‡∏ö</label>
            <input 
              type="number" 
              value={localLog.endOdometer || ''}
              onChange={(e) => handleManualChange('endOdometer', Number(e.target.value))}
              onBlur={handleBlur}
              placeholder="00000"
              className="w-full p-2.5 bg-slate-50 rounded-lg border border-slate-200 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none text-center font-mono"
            />
          </div>
        </div>
        
        <div className="space-y-1 mb-4">
           <label className="text-xs font-semibold text-slate-500 uppercase">‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</label>
           <div className="relative">
             <DollarSign className="w-4 h-4 absolute left-3 top-3 text-amber-500" />
             <input 
               type="number" 
               value={localLog.dailyBonus || ''}
               onChange={(e) => handleManualChange('dailyBonus', Number(e.target.value))}
               onBlur={handleBlur}
               placeholder="0"
               className="w-full pl-9 p-2.5 bg-amber-50 text-amber-900 rounded-lg border border-amber-200 focus:ring-2 focus:ring-amber-500 outline-none font-bold"
             />
           </div>
        </div>

        {/* --- Gemini Feature: Daily Coach --- */}
        <div className="mt-6 border-t border-slate-100 pt-4">
          {!localLog.aiAnalysis ? (
            <button 
              onClick={handleAIAnalysis}
              disabled={isAnalyzing || localLog.trips.length === 0}
              className="w-full bg-gradient-to-r from-violet-600 to-indigo-600 text-white p-3 rounded-xl font-bold shadow-md hover:shadow-lg transition-all flex items-center justify-center gap-2 disabled:opacity-50"
            >
              {isAnalyzing ? <Loader2 className="w-5 h-5 animate-spin" /> : <Sparkles className="w-5 h-5 text-yellow-300" />}
              {isAnalyzing ? 'AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...' : '‡πÉ‡∏´‡πâ AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ'}
            </button>
          ) : (
            <div className="bg-indigo-50 border border-indigo-100 rounded-xl p-4 relative animate-in fade-in slide-in-from-top-2">
               <div className="flex items-center gap-2 mb-2">
                 <div className="bg-indigo-100 p-1.5 rounded-lg">
                   <MessageSquareQuote className="w-5 h-5 text-indigo-600" />
                 </div>
                 <span className="font-bold text-indigo-800 text-sm">AI Daily Coach</span>
               </div>
               <p className="text-slate-700 text-sm leading-relaxed whitespace-pre-line">{localLog.aiAnalysis}</p>
               <button 
                 onClick={async () => {
                   const cleared = { ...localLog, aiAnalysis: undefined };
                   setLocalLog(cleared);
                   await onUpdate(cleared);
                 }}
                 className="absolute top-2 right-2 text-indigo-300 hover:text-indigo-500"
               >
                 <X className="w-4 h-4" />
               </button>
            </div>
          )}
        </div>
      </div>

      {/* 2. Trip List Section */}
      <div>
        <div className="flex justify-between items-end mb-4">
          <div>
            <h3 className="font-bold text-slate-800 text-lg">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πà‡∏á ({localLog.trips.length})</h3>
            <p className="text-xs text-slate-500">‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ: ‡∏ø{localLog.trips.reduce((s,t)=>s+t.earnings,0).toLocaleString()}</p>
          </div>
          <button 
            onClick={() => setIsAddingTrip(true)}
            className="bg-emerald-600 text-white px-4 py-2 rounded-full text-sm font-bold shadow-lg shadow-emerald-200 hover:bg-emerald-700 hover:scale-105 transition-all flex items-center gap-1"
          >
            <Plus className="w-4 h-4" /> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß
          </button>
        </div>

        <div className="space-y-3 pb-6">
          {localLog.trips.length === 0 ? (
            <div className="text-center py-10 bg-white rounded-xl border border-dashed border-slate-300">
               <Car className="w-10 h-10 text-slate-300 mx-auto mb-2" />
               <p className="text-slate-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πà‡∏á</p>
            </div>
          ) : (
            localLog.trips.map((trip) => (
              <div key={trip.id} className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 relative group animate-in slide-in-from-bottom-2">
                <button 
                    onClick={() => removeTrip(trip.id)}
                    className="absolute top-3 right-3 text-slate-300 hover:text-red-500 hover:bg-red-50 p-1 rounded-full transition-colors"
                >
                  <X className="w-4 h-4" />
                </button>

                <div className="flex items-center gap-2 mb-3">
                  <div className="bg-slate-100 text-slate-600 px-2 py-1 rounded text-xs font-bold flex items-center gap-1">
                    <Clock className="w-3 h-3" /> {trip.startTime} - {trip.endTime}
                  </div>
                  <div className="ml-auto flex items-center gap-3">
                     {trip.screenshot && (
                        <button 
                          onClick={() => setViewingImage(trip.screenshot!)}
                          className="text-slate-400 hover:text-emerald-600 flex items-center gap-1 text-xs bg-slate-50 px-2 py-1 rounded-full"
                        >
                          <ImageIcon className="w-4 h-4" /> ‡∏î‡∏π‡∏£‡∏π‡∏õ
                        </button>
                     )}
                     <div className="font-bold text-emerald-600 text-lg">
                       ‡∏ø{trip.earnings}
                     </div>
                  </div>
                </div>

                <div className="relative pl-3 border-l-2 border-slate-100 ml-1 space-y-4 my-2">
                   <div className="relative">
                      <div className="absolute -left-[19px] top-1 w-3 h-3 bg-emerald-500 rounded-full ring-4 ring-white"></div>
                      <div className="text-sm font-medium text-slate-800">{trip.pickup}</div>
                   </div>
                   <div className="relative">
                      <div className="absolute -left-[19px] top-1 w-3 h-3 bg-red-500 rounded-full ring-4 ring-white"></div>
                      <div className="text-sm font-medium text-slate-800">{trip.dropoff}</div>
                   </div>
                </div>

                <div className="flex items-center gap-3 mt-3 pt-3 border-t border-slate-50 text-xs text-slate-500">
                  <span className="flex items-center gap-1 bg-slate-50 px-2 py-1 rounded">
                    <Navigation className="w-3 h-3" /> {trip.distance} ‡∏Å‡∏°.
                  </span>
                  <span className="flex items-center gap-1 bg-purple-50 text-purple-700 px-2 py-1 rounded border border-purple-100">
                    <MapPin className="w-3 h-3" /> {trip.zone}
                  </span>
                </div>
              </div>
            ))
          )}
        </div>

        {/* --- Primary Save Button --- */}
        <button 
          onClick={async () => {
            await saveToCloud();
            onClose();
          }}
          className="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-4 rounded-xl font-bold text-lg shadow-lg shadow-emerald-200 active:scale-95 transition-all flex items-center justify-center gap-2 sticky bottom-4 z-10"
        >
          {isSaving ? <Loader2 className="w-6 h-6 animate-spin" /> : <CheckCircle2 className="w-6 h-6" />}
          {isSaving ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î'}
        </button>
      </div>

      {/* Image Viewer Modal */}
      {viewingImage && (
        <div className="fixed inset-0 bg-black/90 z-[60] flex items-center justify-center p-4 backdrop-blur-sm" onClick={() => setViewingImage(null)}>
           <div className="relative max-w-lg w-full">
             <button 
               onClick={() => setViewingImage(null)}
               className="absolute -top-12 right-0 text-white p-2 hover:bg-white/20 rounded-full"
             >
               <X className="w-8 h-8" />
             </button>
             <img src={viewingImage} alt="Trip Evidence" className="w-full rounded-lg shadow-2xl border-2 border-white/20" />
           </div>
        </div>
      )}

      {/* Add Trip Modal */}
      {isAddingTrip && (
        <div className="fixed inset-0 bg-black/60 z-50 flex items-end sm:items-center justify-center backdrop-blur-sm p-0 sm:p-4">
          <div className="bg-white w-full max-w-md rounded-t-2xl sm:rounded-2xl p-6 shadow-2xl animate-in slide-in-from-bottom-10 flex flex-col max-h-[90vh]">
            <div className="flex justify-between items-center mb-6 flex-shrink-0">
              <h3 className="font-bold text-xl text-slate-800 flex items-center gap-2">
                ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏ß‡∏¥‡πà‡∏á‡πÉ‡∏´‡∏°‡πà
                {isScanning && <span className="text-xs bg-indigo-100 text-indigo-600 px-2 py-1 rounded-full animate-pulse flex items-center gap-1"><ScanLine className="w-3 h-3" /> AI Scanning...</span>}
              </h3>
              <button onClick={() => setIsAddingTrip(false)} className="p-2 bg-slate-100 rounded-full hover:bg-slate-200 transition-colors">
                <X className="w-5 h-5" />
              </button>
            </div>
            
            <form onSubmit={handleTripSubmit} className="space-y-5 overflow-y-auto pr-1">
              
              {/* Image Upload Area with Gemini Trigger */}
              <div 
                className={`border-2 border-dashed rounded-xl p-4 text-center cursor-pointer transition-colors relative overflow-hidden group ${tripForm.screenshot ? 'border-emerald-300 bg-emerald-50' : 'border-slate-300 hover:border-emerald-400 hover:bg-slate-50'}`}
                onClick={() => !isScanning && fileInputRef.current?.click()}
              >
                <input 
                  type="file" 
                  ref={fileInputRef} 
                  className="hidden" 
                  accept="image/*"
                  onChange={handleImageUpload}
                  disabled={isScanning}
                />
                
                {isScanning && (
                   <div className="absolute inset-0 bg-white/90 z-20 flex flex-col items-center justify-center text-indigo-600 backdrop-blur-sm">
                      <div className="relative">
                        <div className="absolute inset-0 bg-indigo-200 rounded-full animate-ping opacity-20"></div>
                        <Loader2 className="w-10 h-10 animate-spin mb-2 relative z-10" />
                      </div>
                      <span className="text-sm font-bold animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏™‡∏•‡∏¥‡∏õ‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span>
                   </div>
                )}
                
                {tripForm.screenshot ? (
                  <div className="relative">
                    <img src={tripForm.screenshot} alt="Preview" className="h-32 mx-auto rounded-lg object-contain shadow-md" />
                    <div className="mt-2 text-emerald-600 text-xs font-bold flex items-center justify-center gap-1">
                       <Upload className="w-3 h-3" /> ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û / ‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏´‡∏°‡πà
                    </div>
                  </div>
                ) : (
                  <div className="flex flex-col items-center gap-2 py-4">
                    <div className="bg-gradient-to-br from-emerald-100 to-teal-100 p-4 rounded-full text-emerald-600 relative group-hover:scale-110 transition-transform shadow-sm">
                      <Upload className="w-6 h-6" />
                      <div className="absolute -right-1 -top-1 bg-indigo-500 text-white p-1 rounded-full ring-2 ring-white shadow-sm">
                        <Sparkles className="w-3 h-3" />
                      </div>
                    </div>
                    <div>
                      <p className="text-sm font-bold text-slate-700">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ</p>
                      <p className="text-xs text-slate-400">‚ú® ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
                    </div>
                  </div>
                )}
              </div>

              {/* Time Inputs */}
              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-1">
                   <label className="text-xs font-bold text-slate-500">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤</label>
                   <input 
                      type="time" 
                      required 
                      value={tripForm.startTime} 
                      onChange={e => setTripForm({...tripForm, startTime: e.target.value})} 
                      className="w-full p-2.5 bg-slate-50 rounded-lg border border-slate-200 focus:ring-2 focus:ring-emerald-500 outline-none transition-colors" 
                   />
                </div>
                <div className="space-y-1">
                   <label className="text-xs font-bold text-slate-500">‡∏à‡∏ö‡πÄ‡∏ß‡∏•‡∏≤</label>
                   <input 
                      type="time" 
                      required 
                      value={tripForm.endTime} 
                      onChange={e => setTripForm({...tripForm, endTime: e.target.value})} 
                      className="w-full p-2.5 bg-slate-50 rounded-lg border border-slate-200 focus:ring-2 focus:ring-emerald-500 outline-none transition-colors" 
                   />
                </div>
              </div>

              {/* Locations */}
              <div className="space-y-3">
                <div className="relative group">
                  <div className="absolute left-3 top-3.5"><div className="w-2.5 h-2.5 bg-emerald-500 rounded-full ring-2 ring-emerald-100"></div></div>
                  <input type="text" placeholder="‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö (From)" required value={tripForm.pickup} onChange={e => setTripForm({...tripForm, pickup: e.target.value})} className="w-full p-3 pl-9 bg-slate-50 rounded-lg border border-slate-200 focus:ring-2 focus:ring-emerald-500 outline-none transition-all" />
                </div>
                <div className="relative group">
                  <div className="absolute left-3 top-3.5"><div className="w-2.5 h-2.5 bg-red-500 rounded-full ring-2 ring-red-100"></div></div>
                  <input type="text" placeholder="‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á (To)" required value={tripForm.dropoff} onChange={e => setTripForm({...tripForm, dropoff: e.target.value})} className="w-full p-3 pl-9 bg-slate-50 rounded-lg border border-slate-200 focus:ring-2 focus:ring-emerald-500 outline-none transition-all" />
                </div>
              </div>

              {/* Stats */}
              <div className="grid grid-cols-2 gap-4">
                 <div className="space-y-1">
                    <label className="text-xs font-bold text-slate-500">‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (‡∏Å‡∏°.)</label>
                    <input type="number" step="0.1" placeholder="0.0" required value={tripForm.distance || ''} onChange={e => setTripForm({...tripForm, distance: Number(e.target.value)})} className="w-full p-3 bg-slate-50 rounded-lg border border-slate-200 focus:ring-2 focus:ring-emerald-500 outline-none" />
                 </div>
                 <div className="space-y-1">
                    <label className="text-xs font-bold text-slate-500">‡∏Ñ‡πà‡∏≤‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£ (‡∏ø)</label>
                    <input type="number" placeholder="0" required value={tripForm.earnings || ''} onChange={e => setTripForm({...tripForm, earnings: Number(e.target.value)})} className="w-full p-3 bg-emerald-50 text-emerald-800 font-bold rounded-lg border border-emerald-200 focus:ring-2 focus:ring-emerald-500 outline-none" />
                 </div>
              </div>

              {/* Zone */}
              <div className="space-y-1">
                <label className="text-xs font-bold text-slate-500 flex justify-between">
                  ‡πÇ‡∏ã‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà
                  {tripForm.zone && <span className="text-[10px] text-indigo-500 font-normal bg-indigo-50 px-1 rounded">AI Suggested</span>}
                </label>
                <div className="relative">
                   <MapPin className="w-4 h-4 absolute left-3 top-3.5 text-slate-400" />
                   <input 
                    type="text" 
                    list="zones"
                    placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏≤‡∏ó‡∏£, ‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó..." 
                    required 
                    value={tripForm.zone} 
                    onChange={e => setTripForm({...tripForm, zone: e.target.value})} 
                    className="w-full p-3 pl-9 bg-slate-50 rounded-lg border border-slate-200 focus:ring-2 focus:ring-emerald-500 outline-none" 
                   />
                </div>
                <datalist id="zones">
                  <option value="Sukhumvit" />
                  <option value="Sathorn" />
                  <option value="Silom" />
                  <option value="CBD" />
                  <option value="Thonburi" />
                  <option value="Rama 9" />
                </datalist>
              </div>

              <button type="submit" className="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-3.5 rounded-xl font-bold text-lg shadow-lg shadow-emerald-200 active:scale-95 transition-all mt-2">
                ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏ß‡∏¥‡πà‡∏á
              </button>
            </form>
          </div>
        </div>
      )}
    </div>
  );
}

// --- View: Analytics Dashboard ---

function AnalyticsView({ logs }: { logs: DailyLog[] }) {
  const hourlyData = useMemo(() => {
    const hours = new Array(24).fill(0);
    logs.forEach(log => {
      log.trips.forEach(trip => {
        if (trip.startTime) {
          const hour = parseInt(trip.startTime.split(':')[0]);
          if (!isNaN(hour)) hours[hour]++;
        }
      });
    });
    return hours;
  }, [logs]);

  const zoneData = useMemo(() => {
    const zones: Record<string, number> = {};
    logs.forEach(log => {
      log.trips.forEach(trip => {
        const z = trip.zone || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
        zones[z] = (zones[z] || 0) + 1;
      });
    });
    return Object.entries(zones).sort((a, b) => b[1] - a[1]);
  }, [logs]);

  const maxHourlyJobs = Math.max(...hourlyData, 1);
  const bestHour = hourlyData.indexOf(Math.max(...hourlyData));

  if (logs.length === 0) {
    return (
       <div className="flex flex-col items-center justify-center py-20 text-slate-400">
         <BarChart3 className="w-12 h-12 mb-2 text-slate-300" />
         <p>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö</p>
       </div>
    );
  }

  return (
    <div className="space-y-6 animate-in fade-in slide-in-from-right-4 duration-500">
      
      {/* Chart 1: Hourly Pattern */}
      <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
        <div className="flex items-center gap-3 mb-6">
          <div className="p-2.5 bg-blue-100 rounded-xl text-blue-600 shadow-sm"><Clock className="w-6 h-6" /></div>
          <div>
            <h3 className="font-bold text-slate-800 text-lg">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≠‡∏á (Peak Hours)</h3>
            <p className="text-sm text-slate-500">‡∏Å‡∏£‡∏≤‡∏ü‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</p>
          </div>
        </div>
        
        <div className="h-48 flex items-end gap-1.5 mt-4 relative">
          {hourlyData.map((count, hour) => {
             const heightPercent = (count / maxHourlyJobs) * 100;
             const isPeak = heightPercent > 60;
             return (
               <div key={hour} className="flex-1 flex flex-col items-center group relative h-full justify-end">
                 <div className="absolute bottom-full mb-2 opacity-0 group-hover:opacity-100 bg-slate-800 text-white text-[10px] px-2 py-1 rounded shadow-lg pointer-events-none transition-all z-10 whitespace-nowrap -translate-y-1">
                   {hour}:00 ‡∏ô. | {count} ‡∏á‡∏≤‡∏ô
                 </div>
                 <div 
                   className={`w-full min-w-[6px] rounded-t-md transition-all duration-700 ease-out ${isPeak ? 'bg-blue-500 shadow-[0_0_10px_rgba(59,130,246,0.5)]' : 'bg-slate-200 hover:bg-slate-300'}`}
                   style={{ height: `${Math.max(heightPercent, 4)}%` }}
                 ></div>
                 {(hour % 3 === 0) && (
                   <span className="absolute -bottom-5 text-[10px] text-slate-400 font-medium">{hour}</span>
                 )}
               </div>
             )
          })}
        </div>
        <div className="mt-6 pt-4 border-t border-slate-100 flex justify-between text-xs text-slate-500">
             <span>00:00</span>
             <span>12:00</span>
             <span>23:00</span>
        </div>
      </div>

      {/* Chart 2: Top Zones */}
      <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
         <div className="flex items-center gap-3 mb-6">
          <div className="p-2.5 bg-purple-100 rounded-xl text-purple-600 shadow-sm"><MapPin className="w-6 h-6" /></div>
          <div>
            <h3 className="font-bold text-slate-800 text-lg">‡πÇ‡∏ã‡∏ô‡∏ó‡∏≥‡πÄ‡∏á‡∏¥‡∏ô (Top Zones)</h3>
            <p className="text-sm text-slate-500">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ö‡πà‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</p>
          </div>
        </div>

        <div className="space-y-4">
          {zoneData.length === 0 ? (
            <div className="text-center text-slate-400 py-6 text-sm bg-slate-50 rounded-lg">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏ã‡∏ô</div>
          ) : (
            zoneData.slice(0, 5).map(([zone, count], index) => (
              <div key={zone} className="flex items-center gap-4">
                 <div className="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center font-bold text-slate-500 text-xs shadow-inner">
                   {index + 1}
                 </div>
                 <div className="flex-1">
                   <div className="flex justify-between text-sm mb-1.5">
                     <span className="font-bold text-slate-700">{zone}</span>
                     <span className="text-slate-500 font-medium">{count} ‡∏á‡∏≤‡∏ô</span>
                   </div>
                   <div className="w-full bg-slate-100 rounded-full h-2.5 overflow-hidden">
                     <div 
                        className="bg-gradient-to-r from-purple-500 to-purple-400 h-full rounded-full shadow-sm" 
                        style={{ width: `${(count / zoneData[0][1]) * 100}%` }}
                     ></div>
                   </div>
                 </div>
              </div>
            ))
          )}
        </div>
      </div>

      {/* Insight Summary */}
      <div className="grid grid-cols-2 gap-4">
         <div className="bg-gradient-to-br from-amber-50 to-orange-50 p-5 rounded-2xl border border-orange-100 shadow-sm">
           <h4 className="text-orange-800/70 text-xs font-bold uppercase mb-2">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</h4>
           <div className="flex items-center gap-2">
             <Clock className="w-5 h-5 text-orange-500" />
             <p className="text-xl font-bold text-slate-800">
               {bestHour}:00 - {bestHour + 1}:00
             </p>
           </div>
         </div>
         <div className="bg-gradient-to-br from-emerald-50 to-green-50 p-5 rounded-2xl border border-emerald-100 shadow-sm">
           <h4 className="text-emerald-800/70 text-xs font-bold uppercase mb-2">‡πÇ‡∏ã‡∏ô‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 1</h4>
           <div className="flex items-center gap-2">
             <MapPin className="w-5 h-5 text-emerald-500" />
             <p className="text-xl font-bold text-slate-800 truncate">
               {zoneData.length > 0 ? zoneData[0][0] : '-'}
             </p>
           </div>
         </div>
      </div>
    </div>
  );
}
