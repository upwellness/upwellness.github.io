<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metabolic Health Check - UP Labs</title>
    
    <!-- 1. React & ReactDOM (Specific Version 18.2.0) -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- 2. Prop-types (Required by some UMD builds) -->
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>

    <!-- 3. Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 4. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 5. Lucide React Icons (Latest Stable Version) -->
    <script src="https://unpkg.com/lucide-react@0.469.0/dist/umd/lucide-react.min.js"></script>
    
    <!-- 6. Supabase SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="root"></div>

    <!-- Error Handling Script -->
    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            console.error("Global Error:", message, error);
            // alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + message); // Uncomment to see alert on device
        };
    </script>

    <script type="text/babel">
        // 1. ‡∏î‡∏∂‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏à‡∏≤‡∏Å Global Object
        const { useState, useEffect } = React;
        
        // 2. ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ (Fail-safe Icons)
        const FallbackIcon = (props) => <span style={{display:'inline-block', width:'1em', height:'1em', background:'#ccc', borderRadius:'4px'}} {...props}></span>;
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á window.lucideReact ‡πÅ‡∏•‡∏∞ window.lucide ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå
        const LucideIcons = window.lucideReact || window.lucide || {};
        
        // Helper function to safely get icon or fallback
        const getIcon = (name) => LucideIcons[name] || FallbackIcon;

        // Map icons manually to ensure they are never undefined
        const ChevronRight = getIcon('ChevronRight');
        const ChevronLeft = getIcon('ChevronLeft');
        const Activity = getIcon('Activity');
        const Scale = getIcon('Scale');
        const Ruler = getIcon('Ruler');
        const User = getIcon('User');
        const CheckCircle = getIcon('CheckCircle');
        const AlertCircle = getIcon('AlertCircle');
        const ArrowRight = getIcon('ArrowRight');
        const ClipboardList = getIcon('ClipboardList');
        const Utensils = getIcon('Utensils');
        const Battery = getIcon('Battery');
        const Phone = getIcon('Phone');
        const MessageSquare = getIcon('MessageSquare');
        const Info = getIcon('Info');
        const Lock = getIcon('Lock');
        const Unlock = getIcon('Unlock');
        const Gift = getIcon('Gift');
        const RefreshCw = getIcon('RefreshCw');
        const XCircle = getIcon('XCircle');
        const Dumbbell = getIcon('Dumbbell');
        const Zap = getIcon('Zap');


        // --- Supabase Configuration Placeholder ---
        // ‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤ Key ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á
        const SUPABASE_URL = "https://qzqvwbucjxwgtmbdkrlu.supabase.co"; 
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6cXZ3YnVjanh3Z3RtYmRrcmx1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzNzgxODksImV4cCI6MjA4MDk1NDE4OX0.RYvc5kMueNhsOu---WOKcXYnOZLVnjiWklp1IiHmgS8";

        // --- Database Data ---
        const SNACK_DATABASE = [
            { name: '‡∏ä‡∏≤‡∏ô‡∏°‡πÑ‡∏Ç‡πà‡∏°‡∏∏‡∏Å (1 ‡πÅ‡∏Å‡πâ‡∏ß)', kcal: 350, c: 60, f: 10, p: 1, icon: 'üßã' },
            { name: '‡∏Å‡∏•‡πâ‡∏ß‡∏¢‡πÅ‡∏Ç‡∏Å (3 ‡∏ä‡∏¥‡πâ‡∏ô)', kcal: 280, c: 45, f: 12, p: 1, icon: 'üçå' },
            { name: '‡∏Ñ‡∏∏‡∏Å‡∏Å‡∏µ‡πâ‡πÄ‡∏ô‡∏¢ (2 ‡∏ä‡∏¥‡πâ‡∏ô)', kcal: 180, c: 20, f: 10, p: 2, icon: 'üç™' },
            { name: '‡∏•‡∏π‡∏Å‡∏ä‡∏¥‡πâ‡∏ô‡∏ó‡∏≠‡∏î (5 ‡∏•‡∏π‡∏Å)', kcal: 250, c: 30, f: 12, p: 8, icon: 'üç°' },
            { name: '‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á‡πÑ‡∏™‡πâ‡∏Ñ‡∏£‡∏µ‡∏°', kcal: 320, c: 45, f: 14, p: 6, icon: 'ü•Ø' },
            { name: '‡πÑ‡∏≠‡∏®‡∏Å‡∏£‡∏µ‡∏°‡∏Å‡∏∞‡∏ó‡∏¥', kcal: 220, c: 25, f: 12, p: 2, icon: 'üç®' },
            { name: '‡∏Å‡∏≤‡πÅ‡∏ü‡πÄ‡∏¢‡πá‡∏ô‡∏´‡∏ß‡∏≤‡∏ô‡∏°‡∏±‡∏ô', kcal: 280, c: 35, f: 12, p: 3, icon: '‚òï' },
            { name: '‡∏Ç‡πâ‡∏≤‡∏ß‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß‡∏°‡∏∞‡∏°‡πà‡∏ß‡∏á(‡πÄ‡∏•‡πá‡∏Å)', kcal: 350, c: 65, f: 8, p: 4, icon: 'ü•≠' },
            { name: '‡∏õ‡∏≤‡∏ó‡πà‡∏≠‡∏á‡πÇ‡∏Å‡πã (1 ‡∏Ñ‡∏π‡πà)', kcal: 150, c: 18, f: 8, p: 2, icon: 'ü•ñ' },
            { name: '‡∏°‡∏±‡∏ô‡∏ù‡∏£‡∏±‡πà‡∏á‡∏ó‡∏≠‡∏î (‡∏ñ‡∏∏‡∏á‡πÄ‡∏•‡πá‡∏Å)', kcal: 160, c: 15, f: 10, p: 2, icon: 'ü•î' },
        ];

        const HEALTHY_SNACK_DATABASE = [
            { name: '‡∏≠‡∏±‡∏•‡∏°‡∏≠‡∏ô‡∏î‡πå (1 ‡∏Å‡∏≥‡∏°‡∏∑‡∏≠)', kcal: 160, c: 6, f: 14, p: 6, icon: 'ü•ú' },
            { name: '‡∏ù‡∏£‡∏±‡πà‡∏á (1 ‡∏•‡∏π‡∏Å)', kcal: 60, c: 15, f: 0, p: 2, icon: 'üçà' },
            { name: '‡∏î‡∏≤‡∏£‡πå‡∏Å‡∏ä‡πá‡∏≠‡∏Å‡πÇ‡∏Å‡πÅ‡∏•‡∏ï 85%', kcal: 120, c: 8, f: 10, p: 2, icon: 'üç´' },
            { name: '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ‡πà‡∏£‡∏ß‡∏°', kcal: 50, c: 12, f: 0, p: 1, icon: 'ü´ê' },
            { name: '‡πÑ‡∏Ç‡πà‡∏ï‡πâ‡∏°‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£', kcal: 70, c: 0, f: 5, p: 6, icon: 'ü•ö' },
        ];

        const PROTEIN_DATABASE = [
            { name: '‡πÑ‡∏Ç‡πà‡∏ï‡πâ‡∏° (2 ‡∏ü‡∏≠‡∏á)', protein: 14, kcal: 140, icon: 'ü•ö' },
            { name: '‡∏≠‡∏Å‡πÑ‡∏Å‡πà‡∏•‡∏ß‡∏Å (100g)', protein: 23, kcal: 120, icon: 'üçó' },
            { name: '‡∏õ‡∏•‡∏≤‡πÅ‡∏ã‡∏•‡∏°‡∏≠‡∏ô (100g)', protein: 20, kcal: 200, icon: 'üêü' },
            { name: '‡πÄ‡∏ï‡πâ‡∏≤‡∏´‡∏π‡πâ‡∏Ç‡∏≤‡∏ß (1 ‡∏Å‡πâ‡∏≠‡∏ô)', protein: 10, kcal: 90, icon: 'üßä' },
            { name: '‡∏Å‡∏£‡∏µ‡∏Å‡πÇ‡∏¢‡πÄ‡∏Å‡∏¥‡∏£‡πå‡∏ï (1 ‡∏ñ‡πâ‡∏ß‡∏¢)', protein: 10, kcal: 60, icon: 'ü•£' },
            { name: '‡∏ó‡∏π‡∏ô‡πà‡∏≤‡∏Å‡∏£‡∏∞‡∏õ‡πã‡∏≠‡∏á (‡∏Ñ‡∏£‡∏∂‡πà‡∏á)', protein: 16, kcal: 70, icon: 'ü•´' },
            { name: '‡∏ñ‡∏±‡πà‡∏ß‡πÅ‡∏£‡∏∞‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô (1 ‡∏ñ‡πâ‡∏ß‡∏¢)', protein: 11, kcal: 120, icon: 'ü•ú' },
            { name: '‡∏Å‡∏∏‡πâ‡∏á‡∏•‡∏ß‡∏Å (10 ‡∏ï‡∏±‡∏ß)', protein: 20, kcal: 100, icon: 'ü¶ê' },
            { name: '‡∏ô‡∏°‡∏ñ‡∏±‡πà‡∏ß‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á (1 ‡πÅ‡∏Å‡πâ‡∏ß)', protein: 8, kcal: 80, icon: 'ü•õ' },
            { name: '‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡πÄ‡∏ä‡∏Ñ (1.5 ‡∏™‡∏Å‡∏π‡πä‡∏õ)', protein: 30, kcal: 130, icon: 'ü•§', highlight: true },
        ];

        // --- Sub-components ---

        const WelcomeStep = ({ setStep }) => (
            <div className="text-center space-y-6 py-8">
            <div className="flex justify-center mb-6">
                <div className="bg-teal-100 p-4 rounded-full">
                <Activity className="w-12 h-12 text-teal-600" />
                </div>
            </div>
            <h1 className="text-3xl font-bold text-gray-800">‡πÄ‡∏ä‡πá‡∏Å‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ú‡∏≤‡∏ú‡∏•‡∏≤‡∏ç‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h1>
            <p className="text-gray-600 text-lg">
                ‡∏£‡∏π‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? BMI ‡∏≠‡∏≤‡∏à‡∏´‡∏•‡∏≠‡∏Å‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ! <br/>
                ‡∏ï‡∏£‡∏ß‡∏à‡∏•‡∏∂‡∏Å‡∏ñ‡∏∂‡∏á‡∏£‡∏∞‡∏î‡∏±‡∏ö <strong>"‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡πÅ‡∏ù‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ó‡πâ‡∏≠‡∏á"</strong> ‡∏î‡πâ‡∏ß‡∏¢‡∏´‡∏•‡∏±‡∏Å‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå
            </p>
            <div className="flex flex-col gap-3 mt-8">
                <button 
                onClick={() => setStep(1)}
                className="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-4 px-6 rounded-xl shadow-lg transform transition hover:-translate-y-1 flex items-center justify-center text-lg"
                >
                ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô <ArrowRight className="ml-2 w-5 h-5" />
                </button>
                <p className="text-xs text-gray-400 mt-2">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ ‚Ä¢ ‡∏£‡∏π‡πâ‡∏ú‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
            </div>
            </div>
        );

        const BasicInfoStep = ({ formData, setFormData, handleInputChange, setStep }) => (
            <div className="space-y-6">
            <h2 className="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                <User className="mr-2 text-teal-600" /> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢
            </h2>
            
            <div className="grid grid-cols-2 gap-4 mb-4">
                <button 
                onClick={() => setFormData(prev => ({...prev, gender: 'male'}))}
                className={`p-4 rounded-xl border-2 flex flex-col items-center justify-center transition ${formData.gender === 'male' ? 'border-teal-500 bg-teal-50 text-teal-700' : 'border-gray-200 text-gray-500'}`}
                >
                <span className="text-2xl mb-1">üë®</span> ‡∏ä‡∏≤‡∏¢
                </button>
                <button 
                onClick={() => setFormData(prev => ({...prev, gender: 'female'}))}
                className={`p-4 rounded-xl border-2 flex flex-col items-center justify-center transition ${formData.gender === 'female' ? 'border-teal-500 bg-teal-50 text-teal-700' : 'border-gray-200 text-gray-500'}`}
                >
                <span className="text-2xl mb-1">üë©</span> ‡∏´‡∏ç‡∏¥‡∏á
                </button>
            </div>

            <div className="space-y-4">
                <div className="grid grid-cols-2 gap-4">
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏õ‡∏µ)</label>
                    <input 
                    type="number" 
                    name="age"
                    value={formData.age}
                    onChange={handleInputChange}
                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:outline-none"
                    placeholder="‡πÄ‡∏ä‡πà‡∏ô 35"
                    />
                </div>
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏≠‡∏ö‡πÄ‡∏≠‡∏ß (‡∏ô‡∏¥‡πâ‡∏ß)</label>
                    <div className="relative">
                    <input 
                        type="number" 
                        name="waist"
                        value={formData.waist}
                        onChange={handleInputChange}
                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:outline-none pl-10"
                        placeholder="‡πÄ‡∏ä‡πà‡∏ô 32"
                    />
                    <Ruler className="absolute left-3 top-3.5 text-gray-400 w-5 h-5" />
                    </div>
                    <p className="text-xs text-teal-600 mt-1">*‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏î‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ó‡πâ‡∏≠‡∏á</p>
                </div>
                </div>

                <div className="grid grid-cols-2 gap-4">
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á (‡∏ã‡∏°.)</label>
                    <div className="relative">
                    <input 
                        type="number" 
                        name="height"
                        value={formData.height}
                        onChange={handleInputChange}
                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:outline-none pl-10"
                        placeholder="165"
                    />
                    <Ruler className="absolute left-3 top-3.5 text-gray-400 w-5 h-5" />
                    </div>
                </div>
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.)</label>
                    <div className="relative">
                    <input 
                        type="number" 
                        name="weight"
                        value={formData.weight}
                        onChange={handleInputChange}
                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:outline-none pl-10"
                        placeholder="60"
                    />
                    <Scale className="absolute left-3 top-3.5 text-gray-400 w-5 h-5" />
                    </div>
                </div>
                </div>
            </div>

            <button 
                disabled={!formData.age || !formData.height || !formData.weight || !formData.waist}
                onClick={() => setStep(2)}
                className="w-full bg-teal-600 disabled:bg-gray-300 text-white font-bold py-3 rounded-xl mt-6 flex justify-center items-center"
            >
                ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ <ChevronRight className="ml-1" />
            </button>
            </div>
        );

        const ActivityStep = ({ formData, setFormData, setStep }) => (
            <div className="space-y-6">
            <h2 className="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                <Activity className="mr-2 text-teal-600" /> ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
            </h2>
            <p className="text-gray-600 text-sm">‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏°‡∏µ‡∏ú‡∏•‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏≠‡∏¥‡∏ô‡∏ã‡∏π‡∏•‡∏¥‡∏ô‡πÉ‡∏ô‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢</p>
            
            <div className="space-y-3">
                {[
                { id: 'sedentary', label: '‡∏ô‡∏±‡πà‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å', desc: '‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡∏ô‡πâ‡∏≠‡∏¢‡∏°‡∏≤‡∏Å ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏≠‡∏Å‡πÄ‡∏•‡∏¢' },
                { id: 'light', label: '‡∏Ç‡∏¢‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏ö‡πâ‡∏≤‡∏á', desc: '‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡πÄ‡∏ö‡∏≤‡πÜ 1-3 ‡∏ß‡∏±‡∏ô/‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå' },
                { id: 'moderate', label: '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á', desc: '‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢ 3-5 ‡∏ß‡∏±‡∏ô/‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå' },
                { id: 'active', label: '‡πÅ‡∏≠‡∏Ñ‡∏ó‡∏µ‡∏ü‡∏°‡∏≤‡∏Å', desc: '‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡∏´‡∏ô‡∏±‡∏Å ‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏ä‡πâ‡πÅ‡∏£‡∏á‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô' }
                ].map((option) => (
                <button
                    key={option.id}
                    onClick={() => setFormData(prev => ({...prev, activity: option.id}))}
                    className={`w-full text-left p-4 rounded-xl border-2 transition hover:border-teal-300 ${formData.activity === option.id ? 'border-teal-500 bg-teal-50' : 'border-gray-200'}`}
                >
                    <div className={`font-bold ${formData.activity === option.id ? 'text-teal-800' : 'text-gray-700'}`}>{option.label}</div>
                    <div className="text-sm text-gray-500">{option.desc}</div>
                </button>
                ))}
            </div>

            <div className="flex gap-3 mt-6">
                <button onClick={() => setStep(1)} className="px-6 py-3 border border-gray-300 rounded-xl text-gray-600">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
                <button onClick={() => setStep(3)} className="flex-1 bg-teal-600 text-white font-bold py-3 rounded-xl flex justify-center items-center">
                ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ <ChevronRight className="ml-1" />
                </button>
            </div>
            </div>
        );

        const SymptomsStep = ({ formData, toggleSymptom, setStep, calculateResult }) => (
            <div className="space-y-6">
            <h2 className="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                <ClipboardList className="mr-2 text-teal-600" /> ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏û‡∏ö (Metabolic Signs)
            </h2>
            <p className="text-gray-600 text-sm">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡πà‡∏≠‡∏¢‡πÜ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1 ‡∏Ç‡πâ‡∏≠)</p>
            
            <div className="grid grid-cols-1 gap-3">
                {[
                { id: 'craving', label: '‡∏´‡∏¥‡∏ß‡∏ö‡πà‡∏≠‡∏¢ / ‡∏ï‡∏¥‡∏î‡∏´‡∏ß‡∏≤‡∏ô', icon: <Utensils className="w-4 h-4" /> },
                { id: 'hangry', label: '‡πÇ‡∏°‡πÇ‡∏´‡∏´‡∏¥‡∏ß (Hangry) ‡∏á‡πà‡∏≤‡∏¢', icon: <AlertCircle className="w-4 h-4" /> },
                { id: 'fatigue', label: '‡∏á‡πà‡∏ß‡∏á‡∏ô‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏°‡∏∑‡πâ‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£', icon: <Battery className="w-4 h-4" /> },
                { id: 'yo-yo', label: '‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô‡∏á‡πà‡∏≤‡∏¢ ‡∏•‡∏á‡∏¢‡∏≤‡∏Å', icon: <Scale className="w-4 h-4" /> },
                { id: 'stress', label: '‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î‡∏á‡πà‡∏≤‡∏¢ / ‡∏ô‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏´‡∏•‡∏±‡∏ö', icon: <Activity className="w-4 h-4" /> },
                { id: 'none', label: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≤‡∏á‡∏ï‡πâ‡∏ô', icon: <CheckCircle className="w-4 h-4" /> }
                ].map((item) => (
                <button
                    key={item.id}
                    onClick={() => toggleSymptom(item.id)}
                    className={`flex items-center p-4 rounded-xl border-2 transition ${formData.symptoms.includes(item.id) ? 'border-teal-500 bg-teal-50 text-teal-800' : 'border-gray-200 text-gray-600'}`}
                >
                    <div className={`mr-3 p-2 rounded-full ${formData.symptoms.includes(item.id) ? 'bg-teal-200' : 'bg-gray-100'}`}>
                    {item.icon}
                    </div>
                    {item.label}
                </button>
                ))}
            </div>

            <div className="flex gap-3 mt-6">
                <button onClick={() => setStep(2)} className="px-6 py-3 border border-gray-300 rounded-xl text-gray-600">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
                <button onClick={calculateResult} className="flex-1 bg-teal-600 text-white font-bold py-3 rounded-xl shadow-lg flex justify-center items-center">
                ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• <Activity className="ml-2 animate-pulse" />
                </button>
            </div>
            </div>
        );

        const ResultStep = ({ result, formData, setStep }) => {
            const [showFact, setShowFact] = useState(false);
            const [showSnackCheck, setShowSnackCheck] = useState(false);
            const [currentSnacks, setCurrentSnacks] = useState([]);
            const [showProteinCheck, setShowProteinCheck] = useState(false);
            const [currentProteins, setCurrentProteins] = useState([]);
            const [proteinGoal, setProteinGoal] = useState(0);

            const isHealthy = result.bmi >= 18.5 && result.bmi < 23 && result.whtrStatus === 'normal';

            // Calculate Gauge Position (Piece-wise function for accuracy)
            const getGaugePosition = (bmi) => {
            if (bmi < 18.5) {
                return (bmi / 18.5) * 18.5; // 0-18.5 mapped to 0-18.5%
            } else if (bmi < 23) {
                return 18.5 + ((bmi - 18.5) / (23 - 18.5)) * 13.5; // 18.5-23 mapped to 18.5-32%
            } else if (bmi < 25) {
                return 32 + ((bmi - 23) / (25 - 23)) * 11; // 23-25 mapped to 32-43%
            } else if (bmi < 30) {
                return 43 + ((bmi - 25) / (30 - 25)) * 20; // 25-30 mapped to 43-63%
            } else {
                // 30+ mapped to 63-100% (cap at BMI 40)
                const cappedBmi = Math.min(bmi, 40);
                return 63 + ((cappedBmi - 30) / (40 - 30)) * 37;
            }
            };

            const gaugePosition = getGaugePosition(parseFloat(result.bmi));

            const getRandomItems = (array, count) => {
            const shuffled = [...array].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
            };

            const handleSnackCheck = () => {
            if (!showSnackCheck) {
                // If healthy, show healthy snacks options instead of warning
                const db = isHealthy ? HEALTHY_SNACK_DATABASE : SNACK_DATABASE;
                setCurrentSnacks(getRandomItems(db, 3));
            }
            setShowSnackCheck(!showSnackCheck);
            };

            const shuffleSnacks = () => {
            const db = isHealthy ? HEALTHY_SNACK_DATABASE : SNACK_DATABASE;
            setCurrentSnacks(getRandomItems(db, 3));
            };

            const handleProteinCheck = () => {
            if (!showProteinCheck) {
                const shake = PROTEIN_DATABASE.find(p => p.highlight);
                const others = PROTEIN_DATABASE.filter(p => !p.highlight);
                const randomOthers = getRandomItems(others, 2);
                const mix = [...randomOthers, shake].sort(() => 0.5 - Math.random());
                
                // Healthy people might aim for higher protein for muscle (e.g., 2.0g), others 1.5g
                const multiplier = isHealthy ? 1.8 : 1.5;
                setProteinGoal(Math.round(parseFloat(formData.weight) * multiplier)); 
                setCurrentProteins(mix);
            }
            setShowProteinCheck(!showProteinCheck);
            };

            const shuffleProtein = () => {
            const shake = PROTEIN_DATABASE.find(p => p.highlight);
            const others = PROTEIN_DATABASE.filter(p => !p.highlight);
            const randomOthers = getRandomItems(others, 2);
            const mix = [...randomOthers, shake].sort(() => 0.5 - Math.random());
            setCurrentProteins(mix);
            };

            return (
            <div className="space-y-6 animate-fade-in">
                {/* --- Section 1: ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û (Health Score) --- */}
                <div className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                <div className="bg-gray-50 p-4 border-b border-gray-100 text-center">
                    <h3 className="text-gray-500 text-sm uppercase tracking-wider font-semibold">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢</h3>
                    
                    <div className="grid grid-cols-2 gap-4 mt-4">
                    <div className="bg-white p-3 rounded-xl border border-gray-200">
                        <span className="text-xs text-gray-400 block mb-1">BMI Value</span>
                        <span className={`text-2xl font-bold ${result.category.color}`}>{result.bmi}</span>
                        <div className="text-xs text-gray-500">{result.category.label}</div>
                    </div>
                    
                    <div className="bg-white p-3 rounded-xl border border-gray-200 relative">
                        <div className="absolute top-2 right-2 cursor-pointer" onClick={() => setShowFact(!showFact)}>
                            <Info className="w-4 h-4 text-gray-400 hover:text-teal-500" />
                        </div>
                        <span className="text-xs text-gray-400 block mb-1">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏≠‡∏ß/‡∏™‡∏π‡∏á</span>
                        <span className={`text-2xl font-bold ${result.whtrStatus === 'risk' ? 'text-red-500' : 'text-green-500'}`}>
                            {result.whtr}
                        </span>
                        <div className="text-xs text-gray-500">
                            {result.whtrStatus === 'risk' ? '‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ó‡πâ‡∏≠‡∏á‡∏™‡∏π‡∏á' : '‡∏™‡∏°‡∏™‡πà‡∏ß‡∏ô'}
                        </div>
                    </div>
                    </div>
                    
                    {showFact && (
                        <div className="mt-3 bg-blue-50 text-blue-800 text-xs text-left p-3 rounded-lg border border-blue-100">
                            <strong>Did you know?</strong> ‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤ "‡∏£‡∏≠‡∏ö‡πÄ‡∏≠‡∏ß‡∏´‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á" (WHtR) ‡∏ö‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÇ‡∏£‡∏Ñ‡∏´‡∏±‡∏ß‡πÉ‡∏à‡πÑ‡∏î‡πâ‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏Å‡∏ß‡πà‡∏≤ BMI ‡πÇ‡∏î‡∏¢‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡πÄ‡∏Å‡∏¥‡∏ô 0.5
                        </div>
                    )}
                </div>

                {/* Visual Gauge - Fixed Scale */}
                <div className="px-6 py-4">
                    <div className="relative pt-6 pb-2">
                    <div className="h-4 bg-gray-200 rounded-full overflow-hidden flex">
                        <div className="w-[18.5%] bg-blue-300"></div> 
                        <div className="w-[13.5%] bg-green-400"></div> 
                        <div className="w-[11%] bg-yellow-400"></div> 
                        <div className="w-[20%] bg-orange-400"></div> 
                        <div className="w-[37%] bg-red-400"></div>   
                    </div>
                    <div 
                        className="absolute top-0 transform -translate-x-1/2 transition-all duration-1000"
                        style={{ left: `${gaugePosition}%` }}
                    >
                        <div className="w-0 h-0 border-l-[8px] border-l-transparent border-r-[8px] border-r-transparent border-t-[10px] border-t-gray-800 mx-auto mb-1"></div>
                        <div className="bg-gray-800 text-white text-xs py-0.5 px-2 rounded-md font-bold text-center w-max mx-auto -mt-1">‡∏Ñ‡∏∏‡∏ì</div>
                    </div>
                    </div>
                    <div className="flex justify-between text-[10px] text-gray-400 mt-1 font-mono">
                    <span className="w-[18.5%] text-right pr-1">18.5</span>
                    <span className="w-[13.5%] text-right pr-1">23</span>
                    <span className="w-[11%] text-right pr-1">25</span>
                    <span className="w-[20%] text-right pr-1">30</span>
                    <span className="w-[37%]"></span>
                    </div>
                    
                    {result.whtrStatus === 'risk' ? (
                        <div className="mt-4 bg-red-50 border border-red-100 rounded-lg p-3 flex items-start">
                            <AlertCircle className="w-5 h-5 text-red-500 mr-2 flex-shrink-0 mt-0.5" />
                            <div>
                                <p className="text-sm font-bold text-red-700">‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏†‡∏≤‡∏ß‡∏∞ "Skinny Fat" (‡∏≠‡πâ‡∏ß‡∏ô‡∏•‡∏á‡∏û‡∏∏‡∏á)</p>
                                <p className="text-xs text-red-600 mt-1">‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ó‡πâ‡∏≠‡∏á‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå ‡∏Ç‡∏±‡∏î‡∏Ç‡∏ß‡∏≤‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ú‡∏≤‡∏ú‡∏•‡∏≤‡∏ç</p>
                            </div>
                        </div>
                    ) : (
                    <div className="mt-4 bg-green-50 border border-green-100 rounded-lg p-3 flex items-start">
                            <CheckCircle className="w-5 h-5 text-green-500 mr-2 flex-shrink-0 mt-0.5" />
                            <div>
                                <p className="text-sm font-bold text-green-700">‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°! ‡∏£‡∏π‡∏õ‡∏£‡πà‡∏≤‡∏á‡∏™‡∏°‡∏™‡πà‡∏ß‡∏ô</p>
                                <p className="text-xs text-green-600 mt-1">‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏µ ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡πÅ‡∏Å‡πà‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏î‡∏±‡∏ö Metabolic Flexibility</p>
                            </div>
                        </div>
                    )}
                </div>
                </div>

                {/* --- Section 2: 5 Steps Solution --- */}
                <div className="space-y-3">
                <h4 className={`font-bold ${isHealthy ? 'text-teal-700' : 'text-gray-800'} flex items-center text-lg`}>
                    {isHealthy ? <Zap className="w-5 h-5 mr-2" /> : <CheckCircle className="w-5 h-5 mr-2" />}
                    {isHealthy ? '5 ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏£‡πà‡∏≤‡∏á‡∏ó‡∏≠‡∏á (Optimization)' : '5 ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ú‡∏≤‡∏ú‡∏•‡∏≤‡∏ç'}
                </h4>
                <p className="text-sm text-gray-500 -mt-2 mb-4">
                    {isHealthy ? '‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô' : '‡∏ó‡∏≥‡∏ï‡∏≤‡∏°‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏î‡∏≠‡∏≤‡∏´‡∏≤‡∏£'}
                </p>

                {/* Step 1 */}
                <div className={`bg-white border-l-4 ${isHealthy ? 'border-blue-500' : 'border-teal-500'} rounded-r-xl shadow-sm overflow-hidden`}>
                    <div className="p-4">
                    <h5 className="font-bold text-gray-800 flex justify-between">
                        {isHealthy ? '1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ä‡∏∞‡∏•‡∏≠‡∏ß‡∏±‡∏¢' : '1. ‡∏´‡∏¢‡∏∏‡∏î "‡∏à‡∏∏‡∏ö‡∏à‡∏¥‡∏ö" ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ'}
                        <span className={`text-xs font-bold ${isHealthy ? 'bg-blue-100 text-blue-700' : 'bg-teal-100 text-teal-700'} px-2 py-1 rounded h-fit`}>‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢</span>
                    </h5>
                    <p className="text-sm text-gray-600 mt-1 mb-3">
                        {isHealthy 
                        ? '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô Superfood ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡πâ‡∏≤‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏π‡∏•‡∏≠‡∏¥‡∏™‡∏£‡∏∞' 
                        : '‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏ô‡∏ö‡πà‡∏≠‡∏¢‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡πâ‡∏ô‡∏≠‡∏¥‡∏ô‡∏ã‡∏π‡∏•‡∏¥‡∏ô‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤ ‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡πÑ‡∏°‡πà‡∏î‡∏∂‡∏á‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡∏°‡∏≤‡πÉ‡∏ä‡πâ'}
                    </p>
                    
                    <button 
                        onClick={handleSnackCheck}
                        className={`text-sm border px-3 py-1.5 rounded-lg w-full flex items-center justify-center transition ${isHealthy ? 'bg-green-50 text-green-600 border-green-100 hover:bg-green-100' : 'bg-red-50 text-red-600 border-red-100 hover:bg-red-100'}`}
                    >
                        {isHealthy ? <CheckCircle className="w-4 h-4 mr-2" /> : <XCircle className="w-4 h-4 mr-2" />}
                        {showSnackCheck ? '‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£' : (isHealthy ? '‡∏î‡∏π‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏Ç‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û' : '‡∏î‡∏π‡πÄ‡∏°‡∏ô‡∏π‡∏à‡∏∏‡∏ö‡∏à‡∏¥‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ß‡∏±‡∏á')}
                    </button>
                    
                    {showSnackCheck && (
                        <div className={`mt-3 p-3 rounded-xl border animate-fade-in ${isHealthy ? 'bg-green-50/50 border-green-100' : 'bg-red-50/50 border-red-100'}`}>
                        <div className="flex justify-between items-center mb-2">
                            <span className={`text-xs font-bold uppercase tracking-wide ${isHealthy ? 'text-green-500' : 'text-red-500'}`}>
                            {isHealthy ? '‡∏Ç‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥' : '‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏°‡∏ô‡∏π‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏ù‡∏á'}
                            </span>
                            <button onClick={shuffleSnacks} className="text-gray-400 hover:text-gray-600">
                            <RefreshCw className="w-4 h-4" />
                            </button>
                        </div>
                        <div className="space-y-2">
                            {currentSnacks.map((snack, idx) => (
                            <div key={idx} className={`bg-white p-2 rounded-lg border flex justify-between items-center shadow-sm ${isHealthy ? 'border-green-100' : 'border-red-100'}`}>
                                <div className="flex items-center">
                                <span className="text-xl mr-2">{snack.icon}</span>
                                <div>
                                    <p className="text-sm font-bold text-gray-800">{snack.name}</p>
                                    <p className="text-[10px] text-gray-500">
                                    C:{snack.c} F:{snack.f} P:{snack.p}
                                    </p>
                                </div>
                                </div>
                                <span className={`text-sm font-bold ${isHealthy ? 'text-green-600' : 'text-red-500'}`}>{snack.kcal} <span className="text-[10px] font-normal text-gray-400">kcal</span></span>
                            </div>
                            ))}
                        </div>
                        </div>
                    )}
                    </div>
                </div>

                {/* Step 2 */}
                <div className={`bg-white border-l-4 ${isHealthy ? 'border-blue-500' : 'border-teal-500'} rounded-r-xl shadow-sm overflow-hidden`}>
                    <div className="p-4">
                    <h5 className="font-bold text-gray-800 flex justify-between">
                        {isHealthy ? '2. ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠' : '2. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏°‡∏∑‡πâ‡∏≠‡πÅ‡∏£‡∏Å'}
                        <span className={`text-xs font-bold ${isHealthy ? 'bg-blue-100 text-blue-700' : 'bg-teal-100 text-teal-700'} px-2 py-1 rounded h-fit`}>‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢</span>
                    </h5>
                    <p className="text-sm text-gray-600 mt-1 mb-3">
                        {isHealthy 
                        ? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏ß‡∏•‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ú‡∏≤‡∏ú‡∏•‡∏≤‡∏ç‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (BMR)' 
                        : '‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏£‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ú‡∏≤‡∏ú‡∏•‡∏≤‡∏ç‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∏‡∏°‡∏´‡∏¥‡∏ß‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î'}
                    </p>

                    <button 
                        onClick={handleProteinCheck}
                        className="text-sm bg-blue-50 text-blue-600 border border-blue-100 px-3 py-1.5 rounded-lg w-full flex items-center justify-center hover:bg-blue-100 transition"
                    >
                        <Dumbbell className="w-4 h-4 mr-2" /> 
                        {showProteinCheck ? '‡∏ã‡πà‡∏≠‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì' : '‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö'}
                    </button>

                    {showProteinCheck && (
                        <div className="mt-3 bg-blue-50/50 p-3 rounded-xl border border-blue-100 animate-fade-in">
                        <div className="flex items-center justify-between mb-3 bg-white p-2 rounded-lg border border-blue-100 shadow-sm">
                            <span className="text-xs text-gray-500">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</span>
                            <div className="text-right">
                            <span className="text-lg font-bold text-blue-600">{proteinGoal}g</span>
                            <span className="text-[10px] text-gray-400 block -mt-1">{isHealthy ? '‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠/‡∏ß‡∏±‡∏ô' : '‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô/‡∏ß‡∏±‡∏ô'}</span>
                            </div>
                        </div>

                        <div className="flex justify-between items-center mb-2">
                            <span className="text-xs font-bold text-blue-500 uppercase tracking-wide">‡πÅ‡∏´‡∏•‡πà‡∏á‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</span>
                            <button onClick={shuffleProtein} className="text-gray-400 hover:text-gray-600">
                            <RefreshCw className="w-4 h-4" />
                            </button>
                        </div>
                        
                        <div className="space-y-2">
                            {currentProteins.map((item, idx) => (
                            <div key={idx} className={`bg-white p-2 rounded-lg border flex justify-between items-center shadow-sm ${item.highlight ? 'border-teal-300 ring-1 ring-teal-100' : 'border-blue-100'}`}>
                                <div className="flex items-center">
                                <span className="text-xl mr-2">{item.icon}</span>
                                <div>
                                    <p className={`text-sm font-bold ${item.highlight ? 'text-teal-700' : 'text-gray-800'}`}>{item.name}</p>
                                    <p className="text-[10px] text-gray-500">{item.kcal} kcal</p>
                                </div>
                                </div>
                                <div className="text-right">
                                <span className={`text-sm font-bold ${item.highlight ? 'text-teal-600' : 'text-blue-600'}`}>{item.protein}g</span>
                                <span className="text-[10px] font-normal text-gray-400 block -mt-1">‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô</span>
                                </div>
                            </div>
                            ))}
                        </div>
                        </div>
                    )}
                    </div>
                </div>

                {/* Locked Steps Overlay */}
                <div className="relative">
                    <div className="opacity-50 blur-sm pointer-events-none space-y-3 select-none">
                    <div className="bg-gray-100 p-4 rounded-xl border border-gray-200">
                        <h5 className="font-bold text-gray-500">3. {isHealthy ? '‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ Autophagy ‡∏ä‡∏∞‡∏•‡∏≠‡∏ß‡∏±‡∏¢' : '‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ IF ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏°‡∏≤‡∏ô'}</h5>
                        <p className="text-sm text-gray-400">xxxxxx xxxxxxxx xxxxxxx</p>
                    </div>
                    <div className="bg-gray-100 p-4 rounded-xl border border-gray-200">
                        <h5 className="font-bold text-gray-500">4. {isHealthy ? 'Zone 2 Training ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏∂‡∏î' : '‡πÇ‡∏ã‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡∏™‡∏•‡∏≤‡∏¢‡∏û‡∏∏‡∏á'}</h5>
                        <p className="text-sm text-gray-400">xxxxxx xxxxxxxx xxxxxxx</p>
                    </div>
                    <div className="bg-gray-100 p-4 rounded-xl border border-gray-200">
                        <h5 className="font-bold text-gray-500">5. {isHealthy ? 'Deep Sleep & Growth Hormone' : '‡∏Å‡∏≤‡∏£‡∏ô‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠ Metabolic Reset'}</h5>
                        <p className="text-sm text-gray-400">xxxxxx xxxxxxxx xxxxxxx</p>
                    </div>
                    </div>

                    <div className="absolute inset-0 flex flex-col items-center justify-center z-10 -mt-6">
                    <div className="bg-white/90 backdrop-blur-sm p-6 rounded-2xl shadow-lg border border-teal-100 text-center max-w-xs mx-auto">
                        <div className="bg-orange-100 p-3 rounded-full inline-block mb-3">
                        <Lock className="w-8 h-8 text-orange-500" />
                        </div>
                        <h4 className="font-bold text-gray-800 text-lg mb-1">‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å 3 ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h4>
                        <p className="text-sm text-gray-500 mb-2">
                        + <span className="text-teal-600 font-bold"><Gift className="inline w-3 h-3"/> Bonus: ‡∏™‡∏π‡∏ï‡∏£‡∏•‡∏±‡∏ö UP Labs</span><br/>
                        ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (Personalized)
                        </p>
                        <button 
                        onClick={() => setStep(5)}
                        className="w-full bg-gradient-to-r from-orange-500 to-red-500 text-white font-bold py-3 px-6 rounded-xl shadow-md hover:shadow-lg transform transition hover:scale-105 flex items-center justify-center"
                        >
                        <Unlock className="w-4 h-4 mr-2" /> ‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ü‡∏£‡∏µ
                        </button>
                    </div>
                    </div>
                </div>
                </div>
            </div>
            );
        };

        const LeadFormStep = ({ leadInfo, setLeadInfo, handleLeadSubmit, setStep }) => (
            <div className="space-y-6">
            <div className="text-center mb-6">
                <div className="bg-teal-100 p-4 rounded-full inline-block mb-4">
                <Unlock className="w-10 h-10 text-teal-600" />
                </div>
                <h2 className="text-2xl font-bold text-gray-800">‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!</h2>
                <p className="text-gray-600">
                ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö <strong>"3 ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ + ‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏™‡∏π‡∏ï‡∏£‡∏•‡∏±‡∏ö"</strong> <br/>
                ‡∏™‡πà‡∏á‡∏ï‡∏£‡∏á‡∏ñ‡∏∂‡∏á‡∏°‡∏∑‡∏≠‡∏Ñ‡∏∏‡∏ì‡∏ü‡∏£‡∏µ ‡∏ó‡∏≤‡∏á‡πÑ‡∏•‡∏ô‡πå/SMS
                </p>
            </div>

            <form onSubmit={handleLeadSubmit} className="space-y-4">
                <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                <div className="relative">
                    <input 
                    required
                    type="text" 
                    className="w-full p-3 border border-gray-300 rounded-lg pl-10 focus:ring-2 focus:ring-teal-500 focus:outline-none"
                    placeholder="‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡∏£‡∏±‡∏Å‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û"
                    value={leadInfo.name}
                    onChange={(e) => setLeadInfo(prev => ({...prev, name: e.target.value}))}
                    />
                    <User className="absolute left-3 top-3.5 text-gray-400 w-5 h-5" />
                </div>
                </div>
                <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö SMS)</label>
                <div className="relative">
                    <input 
                    required
                    type="tel" 
                    className="w-full p-3 border border-gray-300 rounded-lg pl-10 focus:ring-2 focus:ring-teal-500 focus:outline-none"
                    placeholder="081-234-5678"
                    value={leadInfo.phone}
                    onChange={(e) => setLeadInfo(prev => ({...prev, phone: e.target.value}))}
                    />
                    <Phone className="absolute left-3 top-3.5 text-gray-400 w-5 h-5" />
                </div>
                </div>
                <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Line ID (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏™‡∏π‡∏ï‡∏£‡∏•‡∏±‡∏ö‡∏â‡∏ö‡∏±‡∏ö‡πÄ‡∏ï‡πá‡∏°)</label>
                <div className="relative">
                    <input 
                    type="text" 
                    className="w-full p-3 border border-gray-300 rounded-lg pl-10 focus:ring-2 focus:ring-teal-500 focus:outline-none"
                    placeholder="@lineid"
                    value={leadInfo.lineId}
                    onChange={(e) => setLeadInfo(prev => ({...prev, lineId: e.target.value}))}
                    />
                    <MessageSquare className="absolute left-3 top-3.5 text-gray-400 w-5 h-5" />
                </div>
                </div>

                <button 
                type="submit"
                className="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-4 rounded-xl shadow-lg mt-6 transition-colors"
                >
                ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡∏ï‡∏£‡∏•‡∏±‡∏ö‡∏ü‡∏£‡∏µ
                </button>
            </form>
            
            <button onClick={() => setStep(4)} className="w-full text-center text-gray-500 text-sm mt-4">
                ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏î‡∏π‡∏ú‡∏• BMI
            </button>
            </div>
        );

        const ThankYouStep = ({ leadInfo }) => (
            <div className="text-center py-10 space-y-6">
            <div className="bg-green-100 p-6 rounded-full inline-block mb-4">
                <CheckCircle className="w-20 h-20 text-green-600" />
            </div>
            <h2 className="text-3xl font-bold text-gray-800">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h2>
            <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 max-w-sm mx-auto">
                <p className="text-gray-600 mb-2">‡πÄ‡∏£‡∏≤‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á <strong>"5 ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô + ‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏™‡∏π‡∏ï‡∏£‡∏•‡∏±‡∏ö"</strong> ‡πÑ‡∏õ‡∏ó‡∏µ‡πà:</p>
                <div className="space-y-1 mt-4">
                <p className="font-bold text-lg text-teal-700">{leadInfo.name}</p>
                <p className="text-gray-800 flex items-center justify-center gap-2"><MessageSquare className="w-4 h-4"/> {leadInfo.lineId || '-'}</p>
                <p className="text-gray-800 flex items-center justify-center gap-2"><Phone className="w-4 h-4"/> {leadInfo.phone}</p>
                </div>
            </div>
            <p className="text-sm text-gray-500 mt-8 px-4">
                "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Ñ‡∏∑‡∏≠‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ï‡∏•‡∏≠‡∏î‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï"
            </p>
            <button 
                onClick={() => window.location.reload()}
                className="text-teal-600 font-semibold underline mt-4"
            >
                ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
            </button>
            </div>
        );

        // --- Main Component ---
        function MetabolicHealthCheck() {
            const [step, setStep] = useState(0);
            const [loading, setLoading] = useState(false);
            const [formData, setFormData] = useState({
                gender: 'female',
                age: '',
                height: '',
                weight: '',
                waist: '',
                activity: 'sedentary',
                symptoms: []
            });
            const [result, setResult] = useState(null);
            const [leadInfo, setLeadInfo] = useState({
                name: '',
                phone: '',
                lineId: ''
            });
            const [submitted, setSubmitted] = useState(false);

            const getBMICategory = (bmi) => {
                if (bmi < 18.5) return { label: '‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ', color: 'text-blue-500', bg: 'bg-blue-500', advice: '‡∏Ñ‡∏ß‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠' };
                if (bmi < 23) return { label: '‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏™‡∏°‡∏™‡πà‡∏ß‡∏ô)', color: 'text-green-500', bg: 'bg-green-500', advice: '‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡∏µ‡πâ‡πÑ‡∏ß‡πâ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ú‡∏≤‡∏ú‡∏•‡∏≤‡∏ç‡∏ó‡∏µ‡πà‡∏î‡∏µ' };
                if (bmi < 25) return { label: '‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô (‡∏ó‡πâ‡∏ß‡∏°)', color: 'text-yellow-500', bg: 'bg-yellow-500', advice: '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á ‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡∏™‡∏∞‡∏™‡∏°' };
                if (bmi < 30) return { label: '‡∏≠‡πâ‡∏ß‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö 1', color: 'text-orange-500', bg: 'bg-orange-500', advice: '‡∏Ñ‡∏ß‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ú‡∏≤‡∏ú‡∏•‡∏≤‡∏ç‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏±‡∏á' };
                return { label: '‡∏≠‡πâ‡∏ß‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö 2 (‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢)', color: 'text-red-500', bg: 'bg-red-500', advice: '‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡πà‡∏≠‡πÇ‡∏£‡∏Ñ‡πÄ‡∏£‡∏∑‡πâ‡∏≠‡∏£‡∏±‡∏á‡∏™‡∏π‡∏á ‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏ó‡∏±‡∏ô‡∏ó‡∏µ' };
            };

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const toggleSymptom = (symptom) => {
                setFormData(prev => {
                const exists = prev.symptoms.includes(symptom);
                return {
                    ...prev,
                    symptoms: exists 
                    ? prev.symptoms.filter(s => s !== symptom)
                    : [...prev.symptoms, symptom]
                };
                });
            };

            const calculateResult = () => {
                setLoading(true);
                setTimeout(() => {
                const heightM = parseFloat(formData.height) / 100;
                const weightKg = parseFloat(formData.weight);
                const waistInches = parseFloat(formData.waist);
                const waistCm = waistInches * 2.54;
                const heightCm = parseFloat(formData.height);
                const bmi = weightKg / (heightM * heightM);
                const idealWeight = 22 * (heightM * heightM);
                const diff = weightKg - idealWeight;
                const whtr = waistCm / heightCm;
                const whtrStatus = whtr > 0.5 ? 'risk' : 'normal';

                setResult({
                    bmi: bmi.toFixed(1),
                    idealWeight: idealWeight.toFixed(1),
                    diff: diff.toFixed(1),
                    category: getBMICategory(bmi),
                    whtr: whtr.toFixed(2),
                    whtrStatus: whtrStatus
                });
                setLoading(false);
                setStep(4);
                }, 1500);
            };

            // --- Supabase Logic ---
            const saveToSupabase = async (data) => {
                try {
                // Check if Supabase client is available (from index.html via CDN)
                if (window.supabase) {
                    const { data: result, error } = await window.supabase
                    .from('leads') // Make sure you create this table in Supabase
                    .insert([
                        {
                        name: data.name,
                        phone: data.phone,
                        line_id: data.lineId,
                        bmi: result?.bmi, // Handle potential undefined if result isn't ready immediately in state in this scope? Actually result is in state. But here saveToSupabase is called with leadInfo. We need to pass the result state too or use the state directly.
                        // Actually saveToSupabase is defined inside the component scope, so it can access 'result' state.
                        // Wait, saveToSupabase is defined inside the component in the previous version.
                        // Let's make sure it accesses 'result'.
                        // Ah, the previous code passed leadInfo. I should check if it uses 'result' state variable.
                        // Yes, it uses 'result.bmi' and 'result.whtr'.
                        // But wait, saveToSupabase is asynchronous. 'result' state should be available.
                        whtr: result?.whtr,
                        created_at: new Date()
                        },
                    ]);
                    
                    if (error) console.error('Supabase Error:', error);
                } else {
                    console.log("Supabase client not found (Running in preview mode?)");
                }
                } catch (err) {
                console.error("Save error:", err);
                }
            };

            const handleLeadSubmit = (e) => {
                e.preventDefault();
                // Call Supabase save
                saveToSupabase(leadInfo);
                setSubmitted(true);
            };

            return (
                <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4 font-sans">
                <div className="max-w-md w-full bg-white rounded-3xl shadow-xl overflow-hidden relative">
                    {step > 0 && step < 6 && !submitted && (
                    <div className="h-2 bg-gray-100">
                        <div 
                        className="h-full bg-teal-500 transition-all duration-500 ease-out"
                        style={{ width: `${(step / 5) * 100}%` }}
                        ></div>
                    </div>
                    )}

                    <div className="p-6 md:p-8">
                    {loading ? (
                        <div className="text-center py-20">
                        <div className="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-teal-500 mx-auto mb-4"></div>
                        <h3 className="text-xl font-bold text-gray-700">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</h3>
                        <p className="text-gray-500">‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ñ‡πà‡∏≤ BMI ‡πÅ‡∏•‡∏∞‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ó‡πâ‡∏≠‡∏á (Visceral Fat)</p>
                        </div>
                    ) : (
                        <>
                        {step === 0 && <WelcomeStep setStep={setStep} />}
                        {step === 1 && <BasicInfoStep formData={formData} setFormData={setFormData} handleInputChange={handleInputChange} setStep={setStep} />}
                        {step === 2 && <ActivityStep formData={formData} setFormData={setFormData} setStep={setStep} />}
                        {step === 3 && <SymptomsStep formData={formData} toggleSymptom={toggleSymptom} setStep={setStep} calculateResult={calculateResult} />}
                        {step === 4 && result && <ResultStep result={result} formData={formData} setStep={setStep} />}
                        {step === 5 && !submitted && <LeadFormStep leadInfo={leadInfo} setLeadInfo={setLeadInfo} handleLeadSubmit={handleLeadSubmit} setStep={setStep} />}
                        {submitted && <ThankYouStep leadInfo={leadInfo} />}
                        </>
                    )}
                    </div>
                </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MetabolicHealthCheck />);
    </script>
</body>
</html>
