<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PharmaMate AI - ผู้ช่วยเภสัชกรอัจฉริยะ</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Sarabun', sans-serif;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        .animate-slide-up {
            animation: slideUp 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- CONFIGURATION ---
        // API KEY: ใส่ Key ที่ถูกต้องที่นี่
        const API_KEY = "AIzaSyBm7ymNtpwsfbGp5UD6CS5P6U5jyJMHWzg"; 

        // --- ICON COMPONENTS ---
        const Icon = ({ path, className = "", size = 24, color = "currentColor" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        const Icons = {
            Camera: (props) => <Icon {...props} path={<><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></>} />,
            Mic: (props) => <Icon {...props} path={<><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></>} />,
            Search: (props) => <Icon {...props} path={<><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></>} />,
            Pill: (props) => <Icon {...props} path={<><path d="m10.5 20.5 10-10a4.95 4.95 0 1 0-7-7l-10 10a4.95 4.95 0 1 0 7 7Z"/><path d="m8.5 8.5 7 7"/></>} />,
            AlertTriangle: (props) => <Icon {...props} path={<><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></>} />,
            FileText: (props) => <Icon {...props} path={<><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><polyline points="10 9 9 9 8 9"/></>} />,
            Activity: (props) => <Icon {...props} path={<polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>} />,
            Stethoscope: (props) => <Icon {...props} path={<><path d="M4.8 2.3A.3.3 0 1 0 5 2H4a2 2 0 0 0-2 2v5a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6V4a2 2 0 0 0-2-2h-1a.2.2 0 1 0 .3.3"/><path d="M8 15v1a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6v-4"/><circle cx="20" cy="10" r="2"/></>} />,
            ChevronRight: (props) => <Icon {...props} path={<polyline points="9 18 15 12 9 6"/>} />,
            X: (props) => <Icon {...props} path={<><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></>} />,
            Check: (props) => <Icon {...props} path={<polyline points="20 6 9 17 4 12"/>} />,
            Calculator: (props) => <Icon {...props} path={<><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></>} />,
            Loader2: (props) => <Icon {...props} path={<path d="M21 12a9 9 0 1 1-6.219-8.56"/>} />,
            Sparkles: (props) => <Icon {...props} path={<><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 5H5"/><path d="M19 21v-4"/><path d="M15 19h4"/></>} />
        };

        // --- API HANDLER (ROBUST & AUTO-RETRY) ---
        
        async function fetchWithModel(modelName, apiKey, prompt, imageBase64) {
            let contentsPart = [{ text: prompt }];

            if (imageBase64) {
                const base64Data = imageBase64.split(',')[1];
                contentsPart.push({
                    inlineData: {
                        mimeType: "image/jpeg",
                        data: base64Data
                    }
                });
            }

            const response = await fetch(
                `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`,
                {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: contentsPart }] }),
                }
            );
            return response;
        }

        async function callGeminiAPI(prompt, imageBase64 = null) {
            if (!API_KEY) {
                throw new Error("ไม่พบ API Key กรุณาใส่ Key ในโค้ด");
            }

            // Updated Model List (2025)
            // ลอง Flash > Pro > Flash 8b ตามลำดับความน่าจะเป็น
            const modelsToTry = [
                "gemini-2.5-flash",
                "gemini-1.5-flash", 
                "gemini-1.5-pro", 
                "gemini-1.5-flash-8b"
            ];

            let lastError = null;

            for (const model of modelsToTry) {
                try {
                    console.log(`กำลังเชื่อมต่อ AI Model: ${model}...`);
                    const response = await fetchWithModel(model, API_KEY, prompt, imageBase64);

                    if (response.ok) {
                        const data = await response.json();
                        
                        if (!data.candidates || data.candidates.length === 0) {
                            throw new Error("No candidates returned");
                        }

                        let text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (!text) throw new Error("Empty response text");

                        // CLEANUP: Remove Markdown Code Blocks
                        text = text.replace(/```json/g, '').replace(/```/g, '').trim();

                        // Try Parsing JSON
                        try {
                            const jsonMatch = text.match(/\[.*\]/s) || text.match(/\{.*\}/s);
                            if (jsonMatch) {
                                return JSON.parse(jsonMatch[0]);
                            } else {
                                return JSON.parse(text);
                            }
                        } catch (e) {
                            console.warn("JSON Parse failed, returning raw text:", e);
                            return { textResult: text, isRaw: true };
                        }
                    } else {
                        // ถ้าเจอ 404 (หา model ไม่เจอ) ให้ข้ามไปลองตัวถัดไปทันที
                        if (response.status === 404) {
                            console.warn(`Model ${model} not found (404), trying next...`);
                            lastError = new Error(`Model ${model} not found (API not enabled?)`);
                            continue; 
                        } else {
                            // Error อื่นๆ (เช่น 400 Bad Request, 403 Permission)
                            const errorText = await response.text();
                            let errorMessage = `API Error: ${response.status}`;
                            try {
                                const errorJson = JSON.parse(errorText);
                                if (errorJson.error && errorJson.error.message) {
                                    errorMessage += `\nMessage: ${errorJson.error.message}`;
                                }
                            } catch (e) {
                                errorMessage += `\nDetails: ${errorText}`;
                            }
                            throw new Error(errorMessage);
                        }
                    }
                } catch (error) {
                    console.error(`Failed with ${model}:`, error);
                    lastError = error;
                }
            }
            
            // ถ้าวนลูปครบแล้วยังไม่ได้ ให้แจ้งเตือนผู้ใช้ให้ไปเปิด Service
            throw new Error(
                `ไม่สามารถเชื่อมต่อ AI ได้ (ลองครบ 3 โมเดลแล้ว)\n` +
                `สาเหตุที่เป็นไปได้: API Key ของคุณยังไม่ได้เปิดใช้งาน 'Generative Language API'\n` +
                `วิธีแก้: ไปที่ Google Cloud Console > APIs & Services > Enable APIs > ค้นหา 'Generative Language API' แล้วกด Enable`
            );
        }

        // --- COMPONENTS ---

        const Card = ({ children, className = "" }) => (
            <div className={`bg-white rounded-xl shadow-sm border border-slate-100 p-4 ${className}`}>
                {children}
            </div>
        );

        const Badge = ({ type, text }) => {
            const colors = {
                danger: "bg-red-100 text-red-700 border-red-200",
                warning: "bg-orange-100 text-orange-700 border-orange-200",
                success: "bg-green-100 text-green-700 border-green-200",
                info: "bg-blue-100 text-blue-700 border-blue-200",
                default: "bg-slate-100 text-slate-700 border-slate-200"
            };
            
            let style = colors.default;
            if (text?.includes("อันตราย") || type === 'danger') style = colors.danger;
            else if (text?.includes("สามัญ") || type === 'success') style = colors.success;
            
            return (
                <span className={`px-2 py-1 rounded-md text-xs font-medium border ${style}`}>
                    {text}
                </span>
            );
        };

        const NavButton = ({ active, onClick, icon, label }) => (
            <button 
                onClick={onClick}
                className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 ${
                    active 
                    ? 'bg-teal-50 text-teal-700 font-semibold shadow-sm' 
                    : 'text-slate-600 hover:bg-slate-50 hover:text-slate-900'
                }`}
            >
                {icon}
                <span>{label}</span>
            </button>
        );

        const DrugCard = ({ drug, expanded = false }) => {
            const renderValue = (val) => typeof val === 'object' ? JSON.stringify(val) : (val || "-");

            return (
                <Card className="border-l-4 border-l-teal-500 hover:shadow-md transition-shadow">
                    <div className="flex flex-col md:flex-row gap-4">
                        <div className="w-full md:w-24 h-24 bg-slate-50 rounded-lg flex items-center justify-center flex-shrink-0 border border-slate-100">
                            <Icons.Pill size={32} className="text-teal-300" />
                        </div>
                        
                        <div className="flex-1 space-y-2">
                            <div className="flex justify-between items-start flex-wrap gap-2">
                                <div>
                                    <h3 className="text-lg font-bold text-slate-800">{renderValue(drug.tradeName)}</h3>
                                    <p className="text-teal-600 font-medium text-sm">{renderValue(drug.genericName)}</p>
                                </div>
                                <Badge type={drug.legal} text={renderValue(drug.legal)} />
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2 text-sm">
                                <div>
                                    <p className="text-slate-500 font-medium">สรรพคุณ:</p>
                                    <p className="text-slate-700">{renderValue(drug.properties)}</p>
                                </div>
                                <div>
                                    <p className="text-slate-500 font-medium">กลุ่มยา:</p>
                                    <p className="text-slate-700">{renderValue(drug.group)}</p>
                                </div>
                            </div>

                            <div className="mt-4 pt-4 border-t border-slate-100 bg-red-50/30 -mx-4 -mb-4 p-4 rounded-b-xl">
                                <div className="flex gap-2 text-red-700 mb-2">
                                    <Icons.AlertTriangle size={16} /> <span className="font-bold text-xs uppercase tracking-wide">ข้อควรระวัง & DI</span>
                                </div>
                                <div className="grid grid-cols-1 gap-2 text-sm">
                                    <p className="text-slate-700"><span className="font-semibold text-slate-900">Warning:</span> {renderValue(drug.warnings)}</p>
                                    <p className="text-slate-700"><span className="font-semibold text-slate-900">Interaction:</span> {renderValue(drug.di)}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </Card>
            );
        };

        const ToolCard = ({ icon, title, desc, action }) => (
            <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-shadow cursor-pointer group">
                <div className="flex items-center gap-4 mb-4">
                    <div className="p-3 bg-slate-50 rounded-lg group-hover:bg-teal-50 transition-colors">
                        {icon}
                    </div>
                    <h3 className="font-bold text-slate-800">{title}</h3>
                </div>
                <p className="text-sm text-slate-500 mb-4 h-10">{desc}</p>
                <button className="w-full py-2 border border-slate-200 rounded-lg text-sm font-medium text-slate-600 group-hover:border-teal-500 group-hover:text-teal-600 transition-colors flex items-center justify-center gap-2">
                    {action} <Icons.ChevronRight size={16} />
                </button>
            </div>
        );

        // --- MAIN APP ---

        function PharmaMate() {
            const [activeTab, setActiveTab] = useState('symptoms');
            const [isSidebarOpen, setSidebarOpen] = useState(false);
            const [isOnline, setIsOnline] = useState(false);
            const [appError, setAppError] = useState(null);

            // State: Symptoms
            const [symptomInput, setSymptomInput] = useState('');
            const [isListening, setIsListening] = useState(false);
            const [suggestedDrugs, setSuggestedDrugs] = useState([]);
            const [rawResult, setRawResult] = useState(null);
            const [isAnalyzingSymptoms, setIsAnalyzingSymptoms] = useState(false);

            // State: Identify
            const [selectedImage, setSelectedImage] = useState(null);
            const [analyzingImage, setAnalyzingImage] = useState(false);
            const [identifiedDrug, setIdentifiedDrug] = useState(null);
            const [rawIdentifyResult, setRawIdentifyResult] = useState(null);

            // Check API Status on load
            useEffect(() => {
                setIsOnline(!!API_KEY && API_KEY.startsWith("AIza"));
            }, []);

            const clearErrors = () => {
                setAppError(null);
                setRawResult(null);
                setRawIdentifyResult(null);
            }

            // Logic: Symptoms
            const handleSymptomAnalysis = async () => {
                if (!symptomInput) return;
                setIsAnalyzingSymptoms(true);
                setSuggestedDrugs([]);
                clearErrors();

                const prompt = `
                    Act as an expert pharmacist in Thailand. Analyze the following symptoms: "${symptomInput}".
                    Recommend 2-3 specific OTC or pharmacy-dispensed drugs available in Thailand effectively treating these symptoms.
                    Strictly return ONLY a JSON array with this structure (no markdown code blocks):
                    [
                        {
                            "id": 1,
                            "tradeName": "Name (Thai/Eng)",
                            "genericName": "Generic Name & Strength",
                            "group": "Pharmacological Group",
                            "properties": "สรรพคุณ (Thai)",
                            "warnings": "ข้อควรระวัง/แพ้ยา (Thai)",
                            "di": "Drug Interactions สำคัญ (Thai)",
                            "legal": "ประเภทตามกฎหมาย (e.g. ยาสามัญ, ยาอันตราย)"
                        }
                    ]
                `;

                try {
                    const result = await callGeminiAPI(prompt);
                    if (result && Array.isArray(result)) {
                        setSuggestedDrugs(result);
                    } else if (result && result.isRaw) {
                         setRawResult(result.textResult);
                    } else {
                        // Fallback logic
                        setRawResult(JSON.stringify(result, null, 2));
                    }
                } catch (err) {
                    setAppError(err.message);
                }
                
                setIsAnalyzingSymptoms(false);
            };

            const toggleVoiceInput = () => {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    alert("เบราว์เซอร์นี้ไม่รองรับการพิมพ์ด้วยเสียง");
                    return;
                }
                if (!isListening) {
                    setIsListening(true);
                    // Simulation
                    setTimeout(() => {
                        const mockPhrases = [
                            "คนไข้ปวดหัวตุ๊บๆ ข้างเดียว เหมือนไมเกรน แสงจ้าก็ปวด", 
                            "ไอแห้งๆ ระคายคอ ไม่มีเสมหะ มา 3 วันแล้ว", 
                            "ปวดท้อง แน่นท้อง เหมือนอาหารไม่ย่อย"
                        ];
                        setSymptomInput(mockPhrases[Math.floor(Math.random() * mockPhrases.length)]);
                        setIsListening(false);
                    }, 1500);
                }
            };

            // Logic: Identify
            const handleImageUpload = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const base64 = e.target.result;
                        setSelectedImage(base64);
                        setAnalyzingImage(true);
                        setIdentifiedDrug(null);
                        setRawIdentifyResult(null);
                        setAppError(null);

                        const prompt = `
                            Identify this medicine/pill from the image. 
                            Provide details as an expert pharmacist in Thailand.
                            Strictly return ONLY a JSON Object (not array) with this structure:
                            {
                                "id": 99,
                                "tradeName": "Probable Trade Name",
                                "genericName": "Generic Name",
                                "group": "Group",
                                "properties": "Properties (Thai)",
                                "warnings": "Warnings (Thai)",
                                "di": "Interactions (Thai)",
                                "legal": "Legal Category (Thai)"
                            }
                            If unsure, provide the best guess based on shape/color/markings.
                        `;

                        try {
                            const result = await callGeminiAPI(prompt, base64);
                            if (result && result.tradeName) {
                                setIdentifiedDrug(result);
                            } else if (result && result.isRaw) {
                                setRawIdentifyResult(result.textResult);
                            } else {
                                setRawIdentifyResult(JSON.stringify(result, null, 2));
                            }
                        } catch(err) {
                            setAppError(err.message);
                        }
                        setAnalyzingImage(false);
                    };
                    reader.readAsDataURL(file);
                }
            };

            return (
                <div className="min-h-screen bg-slate-50 font-sans text-slate-800 flex flex-col md:flex-row">
                    
                    {/* Mobile Header */}
                    <div className="md:hidden bg-teal-600 text-white p-4 flex justify-between items-center shadow-md z-20">
                        <div className="flex items-center gap-2">
                            <Icons.Stethoscope size={24} />
                            <span className="font-bold text-lg">PharmaMate</span>
                        </div>
                        <button onClick={() => setSidebarOpen(!isSidebarOpen)} className="p-1">
                            {isSidebarOpen ? <Icons.X size={24} /> : <div className="space-y-1"><div className="w-6 h-0.5 bg-white"></div><div className="w-6 h-0.5 bg-white"></div><div className="w-6 h-0.5 bg-white"></div></div>}
                        </button>
                    </div>

                    {/* Sidebar */}
                    <nav className={`fixed inset-y-0 left-0 transform ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} md:relative md:translate-x-0 transition duration-200 ease-in-out z-10 w-64 bg-white border-r border-slate-200 flex flex-col shadow-lg md:shadow-none`}>
                        <div className="p-6 hidden md:flex items-center gap-2 text-teal-600">
                            <Icons.Stethoscope size={32} />
                            <span className="font-bold text-2xl tracking-tight">PharmaMate <span className="text-xs align-top bg-teal-100 px-1 rounded text-teal-700">AI</span></span>
                        </div>

                        <div className="flex-1 px-4 py-4 space-y-2">
                            <NavButton 
                                active={activeTab === 'symptoms'} 
                                onClick={() => { setActiveTab('symptoms'); setSidebarOpen(false); }}
                                icon={<Icons.Activity size={20} />} 
                                label="AI Symptom Check" 
                            />
                            <NavButton 
                                active={activeTab === 'identify'} 
                                onClick={() => { setActiveTab('identify'); setSidebarOpen(false); }}
                                icon={<Icons.Camera size={20} />} 
                                label="AI Drug Identify" 
                            />
                            <NavButton 
                                active={activeTab === 'tools'} 
                                onClick={() => { setActiveTab('tools'); setSidebarOpen(false); }}
                                icon={<Icons.Calculator size={20} />} 
                                label="Tools & DI" 
                            />
                        </div>

                        <div className="p-4 border-t border-slate-100">
                            <div className="flex items-center gap-3 p-2 rounded-lg bg-teal-50">
                                <div className="w-10 h-10 rounded-full bg-teal-200 flex items-center justify-center text-teal-700 font-bold">ภ.</div>
                                <div>
                                    <p className="text-sm font-semibold text-teal-900">เภสัชกร (Online)</p>
                                    <p className="text-xs text-teal-600 flex items-center gap-1">
                                        <span className={`w-2 h-2 rounded-full ${isOnline ? 'bg-green-500' : 'bg-red-500'}`}></span> 
                                        {isOnline ? 'AI Connected' : 'No API Key'}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </nav>

                    {/* Content */}
                    <main className="flex-1 p-4 md:p-8 overflow-y-auto h-screen relative">
                        
                        {/* GLOBAL ERROR MESSAGE */}
                        {appError && (
                            <div className="mb-6 p-4 bg-red-50 border border-red-200 rounded-xl text-red-700 flex items-start gap-3 animate-fade-in">
                                <Icons.AlertTriangle className="flex-shrink-0 mt-0.5" />
                                <div>
                                    <h3 className="font-bold">เกิดข้อผิดพลาดในการเชื่อมต่อ (Connection Error)</h3>
                                    <p className="text-sm whitespace-pre-wrap">{appError}</p>
                                </div>
                                <button onClick={() => setAppError(null)} className="ml-auto hover:bg-red-100 p-1 rounded">
                                    <Icons.X size={16} />
                                </button>
                            </div>
                        )}

                        {/* === TAB 1: AI SYMPTOM === */}
                        {activeTab === 'symptoms' && (
                            <div className="max-w-3xl mx-auto space-y-6 animate-fade-in">
                                <div className="text-center md:text-left">
                                    <h2 className="text-2xl font-bold text-slate-800 flex items-center gap-2 justify-center md:justify-start">
                                        <Icons.Sparkles className="text-teal-500" /> AI Pharmacist Diagnosis
                                    </h2>
                                    <p className="text-slate-500">
                                        ระบบ AI อัจฉริยะพร้อมวิเคราะห์อาการและแนะนำยาที่เหมาะสม
                                    </p>
                                </div>

                                <div className="relative">
                                    <textarea
                                        className="w-full h-32 p-4 pr-12 rounded-xl border-2 border-slate-200 focus:border-teal-500 focus:ring-0 focus:outline-none resize-none text-lg shadow-sm"
                                        placeholder="อธิบายอาการคนไข้ได้เลยครับ (เช่น ไอแห้ง เจ็บคอ ไม่มีไข้...)"
                                        value={symptomInput}
                                        onChange={(e) => setSymptomInput(e.target.value)}
                                    ></textarea>
                                    <button 
                                        onClick={toggleVoiceInput}
                                        className={`absolute bottom-4 right-4 p-3 rounded-full transition-all ${isListening ? 'bg-red-500 animate-pulse text-white' : 'bg-teal-100 text-teal-600 hover:bg-teal-200'}`}
                                    >
                                        <Icons.Mic size={24} />
                                    </button>
                                </div>

                                <button 
                                    onClick={handleSymptomAnalysis}
                                    disabled={isAnalyzingSymptoms || !symptomInput}
                                    className={`w-full py-3 text-white font-semibold rounded-xl shadow-md transition-all flex justify-center items-center gap-2 ${isAnalyzingSymptoms ? 'bg-slate-400 cursor-not-allowed' : 'bg-teal-600 hover:bg-teal-700'}`}
                                >
                                    {isAnalyzingSymptoms ? <Icons.Loader2 className="animate-spin" /> : <Icons.Search size={20} />}
                                    {isAnalyzingSymptoms ? 'AI กำลังค้นหายา...' : 'วิเคราะห์อาการ'}
                                </button>

                                {/* RESULTS */}
                                {suggestedDrugs.length > 0 && (
                                    <div className="space-y-4 animate-slide-up">
                                        <div className="flex items-center gap-2 text-slate-700">
                                            <Icons.Check className="text-green-500" size={20} />
                                            <span className="font-semibold">AI แนะนำยา {suggestedDrugs.length} รายการ:</span>
                                        </div>
                                        {suggestedDrugs.map((drug, idx) => (
                                            <DrugCard key={idx} drug={drug} />
                                        ))}
                                    </div>
                                )}

                                {/* FALLBACK RAW RESULT */}
                                {rawResult && suggestedDrugs.length === 0 && (
                                    <div className="p-6 bg-yellow-50 border border-yellow-200 rounded-xl animate-fade-in">
                                        <h3 className="font-bold text-yellow-800 mb-2 flex items-center gap-2">
                                            <Icons.FileText size={18} /> ผลการวิเคราะห์ (ข้อความ)
                                        </h3>
                                        <div className="prose text-slate-700 whitespace-pre-wrap">
                                            {rawResult}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* === TAB 2: AI SCAN === */}
                        {activeTab === 'identify' && (
                            <div className="max-w-2xl mx-auto space-y-6 animate-fade-in">
                                <div className="text-center md:text-left">
                                    <h2 className="text-2xl font-bold text-slate-800 flex items-center gap-2 justify-center md:justify-start">
                                        <Icons.Camera className="text-teal-500" /> AI Visual Identification
                                    </h2>
                                    <p className="text-slate-500">
                                        ถ่ายรูปยาเพื่อให้ AI ช่วยระบุชนิดและข้อมูลสำคัญ
                                    </p>
                                </div>

                                <div className="border-2 border-dashed border-slate-300 rounded-2xl p-8 text-center bg-white hover:bg-slate-50 transition-colors relative overflow-hidden group">
                                    <input 
                                        type="file" 
                                        accept="image/*" 
                                        onChange={handleImageUpload}
                                        className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"
                                    />
                                    
                                    {!selectedImage ? (
                                        <div className="space-y-4">
                                            <div className="w-20 h-20 bg-teal-100 rounded-full flex items-center justify-center mx-auto text-teal-600 group-hover:scale-110 transition-transform">
                                                <Icons.Camera size={40} />
                                            </div>
                                            <div>
                                                <p className="font-semibold text-lg text-slate-700">แตะเพื่อถ่ายภาพยา</p>
                                                <p className="text-slate-400 text-sm">AI จะวิเคราะห์รูปร่าง สี และตัวอักษรบนเม็ดยา</p>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="relative h-64 w-full">
                                            <img src={selectedImage} alt="Uploaded" className="w-full h-full object-contain rounded-lg" />
                                            {analyzingImage && (
                                                <div className="absolute inset-0 bg-black/60 flex flex-col items-center justify-center text-white rounded-lg backdrop-blur-sm">
                                                    <div className="animate-spin rounded-full h-12 w-12 border-4 border-white border-t-transparent mb-4"></div>
                                                    <p className="font-semibold">AI กำลังตรวจสอบฐานข้อมูล...</p>
                                                </div>
                                            )}
                                            {!analyzingImage && (
                                                <button 
                                                    onClick={(e) => { e.preventDefault(); setSelectedImage(null); setIdentifiedDrug(null); setRawIdentifyResult(null); }}
                                                    className="absolute top-2 right-2 bg-white/90 p-2 rounded-full text-slate-700 hover:bg-red-50 hover:text-red-600 z-20 shadow-lg"
                                                >
                                                    <Icons.X size={20} />
                                                </button>
                                            )}
                                        </div>
                                    )}
                                </div>

                                {identifiedDrug && !analyzingImage && (
                                    <div className="animate-slide-up">
                                        <div className="flex items-center justify-between mb-4">
                                            <h3 className="text-xl font-bold text-teal-800 flex items-center gap-2">
                                                <Icons.Sparkles className="text-teal-500" /> ผลการวิเคราะห์จากภาพ
                                            </h3>
                                        </div>
                                        <DrugCard drug={identifiedDrug} expanded={true} />
                                    </div>
                                )}

                                {/* FALLBACK RAW IDENTIFY */}
                                {rawIdentifyResult && !identifiedDrug && !analyzingImage && (
                                    <div className="p-6 bg-yellow-50 border border-yellow-200 rounded-xl animate-fade-in">
                                        <h3 className="font-bold text-yellow-800 mb-2 flex items-center gap-2">
                                            <Icons.FileText size={18} /> ผลการระบุยา (ข้อความ)
                                        </h3>
                                        <div className="prose text-slate-700 whitespace-pre-wrap">
                                            {rawIdentifyResult}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* === TAB 3: TOOLS === */}
                        {activeTab === 'tools' && (
                            <div className="max-w-4xl mx-auto space-y-6 animate-fade-in">
                                <div className="text-center md:text-left mb-8">
                                    <h2 className="text-2xl font-bold text-slate-800">เครื่องมือเภสัชกร</h2>
                                    <p className="text-slate-500">ตัวช่วยคำนวณและตรวจสอบความปลอดภัย</p>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    <ToolCard 
                                        icon={<Icons.AlertTriangle className="text-orange-500" />}
                                        title="Drug Interaction"
                                        desc="ตรวจสอบปฏิกิริยาระหว่างยา (AI Powered)"
                                        action="ตรวจสอบ"
                                    />
                                    <ToolCard 
                                        icon={<Icons.Calculator className="text-blue-500" />}
                                        title="eGFR Calculator"
                                        desc="คำนวณค่าการทำงานของไต"
                                        action="คำนวณ"
                                    />
                                    <ToolCard 
                                        icon={<Icons.Pill className="text-teal-500" />}
                                        title="Check FDA Status"
                                        desc="ตรวจสอบสถานะ อย. และกฎหมายยา"
                                        action="ค้นหา"
                                    />
                                    <ToolCard 
                                        icon={<Icons.FileText className="text-purple-500" />}
                                        title="Label Generator"
                                        desc="สร้างฉลากยาและคำแนะนำการใช้"
                                        action="สร้าง"
                                    />
                                </div>
                            </div>
                        )}

                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<PharmaMate />);
    </script>
</body>
</html>
