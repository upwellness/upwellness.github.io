<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UP BCA Tracker v5.8</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Supabase JS -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chart.js DataLabels Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <!-- HTML2Canvas -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <!-- FontAwesome CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f0fdfa; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .gauge-bar { transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.3s ease; }
        .marker-label { 
            font-size: 0.6rem; 
            color: #6b7280; 
            position: absolute; 
            top: 24px; 
            transform: translateX(-50%); 
            white-space: nowrap; 
            font-weight: 700;
            line-height: 1;
        }
        .script-container::-webkit-scrollbar { width: 6px; }
        .script-container::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        .table-compact th, .table-compact td { padding: 0.5rem 0.25rem; }

        /* Report Mode Styles */
        .report-mode .no-print-capture { display: none !important; }
        .report-mode .overflow-x-auto { overflow-x: visible !important; }
        .report-mode .overflow-y-auto { overflow-y: visible !important; height: auto !important; }
        .report-mode .bg-gray-50 { background-color: white !important; } 
    </style>
</head>
<body class="text-gray-700">
    <div id="app" class="min-h-screen pb-10">
        
        <!-- Navbar -->
        <nav class="bg-teal-600 text-white p-4 shadow-md sticky top-0 z-50 flex justify-between items-center no-print-capture">
            <h1 class="font-bold text-lg flex items-center gap-2">
                <i class="fa-solid fa-heart-pulse"></i>
                <span class="hidden sm:inline">UP BCA Tracker v5.8</span>
            </h1>
            <div v-if="session" class="flex gap-2 items-center">
                <!-- Dashboard Buttons -->
                <div v-if="view === 'dashboard'" class="flex mr-2">
                    <label class="cursor-pointer bg-teal-700 hover:bg-teal-800 text-white px-2 py-1 rounded-l text-xs flex items-center border-r border-teal-600" title="Import Full DB (Backup)">
                        <i class="fa-solid fa-database mr-1"></i> Import
                        <input type="file" accept=".csv" class="hidden" @change="importCSV">
                    </label>
                    <button @click="exportCSV" class="bg-teal-700 hover:bg-teal-800 text-white px-2 py-1 rounded-r text-xs flex items-center" title="Export Full DB">
                        <i class="fa-solid fa-download"></i>
                    </button>
                </div>

                <span class="text-xs bg-teal-800 px-2 py-1 rounded text-teal-200 hidden sm:inline mr-1">
                    <i class="fa-solid fa-id-badge mr-1"></i>{{ userAbo }}
                </span>
                
                <button @click="showChangePasswordModal = true" class="text-sm bg-teal-700 px-2 py-1 rounded hover:bg-teal-800 transition" title="เปลี่ยนรหัสผ่าน">
                    <i class="fa-solid fa-key"></i>
                </button>

                <!-- Detail View Buttons with Save Menu -->
                <div v-if="view === 'customer_detail'" class="relative inline-block text-left">
                    <button @click="showSaveMenu = !showSaveMenu" class="text-sm bg-white text-teal-700 px-3 py-1 rounded-full hover:bg-gray-100 transition shadow font-bold ml-1 flex items-center">
                        <i class="fa-solid fa-camera mr-1"></i> <span>รูป</span>
                    </button>
                    <!-- Dropdown Menu -->
                    <div v-if="showSaveMenu" class="absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none z-50">
                        <div class="py-1" role="menu">
                            <button @click="saveImage('full')" class="block w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-indigo-50 font-bold border-b border-gray-100" role="menuitem">
                                <i class="fa-solid fa-file-invoice mr-2 text-indigo-600"></i> รายงานฉบับเต็ม (Full)
                            </button>
                            <button @click="saveImage('analysis')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">
                                <i class="fa-solid fa-clipboard-list mr-2 text-teal-600"></i> เฉพาะผลวัดล่าสุด
                            </button>
                            <button @click="saveImage('graph')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">
                                <i class="fa-solid fa-chart-line mr-2 text-blue-600"></i> เฉพาะกราฟ
                            </button>
                            <button @click="saveImage('table')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">
                                <i class="fa-solid fa-table mr-2 text-orange-600"></i> เฉพาะตาราง
                            </button>
                        </div>
                    </div>
                </div>
                
                <button v-if="view === 'customer_detail'" @click="view = 'dashboard'" class="text-sm bg-teal-700 px-3 py-1 rounded-full hover:bg-teal-800 transition ml-1">
                    <i class="fa-solid fa-users"></i>
                </button>
                
                <button @click="logout" class="text-sm bg-red-500 px-3 py-1 rounded-full hover:bg-red-600 transition ml-1">
                    <i class="fa-solid fa-right-from-bracket"></i>
                </button>
            </div>
        </nav>

        <!-- 1. Config / Login Screen -->
        <div v-if="!session" class="container mx-auto max-w-md p-6 mt-10">
            <div class="bg-white p-6 rounded-xl shadow-lg border border-teal-100">
                <h2 class="text-2xl font-bold text-center text-teal-800 mb-6">เข้าสู่ระบบโค้ช</h2>
                <div v-if="!supabaseConfigured" class="mb-6 p-4 bg-yellow-50 rounded-lg border border-yellow-200 text-sm">
                    <p class="font-bold mb-2 text-yellow-700"><i class="fa-solid fa-gear mr-1"></i> ตั้งค่า Database</p>
                    <input v-model="config.url" placeholder="Supabase Project URL" class="w-full mb-2 p-2 border rounded bg-gray-50">
                    <input v-model="config.key" placeholder="Supabase Anon Key" class="w-full mb-2 p-2 border rounded bg-gray-50">
                    <button @click="initSupabase" class="w-full bg-yellow-500 text-white py-2 rounded font-bold hover:bg-yellow-600 shadow-sm">เชื่อมต่อ Database</button>
                </div>
                <div v-else>
                    <form @submit.prevent>
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-1 text-teal-700">รหัส ABO (Coach ID)</label>
                            <input v-model="auth.abo" type="text" placeholder="ระบุรหัสสมาชิก ABO" required class="w-full p-3 border border-teal-200 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none font-bold text-lg text-gray-700 bg-teal-50">
                        </div>
                        <div class="mb-6">
                            <label class="block text-sm font-bold mb-1 text-teal-700">รหัสผ่าน</label>
                            <input v-model="auth.password" type="password" placeholder="รหัสผ่าน" required class="w-full p-3 border border-teal-200 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none">
                            <div class="text-right mt-2">
                                <button type="button" @click="showForgotPasswordInfo" class="text-xs text-orange-500 hover:text-orange-700 underline font-bold">
                                    <i class="fa-solid fa-circle-question mr-1"></i>ลืมรหัสผ่าน?
                                </button>
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            <button @click="performLogin" :disabled="loading" class="w-full bg-gradient-to-r from-teal-500 to-teal-700 text-white py-3 rounded-lg font-bold hover:shadow-lg transition flex justify-center items-center">
                                <i v-if="loading && action === 'login'" class="fa-solid fa-spinner fa-spin mr-2"></i>
                                {{ loading && action === 'login' ? 'กำลังตรวจสอบ...' : 'เข้าสู่ระบบ' }}
                            </button>
                            
                            <div class="relative flex py-2 items-center">
                                <div class="flex-grow border-t border-gray-200"></div>
                                <span class="flex-shrink-0 mx-4 text-gray-400 text-xs">หรือ</span>
                                <div class="flex-grow border-t border-gray-200"></div>
                            </div>

                            <button @click="performRegister" :disabled="loading" class="w-full bg-white text-teal-600 border-2 border-teal-600 py-3 rounded-lg font-bold hover:bg-teal-50 transition flex justify-center items-center">
                                <i v-if="loading && action === 'register'" class="fa-solid fa-spinner fa-spin mr-2"></i>
                                {{ loading && action === 'register' ? 'กำลังลงทะเบียน...' : 'ลงทะเบียนผู้ใช้ใหม่' }}
                            </button>
                        </div>
                    </form>
                    <div v-if="!isHardcodedConfig" class="mt-6 border-t pt-4 text-center">
                         <button @click="clearConfig" class="text-xs text-gray-400 underline hover:text-red-400">รีเซ็ตการตั้งค่า Database</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. Dashboard: Customer List -->
        <div v-else-if="view === 'dashboard'" key="view-dashboard" class="container mx-auto max-w-2xl p-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-teal-800">รายชื่อลูกค้า</h2>
                <button @click="openAddCustomerModal" class="bg-teal-600 text-white px-3 py-2 rounded-lg text-sm font-bold shadow hover:bg-teal-700">
                    <i class="fa-solid fa-user-plus mr-1"></i> เพิ่ม
                </button>
            </div>
            <div class="mb-4 relative">
                <i class="fa-solid fa-search absolute left-3 top-3 text-gray-400"></i>
                <input v-model="searchQuery" placeholder="ค้นหาชื่อลูกค้า..." class="w-full pl-10 p-2.5 rounded-lg border border-gray-200 focus:ring-2 focus:ring-teal-500 outline-none">
            </div>
            <div v-if="loading" class="text-center py-10 text-gray-400"><i class="fa-solid fa-spinner fa-spin mr-2"></i>กำลังโหลด...</div>
            <div v-else class="space-y-3">
                <div v-for="c in filteredCustomers" :key="c.id" @click="selectCustomer(c)" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 hover:border-teal-300 cursor-pointer transition flex justify-between items-center">
                    <div>
                        <h3 class="font-bold text-gray-800 text-lg">{{ c.name }}</h3>
                        <p class="text-xs text-gray-400">
                            <i class="fa-solid fa-clock-rotate-left mr-1"></i>อัปเดตล่าสุด: {{ formatDate(c.updated_at) }}
                        </p>
                    </div>
                    <i class="fa-solid fa-chevron-right text-gray-300"></i>
                </div>
            </div>
        </div>

        <!-- 3. Customer Detail View -->
        <div v-else-if="view === 'customer_detail' && currentCustomer" key="view-customer-detail" class="container mx-auto max-w-2xl p-4">
            <!-- Capture Area: This wrapper is captured by html2canvas -->
            <div id="capture-area" :class="['p-2 bg-[#f0fdfa] min-h-screen', isGeneratingReport ? 'report-mode' : '']"> 
                
                <!-- Header Info -->
                <div class="bg-white rounded-xl p-4 shadow-sm border border-teal-100 mb-4 relative">
                    <button @click="view = 'dashboard'" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 no-print-capture"><i class="fa-solid fa-xmark text-xl"></i></button>
                    <div v-if="captureTimestamp" class="absolute top-2 right-2 text-[10px] text-gray-400 font-mono">{{ captureTimestamp }}</div>
                    <div class="flex items-center gap-3">
                        <div class="bg-teal-100 w-12 h-12 rounded-full flex items-center justify-center text-teal-600 text-xl font-bold">
                            {{ currentCustomer.name.charAt(0) }}
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-gray-800">{{ currentCustomer.name }}</h2>
                            <div class="text-sm text-gray-500 mt-1 space-y-0.5">
                                <p><i class="fa-solid fa-venus-mars w-4"></i> {{ currentCustomer.gender === 'male' ? 'ชาย' : 'หญิง' }}</p>
                                <p><i class="fa-solid fa-cake-candles w-4"></i> {{ formatFullBirthDate(currentCustomer) }} (อายุ {{ calculateAgeFromDate(currentCustomer) }} ปี)</p>
                                <p><i class="fa-solid fa-ruler-vertical w-4"></i> {{ currentCustomer.height }} cm</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabs (Hide in Report Mode) -->
                <div class="flex bg-gray-200 p-1 rounded-lg mb-4 no-print-capture items-center">
                    <button @click="changeSubView('measure')" :class="['flex-1 py-2 text-sm font-bold rounded-md transition', subView === 'measure' ? 'bg-white shadow text-teal-700' : 'text-gray-500']">
                        <i class="fa-solid fa-scale-balanced mr-1"></i> วัดค่าใหม่
                    </button>
                    <button @click="changeSubView('history')" :class="['flex-1 py-2 text-sm font-bold rounded-md transition', subView === 'history' ? 'bg-white shadow text-teal-700' : 'text-gray-500']">
                        <i class="fa-solid fa-chart-line mr-1"></i> กราฟ & ประวัติ
                    </button>
                    <!-- Legacy Import -->
                    <label class="cursor-pointer bg-amber-500 hover:bg-amber-600 text-white px-3 py-2 rounded-md text-xs flex items-center ml-1 transition shadow" title="นำเข้าไฟล์ CSV รายคน">
                        <i class="fa-solid fa-file-csv mr-1"></i> นำเข้าไฟล์เก่า
                        <input type="file" accept=".csv" class="hidden" @change="importLegacyCSV">
                    </label>
                </div>

                <!-- Tab: Measure -->
                <!-- Show if tab active OR generating full report -->
                <div v-show="subView === 'measure' || isGeneratingReport" id="measure-section">
                    <div class="bg-white rounded-xl shadow-sm p-5 border border-gray-100 mb-6">
                        <h3 class="text-base font-bold text-gray-700 mb-4 border-b pb-2 flex items-center justify-between">
                            <span><i class="fa-solid fa-pen-to-square mr-2 text-teal-600"></i> {{ editingId ? 'แก้ไขข้อมูล' : 'ผลการวัดล่าสุด (จากไฟล์หรือกรอกใหม่)' }}</span>
                            <!-- Hide edit button in report -->
                            <button v-if="editingId" @click="cancelEdit" class="text-xs text-red-500 underline no-print-capture">ยกเลิกแก้ไข</button>
                        </h3>
                        <div class="space-y-4">
                            <!-- Input Fields -->
                            <div class="flex items-center justify-between group">
                                <label class="font-semibold text-gray-600 w-1/2 flex items-center gap-2"><div class="w-8 h-8 rounded-full bg-teal-100 flex items-center justify-center text-teal-600 text-sm"><i class="fa-regular fa-calendar"></i></div>วันที่วัดผล</label>
                                <input v-model="newMeasure.recorded_at" type="date" class="w-1/2 bg-teal-50 border border-teal-200 text-teal-800 font-bold rounded-lg p-2 text-right text-lg">
                            </div>
                            <div class="flex items-center justify-between group">
                                <label class="font-semibold text-gray-600 w-1/2 flex items-center gap-2"><div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 text-sm"><i class="fa-solid fa-weight-scale"></i></div>น้ำหนัก (kg)</label>
                                <input v-model.number="newMeasure.weight" type="number" step="0.1" placeholder="0.0" class="w-1/2 bg-blue-50 border border-blue-200 text-blue-800 font-bold rounded-lg p-2 text-right text-lg">
                            </div>
                            <div class="flex items-center justify-between group">
                                <label class="font-semibold text-gray-600 w-1/2 flex items-center gap-2"><div class="w-8 h-8 rounded-full bg-yellow-100 flex items-center justify-center text-yellow-600 text-sm"><i class="fa-solid fa-layer-group"></i></div>% ไขมัน</label>
                                <input v-model.number="newMeasure.fat_pct" type="number" step="0.1" placeholder="%" class="w-1/2 bg-yellow-50 border border-yellow-200 text-yellow-800 font-bold rounded-lg p-2 text-right text-lg">
                            </div>
                            <div class="flex items-center justify-between group">
                                <label class="font-semibold text-gray-600 w-1/2 flex items-center gap-2"><div class="w-8 h-8 rounded-full bg-red-100 flex items-center justify-center text-red-600 text-sm"><i class="fa-solid fa-heart-crack"></i></div>ไขมันช่องท้อง</label>
                                <input v-model.number="newMeasure.visceral" type="number" step="1" placeholder="Level" class="w-1/2 bg-red-50 border border-red-200 text-red-800 font-bold rounded-lg p-2 text-right text-lg">
                            </div>
                            <div class="flex items-center justify-between group">
                                <label class="font-semibold text-gray-600 w-1/2 flex items-center gap-2"><div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center text-green-600 text-sm"><i class="fa-solid fa-dumbbell"></i></div>% กล้ามเนื้อ</label>
                                <input v-model.number="newMeasure.muscle_pct" type="number" step="0.1" placeholder="%" class="w-1/2 bg-green-50 border border-green-200 text-green-800 font-bold rounded-lg p-2 text-right text-lg">
                            </div>
                            <div class="border-t border-gray-100 my-2"></div>
                            <div class="flex items-center justify-between group">
                                <label class="font-semibold text-gray-600 w-1/2 flex items-center gap-2"><div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center text-purple-600 text-sm"><i class="fa-solid fa-hourglass-half"></i></div>อายุร่างกาย</label>
                                <input v-model.number="newMeasure.body_age" type="number" step="1" placeholder="ปี" class="w-1/2 bg-purple-50 border border-purple-200 text-purple-800 font-bold rounded-lg p-2 text-right text-lg">
                            </div>
                            <div class="flex items-center justify-between group">
                                <label class="font-semibold text-gray-600 w-1/2 flex items-center gap-2"><div class="w-8 h-8 rounded-full bg-orange-100 flex items-center justify-center text-orange-600 text-sm"><i class="fa-solid fa-fire"></i></div>BMR (kcal)</label>
                                <input v-model.number="newMeasure.bmr" type="number" step="1" placeholder="kcal" class="w-1/2 bg-gray-50 border border-gray-300 text-gray-800 font-bold rounded-lg p-2 text-right text-lg">
                            </div>
                        </div>
                        <!-- Hide save button in report -->
                        <button @click="saveMeasurement" :disabled="loading" 
                            :class="['w-full mt-6 text-white py-3 rounded-lg font-bold shadow-md transition flex justify-center items-center gap-2 text-lg no-print-capture', editingId ? 'bg-orange-500 hover:bg-orange-600' : 'bg-teal-600 hover:bg-teal-700']">
                            <i v-if="loading" class="fa-solid fa-spinner fa-spin"></i>
                            <i v-else :class="editingId ? 'fa-solid fa-pen' : 'fa-solid fa-floppy-disk'"></i>
                            {{ editingId ? 'บันทึกการแก้ไข' : 'บันทึกผลเข้าระบบ' }}
                        </button>
                    </div>

                    <!-- Results Cards -->
                    <div v-if="newMeasure.weight" class="space-y-3">
                        <div class="flex justify-between items-center mb-2 px-1">
                            <h3 class="font-bold text-gray-600">ผลวิเคราะห์</h3>
                            <button @click="generateScript" class="text-xs bg-yellow-500 text-white px-2 py-1 rounded shadow hover:bg-yellow-600 no-print-capture"><i class="fa-solid fa-scroll mr-1"></i> สคริปต์</button>
                        </div>
                        <analysis-card title="ไขมัน (Fat)" icon="layer-group" title-color="text-yellow-600" :bar-class="getFatResult.colorClass" 
                            :value="formatDecimal(newMeasure.fat_pct, 1)" unit="%" :sub-value="calcFatMass" sub-unit="kg" :markers="getFatMarkers" :min="0" :max="50" 
                            :status="getFatResult.status" :status-color="getFatResult.textClass" :value-color="getFatResult.textClass" 
                            :range-labels="['น้อย', 'ปกติ', 'สูง', 'สูงมาก']" :range-colors="['text-yellow-500', 'text-green-500', 'text-orange-500', 'text-red-500']"></analysis-card>
                        <analysis-card title="ไขมันช่องท้อง (Visceral)" icon="heart-crack" title-color="text-red-600" :bar-class="getVisResult.colorClass"
                            :value="formatDecimal(newMeasure.visceral, 0)" :markers="[2,5,9,15]" :min="0" :max="20" :status="getVisResult.status" :status-color="getVisResult.textClass" :value-color="getVisResult.textClass"
                            :range-labels="['ดีมาก', 'ปกติ', 'สูง', 'สูงมาก', 'อันตราย']" :range-colors="['text-emerald-600', 'text-green-500', 'text-yellow-500', 'text-orange-500', 'text-red-600']"></analysis-card>
                        <analysis-card title="กล้ามเนื้อ (Muscle)" icon="dumbbell" title-color="text-green-600" :bar-class="getMuscleResult.colorClass"
                            :value="formatDecimal(newMeasure.muscle_pct, 1)" unit="%" :sub-value="calcMuscleMass" sub-unit="kg" :markers="getMuscleMarkers" :min="10" :max="60" 
                            :status="getMuscleResult.status" :status-color="getMuscleResult.textClass" :value-color="getMuscleResult.textClass"
                            :range-labels="['น้อย', 'มาตรฐาน', 'ดีมาก']" :range-colors="['text-yellow-500', 'text-green-500', 'text-emerald-600']"></analysis-card>
                        
                        <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100 mb-2">
                            <div class="flex justify-between items-center mb-1">
                                <h3 class="font-bold text-gray-700 text-sm flex items-center"><i class="fa-solid fa-hourglass-half mr-2 text-purple-500"></i> อายุร่างกาย (Body Age)</h3>
                                <span :class="['text-xl font-bold', (newMeasure.body_age - calculateAgeFromDate(currentCustomer)) > 0 ? 'text-red-600' : 'text-green-600']">{{ formatDecimal(newMeasure.body_age, 0) }} ปี</span>
                            </div>
                            <div class="flex justify-between items-center text-xs text-gray-500 bg-purple-50 p-3 rounded-lg">
                                <span>อายุจริง: <b>{{ calculateAgeFromDate(currentCustomer) }}</b></span>
                                <span v-if="newMeasure.body_age" :class="(newMeasure.body_age - calculateAgeFromDate(currentCustomer)) > 0 ? 'text-red-500 font-bold' : 'text-green-600 font-bold'">
                                    {{ (newMeasure.body_age - calculateAgeFromDate(currentCustomer)) > 0 ? 'แก่กว่าวัย +' : 'อ่อนกว่าวัย ' }}
                                    {{ Math.abs(newMeasure.body_age - calculateAgeFromDate(currentCustomer)).toFixed(0) }} ปี
                                </span>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100 mb-2">
                            <div class="flex justify-between items-center mb-1">
                                <h3 class="font-bold text-gray-700 text-sm flex items-center"><i class="fa-solid fa-fire mr-2 text-orange-500"></i> อัตราการเผาผลาญ (BMR)</h3>
                                <span class="text-xl font-bold text-orange-600">{{ newMeasure.bmr ? newMeasure.bmr.toLocaleString() : '-' }} kcal</span>
                            </div>
                            <div class="text-xs text-orange-800 bg-orange-50 p-2 rounded-lg text-center">หากทานเท่านี้ น้ำหนักจะคงที่ (ไม่ออกกำลังกาย)</div>
                        </div>

                        <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100 mb-2 relative overflow-visible">
                            <div class="flex justify-between items-end mb-1">
                                <h3 class="font-bold text-gray-700 text-sm flex items-center"><i class="fa-solid fa-weight-scale mr-2 text-blue-500"></i> BMI</h3>
                                <div class="text-right"><span :class="['text-xl font-bold', getBMIResult.textClass]">{{ calcBMI }}</span></div>
                            </div>
                            <div class="relative h-3 bg-gray-200 rounded-full mt-3 mb-6">
                                <div :class="['absolute top-0 left-0 h-full rounded-full transition-all duration-500', getBMIResult.colorClass]" :style="{width: getBMIWidth + '%'}"></div>
                                <div class="absolute top-0 w-0.5 h-full bg-white z-10" style="left: 28.3%"></div>
                                <div class="marker-label" style="left: 28.3%">18.5</div>
                                <div class="absolute top-0 w-0.5 h-full bg-white z-10" style="left: 43.3%"></div>
                                <div class="marker-label" style="left: 43.3%">23.0</div>
                                <div class="absolute top-0 w-0.5 h-full bg-white z-10" style="left: 50%"></div>
                                <div class="marker-label" style="left: 50%">25.0</div>
                                <div class="absolute top-0 w-0.5 h-full bg-white z-10" style="left: 66.6%"></div>
                                <div class="marker-label" style="left: 66.6%">30.0</div>
                            </div>
                            <div class="flex justify-between text-[10px] font-semibold mt-2 mb-1 px-1">
                                <span class="text-yellow-500">ผอม</span><span class="text-green-500">ปกติ</span><span class="text-orange-500">ท้วม</span><span class="text-red-500">อ้วน</span>
                            </div>
                            <p :class="['text-xs font-bold text-right mt-1', getBMIResult.textClass]">{{ getBMIResult.status }}</p>
                        </div>
                        
                        <!-- Recommendation -->
                        <div class="mt-4 bg-gradient-to-br from-indigo-50 to-white border border-indigo-200 rounded-xl p-5 shadow-sm">
                            <h3 class="text-base font-bold text-indigo-800 mb-4 flex items-center"><i class="fa-solid fa-user-doctor mr-2"></i> คำแนะนำสุขภาพ</h3>
                            
                            <!-- 1. Interactive Calorie Goal -->
                            <div class="mb-4">
                                <div class="flex items-center justify-between mb-2">
                                    <label class="text-xs font-bold text-gray-500">เป้าหมายลดน้ำหนัก (กก./สัปดาห์):</label>
                                    <select v-model.number="targetSettings.loss_goal" class="text-sm border border-gray-300 rounded p-1 text-indigo-700 font-bold bg-white">
                                        <option value="0">รักษาน้ำหนัก</option>
                                        <option value="0.3">0.3 (ค่อยเป็นค่อยไป)</option>
                                        <option value="0.5">0.5 (มาตรฐาน)</option>
                                        <option value="0.8">0.8 (จริงจัง)</option>
                                        <option value="1.0">1.0 (เข้มข้น)</option>
                                    </select>
                                </div>
                                <div class="flex items-center justify-between mb-2">
                                    <label class="text-xs font-bold text-gray-500">กิจกรรม (Activity Factor):</label>
                                    <select v-model.number="targetSettings.activity" class="text-sm border border-gray-300 rounded p-1 text-gray-600 bg-white">
                                        <option value="1.2">นั่งทำงาน (x1.2)</option>
                                        <option value="1.375">ออกกำลัง 1-3 วัน (x1.375)</option>
                                        <option value="1.55">ออกกำลัง 3-5 วัน (x1.55)</option>
                                        <option value="1.725">ออกกำลัง 6-7 วัน (x1.725)</option>
                                    </select>
                                </div>

                                <div class="bg-white p-3 rounded-lg border border-indigo-100 flex items-center justify-between shadow-sm">
                                    <span class="text-xs text-gray-500">แนะนำให้ทานวันละ:</span>
                                    <div class="text-right">
                                        <span class="text-xl font-bold text-indigo-600">{{ recommendDailyKcal }}</span>
                                        <span class="text-xs text-gray-400"> kcal</span>
                                    </div>
                                </div>
                                <p class="text-[10px] text-gray-400 mt-1 text-right" v-if="targetSettings.loss_goal > 0">
                                    (จาก TDEE {{ calcTDEE }} - Deficit {{ (targetSettings.loss_goal * 7700 / 7).toFixed(0) }})
                                </p>
                            </div>
                            
                            <!-- 2. Free Fat Mass Display -->
                            <div class="mb-4">
                                <div class="bg-white p-3 rounded-lg border border-indigo-100 flex items-center justify-between">
                                    <span class="text-xs text-gray-500">Free Fat Mass (FFM):</span>
                                    <span class="text-lg font-bold text-blue-600">{{ calcFFM }} kg</span>
                                </div>
                            </div>
                            
                            <div class="mb-4" v-if="newMeasure.visceral > 2">
                                <span class="text-xs font-bold text-gray-600 block mb-1">ถ้าลดน้ำหนัก 10% ({{ (newMeasure.weight * 0.1).toFixed(1) }} kg)</span>
                                <div class="bg-white p-3 rounded-lg border border-indigo-100 flex items-center justify-between"><span class="text-xs text-gray-500">ไขมันช่องท้องจะลดลง:</span><span class="text-lg font-bold text-teal-600">Lv. {{ (newMeasure.visceral * 0.7).toFixed(1) }}</span></div>
                                <div class="text-[10px] text-gray-400 mt-1 text-right">*Visceral Fat ลดลง ~30%</div>
                            </div>
                            
                            <!-- 3. Protein Calculation based on FFM -->
                            <div>
                                <span class="text-xs font-bold text-gray-600 block mb-1">โปรตีนแนะนำ (FFM x 1.2 - 1.6)</span>
                                <div class="bg-white p-3 rounded-lg border border-indigo-100 flex items-center justify-between">
                                    <span class="text-xs text-gray-500">ปริมาณต่อวัน:</span>
                                    <span class="text-lg font-bold text-green-600">{{ proteinRange }} g</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab: History & Charts -->
                <!-- Show if tab active OR generating full report -->
                <div v-show="subView === 'history' || isGeneratingReport" key="subview-history" class="space-y-4" id="history-section">
                    <!-- Filter -->
                    <div class="flex justify-between items-center gap-2 no-print-capture bg-gray-50 p-2 rounded-lg">
                        <div class="text-xs font-bold text-gray-500">เลือกกราฟ:</div>
                        <div class="flex gap-3 overflow-x-auto">
                             <label class="inline-flex items-center"><input type="checkbox" v-model="graphVisibility.weight" class="form-checkbox text-blue-600 h-3 w-3"><span class="ml-1 text-xs">นน.</span></label>
                             <label class="inline-flex items-center"><input type="checkbox" v-model="graphVisibility.fat" class="form-checkbox text-yellow-500 h-3 w-3"><span class="ml-1 text-xs">ไขมัน</span></label>
                             <label class="inline-flex items-center"><input type="checkbox" v-model="graphVisibility.muscle" class="form-checkbox text-green-600 h-3 w-3"><span class="ml-1 text-xs">กล้าม</span></label>
                             <label class="inline-flex items-center"><input type="checkbox" v-model="graphVisibility.visceral" class="form-checkbox text-red-500 h-3 w-3"><span class="ml-1 text-xs">Vis.</span></label>
                             <label class="inline-flex items-center"><input type="checkbox" v-model="graphVisibility.bodyAge" class="form-checkbox text-purple-500 h-3 w-3"><span class="ml-1 text-xs">อายุ</span></label>
                        </div>
                    </div>
                    <div class="flex justify-end gap-2 text-xs no-print-capture overflow-x-auto pb-1">
                        <button @click="chartDays = 14" :class="['px-3 py-1 rounded-full border whitespace-nowrap', chartDays===14 ? 'bg-teal-600 text-white' : 'bg-white']">14 วัน</button>
                        <button @click="chartDays = 30" :class="['px-3 py-1 rounded-full border whitespace-nowrap', chartDays===30 ? 'bg-teal-600 text-white' : 'bg-white']">1 เดือน</button>
                        <button @click="chartDays = 90" :class="['px-3 py-1 rounded-full border whitespace-nowrap', chartDays===90 ? 'bg-teal-600 text-white' : 'bg-white']">3 เดือน</button>
                        <button @click="chartDays = 180" :class="['px-3 py-1 rounded-full border whitespace-nowrap', chartDays===180 ? 'bg-teal-600 text-white' : 'bg-white']">6 เดือน</button>
                        <button @click="chartDays = 365" :class="['px-3 py-1 rounded-full border whitespace-nowrap', chartDays===365 ? 'bg-teal-600 text-white' : 'bg-white']">1 ปี</button>
                        <button @click="chartDays = 9999" :class="['px-3 py-1 rounded-full border whitespace-nowrap', chartDays===9999 ? 'bg-teal-600 text-white' : 'bg-white']">ทั้งหมด</button>
                    </div>

                    <!-- Charts -->
                    <div id="charts-section" class="space-y-4">
                        <div v-show="graphVisibility.weight" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                             <h3 class="text-sm font-bold text-center mb-2">น้ำหนัก (kg)</h3>
                             <div class="relative w-full h-84 min-h-[336px]"><canvas id="weightChart"></canvas></div>
                        </div>
                        <div v-show="graphVisibility.fat" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                             <h3 class="text-sm font-bold text-center mb-2">มวลไขมัน (kg) & %ไขมัน</h3>
                             <div class="relative w-full h-84 min-h-[336px]"><canvas id="fatChart"></canvas></div>
                        </div>
                        <div v-show="graphVisibility.muscle" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                             <h3 class="text-sm font-bold text-center mb-2">กล้ามเนื้อ (%)</h3>
                             <div class="relative w-full h-84 min-h-[336px]"><canvas id="muscleChart"></canvas></div>
                        </div>
                        <div v-show="graphVisibility.visceral" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                             <h3 class="text-sm font-bold text-center mb-2">ไขมันช่องท้อง (Visceral Level)</h3>
                             <div class="relative w-full h-84 min-h-[336px]"><canvas id="visceralChart"></canvas></div>
                        </div>
                        <div v-show="graphVisibility.bodyAge" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                             <h3 class="text-sm font-bold text-center mb-2">อายุร่างกาย (Body Age)</h3>
                             <div class="relative w-full h-84 min-h-[336px]"><canvas id="bodyAgeChart"></canvas></div>
                        </div>
                    </div>

                    <!-- History Table -->
                    <div class="bg-white rounded-xl overflow-hidden border border-gray-100 shadow-sm mt-4 overflow-x-auto" id="history-table-section">
                        <table class="w-full text-xs sm:text-sm text-left whitespace-nowrap table-compact">
                            <thead class="bg-gray-50 text-gray-500 font-bold uppercase tracking-wider">
                                <tr>
                                    <th class="p-2 text-left">วันที่</th>
                                    <th class="p-2 text-right text-blue-600">นน.</th>
                                    <th class="p-2 text-right text-yellow-600">%Fat</th>
                                    <th class="p-2 text-right text-yellow-700">Fat.kg</th>
                                    <th class="p-2 text-right text-red-500">V.Fat</th>
                                    <th class="p-2 text-right text-green-600">Mus%</th>
                                    <th class="p-2 text-right text-purple-600">B.Age</th>
                                    <th class="p-2 text-center no-print-capture">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="m in history" :key="m.id" class="border-t border-gray-100 hover:bg-gray-50 transition-colors">
                                    <td class="p-2 font-medium text-gray-600">{{ formatDate(m.recorded_at) }}</td>
                                    <td class="p-2 text-right font-bold text-gray-800">{{ formatDecimal(m.weight, 1) }}</td>
                                    <td :class="['p-2 text-right', getFatColor(m.fat_pct, currentCustomer.gender)]">{{ formatDecimal(m.fat_pct, 1) }}</td>
                                    <td class="p-2 text-right font-semibold text-gray-600">{{ (m.weight * m.fat_pct / 100).toFixed(1) }}</td>
                                    <td :class="['p-2 text-right font-bold', getVisceralColor(m.visceral)]">{{ formatDecimal(m.visceral, 0) }}</td>
                                    <td :class="['p-2 text-right', getMuscleColor(m.muscle_pct, currentCustomer.gender)]">{{ formatDecimal(m.muscle_pct, 1) }}</td>
                                    <td class="p-2 text-right font-semibold">{{ formatDecimal(m.body_age, 0) }}</td>
                                    <td class="p-2 text-center flex justify-center gap-2 no-print-capture">
                                        <button @click.stop="editRecord(m)" class="text-gray-400 hover:text-blue-500 transition p-1"><i class="fa-solid fa-pen-to-square"></i></button>
                                        <button @click.stop="deleteRecord(m.id)" class="text-gray-300 hover:text-red-500 transition p-1"><i class="fa-solid fa-trash-can"></i></button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div> <!-- End Capture Area -->
        </div>

        <!-- Add Customer Modal -->
        <div v-if="showAddCustomerModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4">
            <div class="bg-white rounded-xl w-full max-w-sm p-6 shadow-2xl">
                <h3 class="text-lg font-bold mb-4">เพิ่มลูกค้าใหม่</h3>
                <form @submit.prevent="addCustomer" class="space-y-3">
                    <input v-model="newCustomer.name" placeholder="ชื่อ-นามสกุล" required class="w-full p-2 border rounded">
                    
                    <div class="flex gap-2 items-center bg-gray-50 p-2 rounded border border-gray-200">
                        <select v-model="newCustomer.gender" class="flex-1 p-2 border rounded bg-white">
                            <option value="male">ชาย</option>
                            <option value="female">หญิง</option>
                        </select>
                        <input v-model.number="newCustomer.height" type="number" placeholder="ส่วนสูง (cm)" required class="flex-1 p-2 border rounded w-20">
                    </div>

                    <!-- Enhanced Date of Birth Input -->
                    <div class="bg-gray-50 p-3 rounded border border-gray-200">
                        <label class="block text-xs font-bold text-gray-500 mb-1">วันเดือนปีเกิด:</label>
                        <div class="flex gap-1 mb-2">
                            <select v-model="customerForm.dob_day" required class="w-16 p-2 border rounded text-sm">
                                <option value="" disabled>วัน</option>
                                <option v-for="d in 31" :key="d" :value="d">{{ d }}</option>
                            </select>
                            <select v-model="customerForm.dob_month" required class="flex-1 p-2 border rounded text-sm">
                                <option value="" disabled>เดือน</option>
                                <option v-for="(m, i) in ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.', 'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.']" :key="i" :value="i+1">{{ m }}</option>
                            </select>
                            <input v-model="customerForm.dob_year" type="number" placeholder="ปี" required class="w-20 p-2 border rounded text-sm">
                        </div>
                        <div class="flex gap-4 text-sm justify-center">
                             <label class="flex items-center"><input type="radio" v-model="customerForm.is_be" :value="true" class="mr-1"> พ.ศ.</label>
                             <label class="flex items-center"><input type="radio" v-model="customerForm.is_be" :value="false" class="mr-1"> ค.ศ.</label>
                        </div>
                    </div>

                    <div class="flex gap-2 mt-4">
                        <button type="button" @click="showAddCustomerModal = false" class="flex-1 bg-gray-200 py-2 rounded font-bold">ยกเลิก</button>
                        <button type="submit" class="flex-1 bg-teal-600 text-white py-2 rounded font-bold">บันทึก</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ... (Other Modals: Change Password, Script) ... -->
        <div v-if="showChangePasswordModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4">
            <div class="bg-white rounded-xl w-full max-w-sm p-6 shadow-2xl">
                <h3 class="text-lg font-bold mb-4">เปลี่ยนรหัสผ่าน</h3>
                <form @submit.prevent="handleChangePassword" class="space-y-3">
                    <input v-model="passwordForm.newPassword" type="password" placeholder="รหัสผ่านใหม่" required class="w-full p-2 border rounded">
                    <input v-model="passwordForm.confirmPassword" type="password" placeholder="ยืนยันรหัสผ่านใหม่" required class="w-full p-2 border rounded">
                    <p v-if="passwordError" class="text-red-500 text-xs">{{ passwordError }}</p>
                    <div class="flex gap-2 mt-4">
                        <button type="button" @click="showChangePasswordModal = false" class="flex-1 bg-gray-200 py-2 rounded font-bold">ยกเลิก</button>
                        <button type="submit" class="flex-1 bg-teal-600 text-white py-2 rounded font-bold">บันทึก</button>
                    </div>
                </form>
            </div>
        </div>

        <div v-if="showScriptModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 px-4">
            <div class="bg-white rounded-xl w-full max-w-2xl max-h-[80vh] flex flex-col shadow-2xl">
                <div class="bg-teal-600 text-white p-4 font-bold flex justify-between"><span>Script อ่านผล</span><button @click="showScriptModal = false">&times;</button></div>
                <div class="p-4 overflow-y-auto flex-1 bg-gray-50 text-sm leading-relaxed script-container" id="scriptText" v-html="scriptContent"></div>
                <div class="p-4 border-t flex justify-end gap-2 bg-white">
                     <button @click="speak" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded font-bold shadow transition"><i class="fa-solid fa-volume-high mr-2"></i>อ่าน</button>
                     <button @click="copyScript" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded font-bold shadow transition"><i class="fa-regular fa-copy mr-2"></i>คัดลอก</button>
                    <button @click="showScriptModal = false" class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded font-bold transition">ปิด</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, watch, nextTick } = Vue;
        Chart.register(ChartDataLabels);

        // --- 🟢 ตั้งค่า DATABASE (ใส่ค่าตรงนี้) ---
        const SUPABASE_URL = 'https://qzqvwbucjxwgtmbdkrlu.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6cXZ3YnVjanh3Z3RtYmRrcmx1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzNzgxODksImV4cCI6MjA4MDk1NDE4OX0.RYvc5kMueNhsOu---WOKcXYnOZLVnjiWklp1IiHmgS8'; 

        const App = {
            setup() {
                // Moved userAbo to top level setup for safety
                const session = ref(null);
                const userAbo = computed(() => {
                    if(!session.value || !session.value.user.email) return '';
                    return session.value.user.email.split('@')[0];
                });

                const supabase = ref(null);
                const supabaseConfigured = ref(false);
                const config = ref({ url: '', key: '' });
                const isHardcodedConfig = ref(false);
                const auth = ref({ abo: '', password: '' });
                const view = ref('dashboard'); 
                const subView = ref('measure'); 
                const loading = ref(false);
                const customers = ref([]);
                const searchQuery = ref('');
                const currentCustomer = ref(null);
                const history = ref([]);
                const chartDays = ref(180);
                const graphVisibility = ref({ weight: true, fat: true, muscle: true, visceral: true, bodyAge: true });
                const showAddCustomerModal = ref(false);
                const showSaveMenu = ref(false); // Toggle for save menu
                const isGeneratingReport = ref(false); // Flag for full report generation
                
                // Target Settings for Recommendation
                const targetSettings = ref({ loss_goal: 0.5, activity: 1.2 });

                // New Customer Form State
                const newCustomer = ref({ name: '', gender: 'female', height: '' });
                const customerForm = ref({ dob_day: '', dob_month: '', dob_year: '', is_be: true });

                const getTodayDate = () => new Date().toISOString().split('T')[0];
                const newMeasure = ref({ weight: null, fat_pct: null, visceral: null, muscle_pct: null, body_age: null, bmr: null, recorded_at: getTodayDate() });
                const editingId = ref(null);
                const showChangePasswordModal = ref(false);
                const passwordForm = ref({ newPassword: '', confirmPassword: '' });
                const passwordError = ref('');
                const showScriptModal = ref(false);
                const scriptContent = ref('');
                const scriptPlainText = ref('');
                const captureTimestamp = ref('');
                const action = ref(''); // Track button action
                
                let charts = {}; // Declare charts object here

                // Helper Functions
                const formatDate = (iso) => new Date(iso).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' });
                const formatDateShort = (iso) => new Date(iso).toLocaleDateString('th-TH', { day: 'numeric', month: 'numeric' });
                const formatDecimal = (val, digit) => { if (val === null || val === undefined || isNaN(val)) return '-'; return Number(val).toFixed(digit); };
                const formatBirthDate = (year) => { return year ? `${year + 543} (${year})` : '-'; };
                
                const formatFullBirthDate = (c) => {
                    if (c.birth_date) {
                        const date = new Date(c.birth_date);
                        const day = date.getDate();
                        const month = ["ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.", "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."][date.getMonth()];
                        const year = date.getFullYear();
                        return `${day} ${month} ${year + 543} (${year})`;
                    }
                    return c.birth_year ? `${c.birth_year + 543} (${c.birth_year})` : '-';
                };
                
                const calculateAge = (birthYear) => { const currentYear = new Date().getFullYear(); return currentYear - birthYear; };
                const calculateAgeFromDate = (c) => {
                    if (c.birth_date) {
                        const today = new Date();
                        const birthDate = new Date(c.birth_date);
                        let age = today.getFullYear() - birthDate.getFullYear();
                        const m = today.getMonth() - birthDate.getMonth();
                        if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
                        return age;
                    }
                    return calculateAge(c.birth_year);
                };

                // Database & Auth (Same as before)
                const initSupabase = () => {
                    const urlToUse = config.value.url;
                    const keyToUse = config.value.key;
                    if(urlToUse && keyToUse) {
                        if(!isHardcodedConfig.value) { localStorage.setItem('up_labs_sb_url', urlToUse); localStorage.setItem('up_labs_sb_key', keyToUse); }
                        try { supabase.value = window.supabase.createClient(urlToUse, keyToUse); supabaseConfigured.value = true; checkSession(); } catch (e) { alert("Config Error: " + e.message); }
                    }
                };
                const checkSession = async () => { if(!supabase.value) return; const { data } = await supabase.value.auth.getSession(); session.value = data.session; if(session.value) fetchCustomers(); };
                const loadConfig = () => { if (SUPABASE_URL && SUPABASE_ANON_KEY) { config.value = { url: SUPABASE_URL, key: SUPABASE_ANON_KEY }; isHardcodedConfig.value = true; initSupabase(); return; } const url = localStorage.getItem('up_labs_sb_url'); const key = localStorage.getItem('up_labs_sb_key'); if(url && key) { config.value = { url, key }; initSupabase(); } };
                loadConfig();
                const clearConfig = () => { if(confirm("ต้องการลบการตั้งค่า Database หรือไม่?")) { localStorage.removeItem('up_labs_sb_url'); localStorage.removeItem('up_labs_sb_key'); location.reload(); } };
                
                const handleLogin = async () => { 
                    if(!auth.value.abo || !auth.value.password) return alert('กรุณากรอกข้อมูลให้ครบ');
                    loading.value = true; const fakeEmail = `${auth.value.abo.trim()}@uplabs.coach`;
                    let { data, error } = await supabase.value.auth.signInWithPassword({ email: fakeEmail, password: auth.value.password });
                    if (error) { const { data: upData, error: upError } = await supabase.value.auth.signUp({ email: fakeEmail, password: auth.value.password }); if(upError) { alert("เกิดข้อผิดพลาด: " + upError.message); } else { if(upData.session) { session.value = upData.session; fetchCustomers(); alert("ลงทะเบียนและเข้าสู่ระบบสำเร็จ!"); } else { alert("ลงทะเบียนสำเร็จ! กรุณาล็อกอินอีกครั้ง"); } } } else { session.value = data.session; fetchCustomers(); }
                    loading.value = false;
                };

                // New Auth Functions (Split)
                const performLogin = async () => {
                    if(!auth.value.abo || !auth.value.password) return alert('กรุณากรอกข้อมูลให้ครบ');
                    loading.value = true;
                    action.value = 'login';
                    const fakeEmail = `${auth.value.abo.trim()}@uplabs.coach`;
                    
                    const { data, error } = await supabase.value.auth.signInWithPassword({
                        email: fakeEmail,
                        password: auth.value.password
                    });

                    if (error) {
                        alert("เข้าสู่ระบบไม่สำเร็จ: " + "รหัส ABO หรือ รหัสผ่าน ไม่ถูกต้อง");
                    } else {
                        session.value = data.session;
                        fetchCustomers();
                    }
                    loading.value = false;
                    action.value = '';
                };

                const performRegister = async () => {
                    if(!auth.value.abo || !auth.value.password) return alert('กรุณากรอกข้อมูลให้ครบ');
                    if(auth.value.password.length < 6) return alert('รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร');

                    loading.value = true;
                    action.value = 'register';
                    const fakeEmail = `${auth.value.abo.trim()}@uplabs.coach`;

                    const { data, error } = await supabase.value.auth.signUp({
                        email: fakeEmail,
                        password: auth.value.password
                    });

                    if (error) {
                        alert("ลงทะเบียนไม่สำเร็จ: " + error.message);
                    } else {
                        if (data.session) {
                            session.value = data.session;
                            fetchCustomers();
                            alert("ลงทะเบียนเรียบร้อย!");
                        } else {
                            // Should not happen for auto-confirm disabled but just in case
                            alert("ลงทะเบียนเรียบร้อย! กรุณาเข้าสู่ระบบ");
                        }
                    }
                    loading.value = false;
                    action.value = '';
                };

                const showForgotPasswordInfo = () => alert("เนื่องจากเราใช้อีเมลจำลอง (Fake Email) ระบบจะไม่สามารถส่งอีเมลรีเซ็ตจริงได้ครับ\n\nกรุณาติดต่อ Admin หรือเข้าไปที่ Supabase Dashboard > Authentication > Users เพื่อเปลี่ยนรหัสผ่านด้วยตนเองครับ");
                const handleChangePassword = async () => {
                    if(passwordForm.value.newPassword !== passwordForm.value.confirmPassword) { passwordError.value = "รหัสผ่านไม่ตรงกัน"; return; }
                    if(passwordForm.value.newPassword.length < 6) { passwordError.value = "รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร"; return; }
                    loading.value = true;
                    const { error } = await supabase.value.auth.updateUser({ password: passwordForm.value.newPassword });
                    if(error) alert("เปลี่ยนรหัสผ่านไม่สำเร็จ: " + error.message); else { alert("เปลี่ยนรหัสผ่านเรียบร้อย!"); showChangePasswordModal.value = false; passwordForm.value = { newPassword: '', confirmPassword: '' }; }
                    loading.value = false;
                };
                const logout = async () => { await supabase.value.auth.signOut(); session.value = null; customers.value = []; auth.value = { abo: '', password: '' }; };
                
                // Customer Logic
                const fetchCustomers = async () => { loading.value = true; let { data, error } = await supabase.value.from('customers').select('*').order('updated_at', { ascending: false }); if(!error) customers.value = data; loading.value = false; };
                const filteredCustomers = computed(() => { if(!searchQuery.value) return customers.value; return customers.value.filter(c => c.name.toLowerCase().includes(searchQuery.value.toLowerCase())); });
                const openAddCustomerModal = () => { newCustomer.value = { name: '', gender: 'female', height: '' }; customerForm.value = { dob_day: '', dob_month: '', dob_year: '', is_be: true }; showAddCustomerModal.value = true; };
                const addCustomer = async () => {
                    const d = customerForm.value.dob_day; const m = customerForm.value.dob_month; let y = parseInt(customerForm.value.dob_year);
                    if (!d || !m || !y) return alert("กรุณากรอกวันเดือนปีเกิดให้ครบ");
                    
                    if (customerForm.value.is_be) y = y - 543; // Convert BE to AD
                    
                    // Validate Date
                    const testDate = new Date(y, m - 1, d);
                    if (testDate.getFullYear() !== y || testDate.getMonth() !== m - 1 || testDate.getDate() !== d) {
                         alert("วันที่ไม่ถูกต้อง (เช่น 30 ก.พ.) กรุณาตรวจสอบอีกครั้ง");
                         return;
                    }

                    const dob = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    const user = session.value.user;
                    const { error } = await supabase.value.from('customers').insert({
                        coach_id: user.id,
                        ...newCustomer.value,
                        birth_year: y, 
                        birth_date: dob 
                    });
                    if(error) alert("บันทึกไม่สำเร็จ: " + error.message + "\n(หาก Error เกี่ยวกับ birth_date แสดงว่ายังไม่ได้อัปเดต Database)");
                    else {
                        showAddCustomerModal.value = false;
                        fetchCustomers();
                    }
                };
                const selectCustomer = (c) => { 
                    currentCustomer.value = c; 
                    view.value = 'customer_detail'; 
                    subView.value = 'measure'; 
                    editingId.value = null; 
                    // Safely destroy charts if they exist
                    if (charts) {
                        Object.values(charts).forEach(chart => {
                            if (chart && typeof chart.destroy === 'function') {
                                chart.destroy();
                            }
                        });
                    }
                    charts = {}; 
                    newMeasure.value = { weight: null, fat_pct: null, visceral: null, muscle_pct: null, body_age: null, bmr: null, recorded_at: getTodayDate() }; 
                };
                
                // CSV Logic (Import/Export/Legacy) - Keeping Smart Logic
                // ... (Using same logic as previous v2.9 fix) ...
                const importLegacyCSV = (event) => {
                    const file = event.target.files[0];
                    if (!file || !currentCustomer.value) return;
                    const readFile = (encoding) => new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = (e) => resolve(e.target.result); reader.onerror = (e) => reject(e); reader.readAsText(file, encoding); });
                    const processText = async (text) => {
                        const lines = text.split(/\r\n|\n/).filter(line => line.trim() !== '');
                        let dateRowIdx = -1, weightRowIdx = -1, fatRowIdx = -1, visRowIdx = -1, musRowIdx = -1, ageRowIdx = -1, bmrRowIdx = -1;
                        lines.forEach((l, idx) => {
                            const lower = l.toLowerCase();
                            // Find Date Row: either "Date" or "วันที่" or "รายการ"
                            if (lower.includes('date') || l.includes('วันที่') || l.includes('รายการ') || l.includes('Latest')) {
                                if(l.includes('รายการ') || l.includes('Latest')) dateRowIdx = idx + 1; // Date usually follows header
                                else dateRowIdx = idx; // This row IS date row
                            }
                            
                            if(l.includes('น้ำหนัก') || l.includes('Weight')) weightRowIdx = idx;
                            else if(l.includes('Fat-%') || l.includes('ไขมัน') || l.includes('Body Fat') || l.includes('%Fat')) fatRowIdx = idx;
                            else if(l.includes('Visceral') || l.includes('ช่องท้อง') || l.includes('V.Fat')) visRowIdx = idx;
                            else if(l.includes('Muscle') || l.includes('กล้ามเนื้อ') || l.includes('%Muscle')) musRowIdx = idx;
                            else if(l.includes('Body Age') || l.includes('อายุร่างกาย') || l.includes('B.Age')) ageRowIdx = idx;
                            else if(l.includes('BMR') || lower.includes('bmr')) bmrRowIdx = idx;
                        });
                        // Fallback for Date Row if weight exists but no explicit date header found
                        if(weightRowIdx !== -1 && dateRowIdx === -1 && weightRowIdx > 0) dateRowIdx = weightRowIdx - 1;

                        if (weightRowIdx === -1 || dateRowIdx === -1) return false;
                        const dateRow = lines[dateRowIdx].split(',');
                        const weightRow = lines[weightRowIdx].split(',');
                        const fatRow = fatRowIdx !== -1 ? lines[fatRowIdx].split(',') : null;
                        const visRow = visRowIdx !== -1 ? lines[visRowIdx].split(',') : null;
                        const musRow = musRowIdx !== -1 ? lines[musRowIdx].split(',') : null;
                        const ageRow = ageRowIdx !== -1 ? lines[ageRowIdx].split(',') : null;
                        const bmrRow = bmrRowIdx !== -1 ? lines[bmrRowIdx].split(',') : null;
                        loading.value = true; let count = 0;
                        for(let i=0; i<dateRow.length; i++) {
                            let dStr = dateRow[i]; if(!dStr || !dStr.includes('/')) continue;
                            const parts = dStr.trim().split('/'); if(parts.length !== 3) continue;
                            let y = parseInt(parts[2]); if(y < 2000) y += 2000; if(y > 2400) y -= 543;
                            let m = parts[1]; let d = parts[0]; if(isNaN(y) || isNaN(parseInt(m)) || isNaN(parseInt(d))) continue;
                            let isoDate = `${y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;
                            const clean = (val) => { if(!val) return null; let s = val.toString().replace('%', '').trim(); let v = parseFloat(s); return isNaN(v) ? null : v; };
                            let w = clean(weightRow[i]); let f = fatRow ? clean(fatRow[i]) : null; let v = visRow ? clean(visRow[i]) : null; let mus = musRow ? clean(musRow[i]) : null; let age = ageRow ? clean(ageRow[i]) : null; let b = bmrRow ? clean(bmrRow[i]) : null;
                            if(w) { await supabase.value.from('measurements').insert({ customer_id: currentCustomer.value.id, recorded_at: isoDate, weight: w, fat_pct: f, visceral: v, muscle_pct: mus, body_age: age, bmr: b }); count++; }
                        }
                        return count;
                    };
                    readFile('windows-874').then(async (text) => { let result = await processText(text); if (!result) { const utfText = await readFile('UTF-8'); result = await processText(utfText); } if (!result) { alert("ไม่สามารถอ่านข้อมูลได้"); loading.value = false; } else { alert(`นำเข้า ${result} รายการ`); loadHistory(); loading.value = false; } }).catch(err => { console.error(err); alert("Error reading file"); loading.value = false; });
                };
                const exportCSV = async () => {
                    loading.value = true; const { data: allCust } = await supabase.value.from('customers').select('*'); const { data: allMeas } = await supabase.value.from('measurements').select('*');
                    const rows = []; rows.push(['Date', 'Name', 'Gender', 'BirthYear', 'Height', 'Weight', 'Fat%', 'Visceral', 'Muscle%', 'BodyAge', 'BMR']);
                    allMeas.forEach(m => { const c = allCust.find(cust => cust.id === m.customer_id); if (c) { rows.push([ new Date(m.recorded_at).toISOString(), c.name, c.gender, c.birth_year, c.height, m.weight, m.fat_pct, m.visceral, m.muscle_pct, m.body_age, m.bmr ]); } });
                    const csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n"); const encodedUri = encodeURI(csvContent); const link = document.createElement("a"); link.setAttribute("href", encodedUri); link.setAttribute("download", `backup_uplabs_${new Date().toISOString().slice(0,10)}.csv`); document.body.appendChild(link); link.click(); loading.value = false;
                };
                const importCSV = (event) => {
                    const file = event.target.files[0]; if (!file) return;
                    const reader = new FileReader(); reader.onload = async (e) => {
                        const text = e.target.result; const lines = text.split('\n'); const dataRows = lines.slice(1).filter(line => line.trim() !== '');
                        let importedCount = 0; loading.value = true;
                        for (const row of dataRows) {
                            const cols = row.split(','); if (cols.length < 5) continue;
                            const name = cols[1]; const gender = cols[2]; const year = parseInt(cols[3]); const height = parseFloat(cols[4]);
                            let custId = null; const existing = customers.value.find(c => c.name === name);
                            if (existing) { custId = existing.id; } else { const { data: newC, error } = await supabase.value.from('customers').insert({ coach_id: session.value.user.id, name: name, gender: gender, birth_year: year, height: height }).select(); if (newC) { custId = newC[0].id; customers.value.push(newC[0]); } }
                            if (custId) { await supabase.value.from('measurements').insert({ customer_id: custId, weight: parseFloat(cols[5]), fat_pct: parseFloat(cols[6]), visceral: parseFloat(cols[7]), muscle_pct: parseFloat(cols[8]), body_age: parseFloat(cols[9]), bmr: parseFloat(cols[10]), recorded_at: cols[0] }); importedCount++; }
                        }
                        alert(`นำเข้าข้อมูลสำเร็จ ${importedCount} รายการ`); fetchCustomers(); loading.value = false;
                    }; reader.readAsText(file);
                };

                // Main Logic
                const changeSubView = (val) => { 
                    subView.value = val; 
                    if(val === 'history') { 
                        loadHistory(); 
                    } else { 
                        // Safely destroy charts
                        if (charts) {
                            Object.values(charts).forEach(chart => {
                                if (chart && typeof chart.destroy === 'function') {
                                    chart.destroy();
                                }
                            });
                        }
                        charts = {}; 
                    } 
                };
                const editRecord = (record) => { newMeasure.value = { ...record, recorded_at: new Date(record.recorded_at).toISOString().split('T')[0] }; editingId.value = record.id; subView.value = 'measure'; };
                const cancelEdit = () => { editingId.value = null; newMeasure.value = { weight: null, fat_pct: null, visceral: null, muscle_pct: null, body_age: null, bmr: null, recorded_at: getTodayDate() }; };
                const saveMeasurement = async () => {
                    if(!newMeasure.value.weight) return alert("กรุณากรอกน้ำหนัก"); loading.value = true; let error = null;
                    if (editingId.value) { const { error: err } = await supabase.value.from('measurements').update({ ...newMeasure.value }).eq('id', editingId.value); error = err; }
                    else { const { error: err } = await supabase.value.from('measurements').insert({ customer_id: currentCustomer.value.id, ...newMeasure.value }); error = err; }
                    if(!error) { await supabase.value.from('customers').update({ updated_at: new Date() }).eq('id', currentCustomer.value.id); alert(editingId.value ? "แก้ไขข้อมูลเรียบร้อย" : "บันทึกเรียบร้อย"); cancelEdit(); } else { alert(error.message); } loading.value = false;
                };
                const deleteRecord = async (id) => { if(!confirm("ยืนยันการลบ?")) return; loading.value = true; const { error } = await supabase.value.from('measurements').delete().eq('id', id); if(error) alert(error.message); else loadHistory(); loading.value = false; };
                
                // Charts & History
                const loadHistory = async () => {
                    subView.value = 'history'; loading.value = true;
                    let { data, error } = await supabase.value.from('measurements').select('*').eq('customer_id', currentCustomer.value.id).order('recorded_at', { ascending: false });
                    if(!error) {
                        const cutoff = new Date(); if(chartDays.value !== 9999) cutoff.setDate(cutoff.getDate() - chartDays.value);
                        history.value = chartDays.value !== 9999 ? data.filter(d => new Date(d.recorded_at) >= cutoff) : data;
                        await nextTick(); renderCharts();
                    }
                    loading.value = false;
                };
                
                // Add watcher for graphVisibility to re-render charts when toggled
                watch(graphVisibility, () => {
                    if (subView.value === 'history' || isGeneratingReport.value) {
                        nextTick(() => renderCharts());
                    }
                }, { deep: true });

                watch(chartDays, () => { if(subView.value === 'history') loadHistory(); });
                // ... (getLinearRegression same as v2.9) ...
                const getLinearRegression = (yValues) => { const xValues = yValues.map((_, i) => i); const n = yValues.length; if (n < 2) return null; const sumX = xValues.reduce((a, b) => a + b, 0); const sumY = yValues.reduce((a, b) => a + b, 0); const sumXY = xValues.reduce((a, b, i) => a + b * yValues[i], 0); const sumXX = xValues.reduce((a, b) => a + b * b, 0); const denominator = n * sumXX - sumX * sumX; if (denominator === 0) return Array(n).fill(sumY/n); const slope = (n * sumXY - sumX * sumY) / denominator; const intercept = (sumY - slope * sumX) / n; return xValues.map(x => slope * x + intercept); };

                const renderCharts = () => {
                     const chartData = [...history.value].reverse();
                     const labels = chartData.map(h => new Date(h.recorded_at).toLocaleDateString('th-TH', {day:'numeric', month:'short'}));
                     const createChart = (id, label, data, color) => {
                        // Check if enabled in graphVisibility
                        if (!graphVisibility.value[id.replace('Chart', '').replace('visceral', 'visceral').replace('bodyAge', 'bodyAge')]) return; 
                        // Fix key mapping: visceralChart -> visceral, bodyAgeChart -> bodyAge
                        let visibilityKey = id.replace('Chart', '');
                        if (id === 'visceralChart') visibilityKey = 'visceral';
                        if (id === 'bodyAgeChart') visibilityKey = 'bodyAge';
                        
                        if (!graphVisibility.value[visibilityKey]) return;

                        const ctx = document.getElementById(id); if(!ctx) return; if(charts[id]) charts[id].destroy();
                        
                        const mainDataPoints = chartData.map(h => h[data[0].key]);
                        const trendData = getLinearRegression(mainDataPoints);
                        const datasets = [{
                            label: label, data: mainDataPoints, borderColor: color, backgroundColor: color + '20', tension: 0.4, pointRadius: 4, fill: false,
                            datalabels: { 
                                align: 'top', 
                                anchor: 'end', 
                                font: { size: 10 }, 
                                color: color, 
                                formatter: (val) => {
                                    if (val === null || val === undefined || val == 0) return '';
                                    return Number(val).toFixed(1).replace('.0','') 
                                }
                            }
                        }];
                        if(trendData) datasets.push({ label: 'แนวโน้ม', data: trendData, borderColor: '#9ca3af', borderDash: [5, 5], borderWidth: 1, pointRadius: 0, tension: 0, datalabels: { display: false } });

                        charts[id] = new Chart(ctx, { 
                            type: 'line', 
                            data: { labels: labels, datasets: datasets }, 
                            options: { 
                                responsive: true, 
                                maintainAspectRatio: false, // Critical for mobile: false allows custom height
                                plugins: { legend: { display: true }, datalabels: { display: true } }, 
                                layout: { padding: { top: 20 } } 
                            } 
                        });
                     };

                     createChart('weightChart', 'น้ำหนัก', [{key:'weight'}], '#2563eb');
                     
                     // Fat Chart Special Case
                     const fatMassData = chartData.map(h => ({ ...h, fat_mass: parseFloat((h.weight * h.fat_pct / 100).toFixed(1)) }));
                     if (graphVisibility.value.fat) {
                        if(charts['fatChart']) charts['fatChart'].destroy();
                        const fatCtx = document.getElementById('fatChart');
                        if (fatCtx) {
                             charts['fatChart'] = new Chart(fatCtx, {
                                type: 'line',
                                data: {
                                    labels: labels,
                                    datasets: [
                                        { label: 'Fat Mass (kg)', data: fatMassData.map(d=>d.fat_mass), borderColor: '#eab308', tension: 0.4, yAxisID: 'y', datalabels: { align:'top', anchor:'end', color: '#eab308', font:{size:10}, formatter: (val) => val ? Number(val).toFixed(1).replace('.0','') : '' } },
                                        { label: '% Fat', data: fatMassData.map(d=>d.fat_pct), borderColor: '#facc15', borderDash: [2,2], tension: 0.4, yAxisID: 'y1', datalabels: { display:false } }
                                    ]
                                },
                                options: { 
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    scales: { y: {position: 'left'}, y1: {position: 'right'} }, 
                                    plugins: { datalabels: { display: true } } 
                                }
                            });
                        }
                     }

                     createChart('muscleChart', 'กล้ามเนื้อ', [{key:'muscle_pct'}], '#16a34a');
                     createChart('visceralChart', 'Visceral', [{key:'visceral'}], '#dc2626');
                     createChart('bodyAgeChart', 'Body Age', [{key:'body_age'}], '#9333ea');
                };

                // Analysis Calcs & Colors
                const calcFatMass = computed(() => (newMeasure.value.weight * newMeasure.value.fat_pct / 100).toFixed(1));
                const calcMuscleMass = computed(() => (newMeasure.value.weight * newMeasure.value.muscle_pct / 100).toFixed(1));
                const calcBMI = computed(() => (newMeasure.value.weight / ((currentCustomer.value.height/100)**2)).toFixed(1));
                const calcFFM = computed(() => {
                    if(!newMeasure.value.weight || !newMeasure.value.fat_pct) return 0;
                    return (newMeasure.value.weight * (1 - newMeasure.value.fat_pct / 100)).toFixed(1);
                });

                // --- Color Helpers for Table ---
                const getVisceralColor = (v) => {
                    if (v === null) return '';
                    if (v <= 2) return 'text-emerald-600 font-bold';
                    if (v <= 5) return 'text-green-600 font-bold';
                    if (v <= 9) return 'text-yellow-600 font-bold';
                    if (v <= 15) return 'text-orange-600 font-bold';
                    return 'text-red-600 font-bold';
                };

                const getFatColor = (fat, gender) => {
                    if (fat === null) return '';
                    let low = gender === 'male' ? 10 : 20;
                    let norm = gender === 'male' ? 20 : 30;
                    let high = gender === 'male' ? 25 : 35;
                    if (fat < low) return 'text-yellow-600 font-bold';
                    if (fat <= norm) return 'text-green-600 font-bold';
                    if (fat <= high) return 'text-orange-500 font-bold';
                    return 'text-red-600 font-bold';
                };

                const getMuscleColor = (mus, gender) => {
                    if (mus === null) return '';
                    let low = gender === 'male' ? 33 : 24;
                    let norm = gender === 'male' ? 39 : 30;
                    if (mus < low) return 'text-yellow-600 font-bold';
                    if (mus <= norm) return 'text-green-600 font-bold';
                    return 'text-emerald-600 font-bold';
                };
                
                const getVisResult = computed(() => {
                    const v = newMeasure.value.visceral;
                    if(v === null) return { status: '-', colorClass: 'bg-gray-300', textClass: 'text-gray-400' };
                    if (v <= 2) return { status: 'ดีมาก (Excellent)', colorClass: 'bg-emerald-600', textClass: 'text-emerald-600' };
                    if (v <= 5) return { status: 'ปกติ', colorClass: 'bg-green-500', textClass: 'text-green-600' };
                    if (v <= 9) return { status: 'สูง', colorClass: 'bg-yellow-400', textClass: 'text-yellow-500' };
                    if (v <= 15) return { status: 'สูงมาก (Very High)', colorClass: 'bg-orange-500', textClass: 'text-orange-500' };
                    return { status: 'อันตราย', colorClass: 'bg-red-600', textClass: 'text-red-600' };
                });
                const getFatResult = computed(() => {
                     const fat = newMeasure.value.fat_pct;
                     const gender = currentCustomer.value.gender;
                     if(fat === null) return { status: '-', colorClass: 'bg-gray-300', textClass: 'text-gray-400' };
                     let low = gender === 'male' ? 10 : 20;
                     let norm = gender === 'male' ? 20 : 30;
                     let high = gender === 'male' ? 25 : 35;
                     if (fat < low) return { status: 'น้อยกว่าเกณฑ์', colorClass: 'bg-yellow-400', textClass: 'text-yellow-500' };
                     if (fat <= norm) return { status: 'ปกติ', colorClass: 'bg-green-500', textClass: 'text-green-500' };
                     if (fat <= high) return { status: 'สูง', colorClass: 'bg-orange-400', textClass: 'text-orange-500' };
                     return { status: 'สูงมาก', colorClass: 'bg-red-600', textClass: 'text-red-600' };
                });
                const getMuscleResult = computed(() => {
                     const mus = newMeasure.value.muscle_pct;
                     const gender = currentCustomer.value.gender;
                     if(mus === null) return { status: '-', colorClass: 'bg-gray-300', textClass: 'text-gray-400' };
                     let low = gender === 'male' ? 33 : 24;
                     let norm = gender === 'male' ? 39 : 30;
                     if (mus < low) return { status: 'น้อย (ควรเพิ่ม)', colorClass: 'bg-yellow-400', textClass: 'text-yellow-500' };
                     if (mus <= norm) return { status: 'มาตรฐาน', colorClass: 'bg-green-500', textClass: 'text-green-500' };
                     return { status: 'ดีมาก (High)', colorClass: 'bg-emerald-600', textClass: 'text-emerald-600' };
                });
                const getBMIResult = computed(() => {
                    const bmi = parseFloat(calcBMI.value);
                    if(isNaN(bmi)) return { status: '-', colorClass: 'bg-gray-300', textClass: 'text-gray-400' };
                    if (bmi < 18.5) return { status: 'ผอม', colorClass: 'bg-yellow-400', textClass: 'text-yellow-500' };
                    if (bmi <= 22.9) return { status: 'สมส่วน (ปกติ)', colorClass: 'bg-green-500', textClass: 'text-green-500' };
                    if (bmi <= 24.9) return { status: 'ท้วม', colorClass: 'bg-orange-400', textClass: 'text-orange-500' };
                    if (bmi <= 29.9) return { status: 'อ้วน', colorClass: 'bg-orange-500', textClass: 'text-orange-600' };
                    return { status: 'อ้วนมาก', colorClass: 'bg-red-600', textClass: 'text-red-600' };
                });
                const getBMIWidth = computed(() => {
                    const val = parseFloat(calcBMI.value);
                    if(isNaN(val)) return 0;
                    let pct = ((val - 10) / 30) * 100;
                    if(pct < 0) pct = 0; if(pct > 100) pct = 100;
                    return pct;
                });

                const getFatMarkers = computed(() => {
                    if (!currentCustomer.value) return [10, 20, 25];
                    return currentCustomer.value.gender === 'male' ? [10, 20, 25] : [20, 30, 35];
                });
                const getMuscleMarkers = computed(() => {
                    if (!currentCustomer.value) return [33, 39];
                    return currentCustomer.value.gender === 'male' ? [33, 39] : [24, 30];
                });

                const idealWeightRangeText = computed(() => '-');
                const targetWeightText = computed(() => '-');
                const targetWeightColor = computed(() => 'text-gray-700');
                const targetLoss = computed(() => {
                    if (targetSettings.value.loss_goal === 0) return 0;
                    return targetSettings.value.loss_goal;
                });
                
                const calcTDEE = computed(() => {
                   if (!newMeasure.value.bmr) return 0;
                   return Math.round(newMeasure.value.bmr * targetSettings.value.activity);
                });

                const recommendDailyKcal = computed(() => {
                    if (!calcTDEE.value) return 0;
                    const deficit = (targetSettings.value.loss_goal * 7700) / 7;
                    return Math.round(calcTDEE.value - deficit);
                });
                
                const proteinRange = computed(() => {
                    const ffm = parseFloat(calcFFM.value);
                    if (!ffm) return '-';
                    return `${(ffm * 1.2).toFixed(0)} - ${(ffm * 1.6).toFixed(0)}`;
                });
                
                const recommendKcal = computed(() => 0); // Deprecated

                const generateScript = () => {
                    const weight = newMeasure.value.weight || 0;
                    const fatPct = newMeasure.value.fat_pct || 0;
                    const visceral = newMeasure.value.visceral || 0;
                    const musclePct = newMeasure.value.muscle_pct || 0;
                    const bodyAge = newMeasure.value.body_age || 0;
                    const bmr = newMeasure.value.bmr || 0;
                    const realAge = calculateAgeFromDate(currentCustomer.value);
                    const ageDiff = bodyAge - realAge;
                    let ageText = ageDiff > 0 ? `เกินอายุจริงไป ${ageDiff} ปี` : (ageDiff < 0 ? `อ่อนกว่าวัย ${Math.abs(ageDiff)} ปี` : "เท่าอายุจริง");
                    
                    let weightStatus = "อยู่ในเกณฑ์";
                    // Simplified logic
                    const h_m = currentCustomer.value.height / 100;
                    const bmi = weight / (h_m * h_m);
                    if(bmi > 22.9) weightStatus = "เกินเกณฑ์";
                    else if(bmi < 18.5) weightStatus = "ตกเกณฑ์ นิดหน่อย";
                    
                    scriptContent.value = `
                    <div class="space-y-4 font-sarabun text-gray-700 text-sm leading-relaxed">
                        <div class="p-3 bg-teal-50 rounded-lg border border-teal-100">
                            <h4 class="font-bold text-teal-800 mb-2">👋 บทนำ</h4>
                            <p>เคยชั่งค่าวัดผล ? เคยวัดร่างกายไหม ? เราวัดให้จ้า ลองดูๆ ค่ะ</p>
                        </div>
                        
                        <div class="space-y-2">
                            <h4 class="font-bold text-gray-800 border-b pb-1">📊 ผลวิเคราะห์</h4>
                            <p>⚖️ <b>น้ำหนัก:</b> ${weight} kg ... <span class="${weightStatus.includes('เกิน') ? 'text-red-500' : 'text-green-600'}">${weightStatus}</span></p>
                            <p>🧀 <b>ไขมัน:</b> ${fatPct}% ... <span class="${getFatResult.value.textClass}">${getFatResult.value.status}</span></p>
                            <p>🫀 <b>ไขมันช่องท้อง:</b> ${visceral} ... <span class="${getVisResult.value.textClass}">${getVisResult.value.status}</span> <br><span class="text-xs text-gray-500 pl-6">ไขมันตัวนี้อันตราย เกาะตับ หัวใจ มีมากความดันเบาหวานก็ตามมา แม้น้ำหนักไม่เยอะเลย</span></p>
                            <p>💪 <b>กล้ามเนื้อ:</b> ${musclePct}% ... <span class="${getMuscleResult.value.textClass}">${getMuscleResult.value.status}</span> <br><span class="text-xs text-gray-500 pl-6">กล้ามเนื้อยิ่งแก่ยิ่งลด ภูมิตก อ้วนง่าย คนแก่กล้ามเนื้อน้อยมาก กระดูกหักง่าย</span></p>
                            <p>⏳ <b>อายุร่างกาย:</b> ${bodyAge} ปี ... <br><span class="text-xs text-gray-500 pl-6">อันนี้เราวัดรวมๆ นะ ใน Longevity ที่เซเลป ดาราไปวัดกันแพงๆ เค้าวัดกันแต่ละอวัยวะเลย เพราะอยากมีอายุยืนแบบแข็งแรง มีคุณภาพชีวิตที่ดี จะได้ดูแลถูก</span></p>
                            <p>🔥 <b>BMR:</b> ${bmr} kcal ... <br><span class="text-xs text-gray-500 pl-6">อันนี้ง่ายๆ กล้ามเนื้อเยอะ อายุน้อยเผาผลาญดี อายุมาก กล้ามเนื้อน้อย นั่งหายใจก็อ้วนได้ 555+ เท่านี้แหละจ้า</span></p>
                        </div>

                        <div class="p-3 bg-blue-50 rounded-lg border border-blue-100">
                            <h4 class="font-bold text-blue-800 mb-2">🗣️ ถามลูกค้า</h4>
                            <p>ลูกค้า: (เค้าก็อาจจะถามว่าแล้วต้องทำยังไง หรือ ขอบคุณแล้วไม่พูดอะไร)</p>
                            <p class="mt-2 font-semibold">เราถามต่อว่า:</p>
                            <p>"มีแผนอยากดูแลตัวเองยังไง อยากลดน้ำหนักไหม หรือ ดูแล้วยังไม่หนักหนานะ ดูแลตัวเองแบบชิลๆ เดือนละ 1000-3000 ก็หลับดีขึ้น เผาผลาญดีขึ้นแบบยาวๆ แล้วจ้า"</p>
                        </div>

                        <div class="p-3 bg-purple-50 rounded-lg border border-purple-100">
                            <h4 class="font-bold text-purple-800 mb-2">💎 นำเสนอ Solution</h4>
                            <p>ลูกค้า: "เหรอ ยังไงอ่ะ/ อืม ยังอ่ะ/ เราดูแลตัวเองด้วย....."</p>
                            <p class="mt-2 font-semibold">เรา: "เรามีโปรแกรม UP Labs กับ Full Course"</p>
                            <ul class="list-disc pl-5 mt-1 space-y-2">
                                <li><b>ถ้าเน้นชิล (Budget 1000-3000):</b> ชอบแบบสั้น เร็ว ถูก ทำได้ยาวๆ สุขภาพดียั่งยืน <b class="text-purple-600">UP Labs</b> ตอบโจทย์สุด 14 วันรู้เรื่องจ้า ได้ทั้ง Fat adaptation, Autophagy, ฝึก IF หลับดี สบายตัว</li>
                                <li><b>ถ้าข้อจำกัดเยอะ (ต้องลด 20-30kg / มีโรค):</b> เป็นแนวไม่อยากปรับตัวมาก กินยากไม่ได้ <b class="text-purple-600">Full Course</b> เลย เดือนละ 20,000 เยอะแต่จบ เราประทับใจมากกกกกก</li>
                            </ul>
                        </div>

                        <div class="p-3 bg-green-50 rounded-lg border border-green-100 text-center">
                            <h4 class="font-bold text-green-800 mb-2">🚀 CTA (ปิดการขาย)</h4>
                            <p>"เริ่มกันเลยนร้า / เริ่มวันไหนดี เรา order ของมาให้จ้า/ เริ่มอาทิตย์หน้าไหมพร้อมเรา มีเพื่อนจ้า/ เชียร์"</p>
                        </div>
                    </div>`;

                    // Simple plain text for speaking
                    scriptPlainText.value = `สวัสดีครับ วันนี้มาดูผลร่างกายกัน น้ำหนัก ${weight} กิโลกรัม ไขมัน ${fatPct} เปอร์เซ็นต์ อยู่ในเกณฑ์ ${getFatResult.value.status} ไขมันช่องท้องระดับ ${visceral} กล้ามเนื้อ ${musclePct} เปอร์เซ็นต์ อายุร่างกาย ${bodyAge} ปี อัตราการเผาผลาญ ${bmr} แคลอรี่ครับ`;

                    showScriptModal.value = true;
                };

                const speak = () => {
                    const u = new SpeechSynthesisUtterance(scriptPlainText.value);
                    u.lang = 'th-TH';
                    window.speechSynthesis.speak(u);
                };

                const copyScript = () => {
                    navigator.clipboard.writeText(scriptPlainText.value).then(() => {
                        alert("คัดลอกสคริปต์เรียบร้อย!");
                    });
                };
                
                const saveImage = (section) => {
                    // Hide menu first
                    showSaveMenu.value = false;

                    const now = new Date();
                    captureTimestamp.value = now.toLocaleDateString('th-TH') + ' ' + now.toLocaleTimeString('th-TH');
                    
                    let targetId;
                    let isFullReport = false;

                    if (section === 'full') {
                        isFullReport = true;
                        isGeneratingReport.value = true;
                        
                        // Wait for DOM to update and render both sections
                        setTimeout(() => {
                             // Re-render charts as they might be hidden/destroyed
                             renderCharts();
                             // Give time for charts to animate/render
                             setTimeout(() => doCapture('capture-area'), 800);
                        }, 200);
                        return;
                    } 
                    
                    // Logic for specific sections (graph, table, analysis)
                    else if (section === 'graph') {
                        if (subView.value !== 'history') {
                             changeSubView('history');
                             // Wait for render
                             setTimeout(() => doCapture('capture-area'), 500);
                             return;
                        }
                        targetId = 'capture-area'; // Capturing full history view is safest for now
                    } else if (section === 'table') {
                         if (subView.value !== 'history') {
                             changeSubView('history');
                             setTimeout(() => doCapture('history-table-section'), 500); // Target specific table id if added
                             return;
                        }
                         targetId = 'history-table-section'; // Fallback to full area if specific section id not robust
                    } else {
                        // Analysis/Measure
                        if (subView.value !== 'measure') {
                            changeSubView('measure');
                            setTimeout(() => doCapture('capture-area'), 500);
                            return;
                        }
                        targetId = 'capture-area';
                    }

                    doCapture(targetId);

                    function doCapture(elementId) {
                        const element = document.getElementById(elementId);
                        if (!element) return;

                        const hiddenElements = document.querySelectorAll('.no-print-capture');
                        hiddenElements.forEach(el => el.style.display = 'none');
                        
                        window.scrollTo(0,0);

                        setTimeout(() => {
                            html2canvas(element, {
                                scale: 2,
                                useCORS: true,
                                backgroundColor: '#ffffff',
                                logging: false,
                                onclone: (clonedDoc) => {
                                   clonedDoc.documentElement.scrollTop = 0;
                                   clonedDoc.body.scrollTop = 0;
                                }
                            }).then(canvas => {
                                const link = document.createElement('a');
                                link.download = `Result-${section}-${currentCustomer.value.name}.png`;
                                link.href = canvas.toDataURL('image/png');
                                link.click();
                                
                                // Restore elements
                                hiddenElements.forEach(el => el.style.display = '');
                                captureTimestamp.value = ''; 
                                if(isFullReport) isGeneratingReport.value = false;
                            }).catch(err => {
                                 console.error("Screenshot failed", err);
                                 alert("ไม่สามารถบันทึกรูปได้ในขณะนี้");
                                 hiddenElements.forEach(el => el.style.display = '');
                                 if(isFullReport) isGeneratingReport.value = false;
                            });
                        }, 500);
                    }
                };

                return {
                    supabaseConfigured, config, initSupabase, clearConfig, isHardcodedConfig, session, auth, performLogin, performRegister, handleLogin, logout, loading, userAbo, showForgotPasswordInfo,
                    view, subView, changeSubView, customers, filteredCustomers, searchQuery, selectCustomer,
                    showAddCustomerModal, newCustomer, addCustomer, openAddCustomerModal, customerForm, showSaveMenu, isGeneratingReport,
                    showChangePasswordModal, passwordForm, passwordError, handleChangePassword,
                    currentCustomer, calculateAge, calculateAgeFromDate, formatDate, formatDateShort, formatDecimal, formatFullBirthDate, formatBirthDate,
                    newMeasure, saveMeasurement, editRecord, cancelEdit, editingId,
                    history, loadHistory, deleteRecord, chartDays, graphVisibility, action,
                    calcFatMass, calcMuscleMass, calcBMI, getBMIWidth,
                    getFatMarkers, getMuscleMarkers, getFatResult, getVisResult, getMuscleResult, getBMIResult, getFatColor, getVisceralColor, getMuscleColor,
                    idealWeightRangeText, targetWeightText, targetWeightColor, targetLoss, recommendKcal, targetSettings,
                    calcFFM, calcTDEE, recommendDailyKcal, proteinRange,
                    showScriptModal, scriptContent, scriptPlainText, generateScript, speak, copyScript, saveImage, captureTimestamp,
                    exportCSV, importCSV, importLegacyCSV
                };
            }
        };

        const app = createApp(App);
        app.component('analysis-card', {
            props: ['title', 'icon', 'titleColor', 'barClass', 'value', 'unit', 'subValue', 'subUnit', 'markers', 'status', 'statusColor', 'min', 'max', 'rangeLabels', 'rangeColors', 'valueColor'],
            template: `
            <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100 mb-2 relative overflow-visible">
                <div class="flex justify-between items-center mb-1">
                    <h3 class="font-bold text-sm flex items-center text-gray-700">
                        <i :class="['fa-solid fa-'+icon+' mr-2', titleColor]"></i> {{title}}
                    </h3>
                    <div class="text-right">
                        <span :class="['text-xl font-bold', valueColor]">{{value}} {{unit}}</span>
                        <span v-if="subValue" class="text-xs text-gray-400 ml-1">({{subValue}} {{subUnit}})</span>
                    </div>
                </div>
                <div class="relative h-3 bg-gray-200 rounded-full mt-3 mb-5">
                    <div :class="['absolute top-0 left-0 h-full rounded-full gauge-bar', barClass]" 
                         :style="{width: Math.min(((value - min) / (max - min)) * 100, 100) + '%'}"></div>
                    <div v-for="m in markers" :key="m" class="absolute top-0 w-0.5 h-full bg-white z-10" 
                         :style="{left: ((m - min) / (max - min)) * 100 + '%'}"></div>
                    
                    <div v-for="m in markers" :key="m+'lbl'" class="marker-label"
                         :style="{left: ((m - min) / (max - min)) * 100 + '%'}">{{m}}</div>
                </div>
                
                <div v-if="rangeLabels" class="flex justify-between text-[10px] font-bold mt-2 mb-1 px-1">
                    <span v-for="(label, idx) in rangeLabels" :key="label" :class="rangeColors ? rangeColors[idx] : 'text-gray-400'">{{label}}</span>
                </div>

                <p :class="['text-xs font-bold text-right mt-1', statusColor]">{{status}}</p>
            </div>
            `
        });

        app.mount('#app');
    </script>
</body>
</html>
