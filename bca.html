<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UP Labs Body Composition Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f0fdfa; /* Teal-50 */
        }
        @media print {
            .no-print { display: none !important; }
            .print-break { page-break-inside: avoid; }
            body { background-color: white; }
            .shadow-lg, .shadow-md, .shadow-sm { box-shadow: none !important; border: 1px solid #e5e7eb; }
            input, select { border: none; background: transparent; padding: 0; margin: 0; font-weight: bold; color: black; -webkit-appearance: none; }
            .gauge-container { background: #e5e7eb !important; -webkit-print-color-adjust: exact; }
            .gauge-bar { -webkit-print-color-adjust: exact; }
            .marker { background-color: white !important; -webkit-print-color-adjust: exact; }
        }
        .gauge-container {
            position: relative;
            background: #e5e7eb;
            border-radius: 9999px;
            height: 1rem; /* Compact height */
            margin-bottom: 1.25rem; /* Space for labels */
            margin-top: 0.5rem;
        }
        .gauge-bar {
            height: 100%;
            border-radius: 9999px;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.3s;
        }
        .marker {
            position: absolute;
            top: -2px;
            bottom: -2px;
            width: 2px;
            background-color: rgba(255,255,255,1);
            z-index: 10;
            box-shadow: 0 0 2px rgba(0,0,0,0.2);
        }
        .marker-label {
            position: absolute;
            top: 120%;
            font-size: 0.6rem;
            font-weight: bold;
            color: #6b7280;
            transform: translateX(-50%);
            white-space: nowrap;
        }
        /* Custom Input Style for compact look */
        .input-compact {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            width: 100%;
            text-align: center;
        }
        .input-compact:focus {
            outline: none;
            border-color: #14b8a6;
            ring: 2px solid #14b8a6;
        }
    </style>
</head>
<body class="text-gray-700 pb-20">

    <!-- Header / Nav -->
    <nav class="bg-teal-600 text-white p-3 shadow-lg no-print sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-lg font-bold flex items-center gap-2">
                <i class="fa-solid fa-heart-pulse"></i> 
                <span class="hidden sm:inline">Body Composition</span>
            </h1>
            <div class="flex gap-2">
                <button onclick="toggleInputs()" id="toggleBtn" class="bg-teal-700 hover:bg-teal-800 text-white px-3 py-1.5 rounded-full text-xs font-bold transition border border-teal-500">
                    <i class="fa-solid fa-eye-slash mr-1"></i> ซ่อนช่องกรอก
                </button>
                <button onclick="saveAsImage()" class="bg-white text-teal-700 px-3 py-1.5 rounded-full text-xs font-bold transition shadow hover:bg-gray-100">
                    <i class="fa-solid fa-image mr-1"></i> บันทึกรูป
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content Area (Capture Target) -->
    <div id="capture-area" class="bg-[#f0fdfa] min-h-screen">
        <div class="container mx-auto max-w-2xl p-3 sm:p-4" id="app">
            
            <!-- Header Report -->
            <div class="text-center mb-4 pt-2">
                <h1 class="text-xl sm:text-2xl font-bold text-teal-800">ผลวิเคราะห์องค์ประกอบร่างกาย</h1>
                <p class="text-gray-500 text-xs mt-1"><i class="fa-regular fa-calendar mr-1"></i> <span id="printDate"></span></p>
            </div>

            <!-- Section 1: Customer & Inputs (Collapsible) -->
            <div id="inputSection" class="bg-white rounded-xl shadow-sm border border-teal-100 p-4 mb-4 transition-all duration-300">
                <div class="flex items-center justify-between mb-3 border-b border-gray-100 pb-2">
                    <h2 class="text-sm font-bold text-teal-800"><i class="fa-regular fa-user mr-1"></i> ข้อมูลลูกค้า & ค่าวัด</h2>
                </div>
                
                <!-- Personal Info -->
                <div class="grid grid-cols-2 gap-2 mb-3">
                    <input type="text" id="name" placeholder="ชื่อลูกค้า" class="input-compact text-left col-span-2 font-bold text-gray-700 bg-teal-50 border-teal-200">
                    
                    <div class="flex gap-1">
                        <input type="number" id="birthYear" placeholder="ปีเกิด(พ.ศ.)" class="input-compact" oninput="updateAge()">
                        <input type="number" id="age" placeholder="อายุ" class="input-compact bg-gray-50 font-bold text-teal-700" oninput="calculateAll()">
                    </div>
                    
                    <div class="flex gap-1">
                         <select id="gender" class="input-compact" onchange="calculateAll()">
                            <option value="male">ชาย</option>
                            <option value="female">หญิง</option>
                        </select>
                        <input type="number" id="height" placeholder="สูง(cm)" class="input-compact" oninput="calculateAll()">
                    </div>
                </div>

                <!-- Measurement Inputs Grid -->
                <div class="grid grid-cols-3 gap-2 bg-gray-50 p-2 rounded-lg">
                    <div>
                        <label class="text-[10px] text-gray-500 block text-center">น้ำหนัก (kg)</label>
                        <input type="number" id="weight" placeholder="0.0" class="input-compact text-lg font-bold text-blue-600" oninput="calculateAll()">
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-500 block text-center">% ไขมัน</label>
                        <input type="number" id="fatPct" placeholder="%" class="input-compact text-lg font-bold text-yellow-600" oninput="calculateAll()">
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-500 block text-center">ไขมันช่องท้อง</label>
                        <input type="number" id="visceral" placeholder="Lv" class="input-compact text-lg font-bold text-red-600" oninput="calculateAll()">
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-500 block text-center">% กล้ามเนื้อ</label>
                        <input type="number" id="musclePct" placeholder="%" class="input-compact text-lg font-bold text-green-600" oninput="calculateAll()">
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-500 block text-center">อายุร่างกาย</label>
                        <input type="number" id="bodyAge" placeholder="ปี" class="input-compact text-lg font-bold text-purple-600" oninput="calculateAll()">
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-500 block text-center">BMR</label>
                        <input type="number" id="bmr" placeholder="kcal" class="input-compact text-lg font-bold text-gray-600" oninput="calculateAll()">
                    </div>
                </div>
            </div>

            <!-- Section 2: Analysis Cards (Result Focused) -->
            <div class="space-y-3">
                
                <!-- 1. Muscle Mass -->
                <div class="bg-white rounded-xl shadow-sm p-3 border border-gray-100">
                    <div class="flex justify-between items-center mb-1">
                        <h3 class="font-bold text-gray-700 text-sm"><i class="fa-solid fa-dumbbell mr-1 text-green-500"></i> กล้ามเนื้อ (Muscle)</h3>
                        <div class="text-right">
                            <span id="musclePctDisplay" class="text-xl font-bold text-gray-800">- %</span>
                            <span class="text-xs text-gray-400 ml-1">(<span id="muscleMassVal">-</span> kg)</span>
                        </div>
                    </div>
                    <div class="gauge-container h-3 mt-2">
                        <div id="muscleMarkers"></div>
                        <div id="muscleBar" class="gauge-bar bg-green-500 w-0"></div>
                    </div>
                     <p id="muscleText" class="text-xs font-bold text-right text-gray-400 mt-4">-</p>
                </div>

                <!-- 2. Fat Mass -->
                <div class="bg-white rounded-xl shadow-sm p-3 border border-gray-100">
                    <div class="flex justify-between items-center mb-1">
                        <h3 class="font-bold text-gray-700 text-sm"><i class="fa-solid fa-layer-group mr-1 text-yellow-500"></i> ไขมัน (Fat)</h3>
                        <div class="text-right">
                            <span id="fatPctDisplay" class="text-xl font-bold text-gray-800">- %</span>
                            <span class="text-xs text-gray-400 ml-1">(<span id="fatMassVal">-</span> kg)</span>
                        </div>
                    </div>
                    <div class="gauge-container h-3 mt-2">
                        <div id="fatMarkers"></div>
                        <div id="fatBar" class="gauge-bar bg-yellow-400 w-0"></div>
                    </div>
                    <p id="fatText" class="text-xs font-bold text-right text-gray-400 mt-4">-</p>
                </div>

                <!-- 3. Visceral Fat -->
                <div class="bg-white rounded-xl shadow-sm p-3 border border-gray-100">
                    <div class="flex justify-between items-center mb-1">
                        <h3 class="font-bold text-gray-700 text-sm"><i class="fa-solid fa-heart-crack mr-1 text-red-500"></i> ไขมันช่องท้อง (Visceral)</h3>
                        <span id="visceralValDisplay" class="text-xl font-bold text-gray-800">-</span>
                    </div>
                    <div class="gauge-container h-3 mt-2">
                        <!-- Scale 0-20 -->
                        <div class="marker left-[10%]"></div> <div class="marker-label left-[10%]">2</div>
                        <div class="marker left-[25%]"></div> <div class="marker-label left-[25%]">5</div>
                        <div class="marker left-[45%]"></div> <div class="marker-label left-[45%]">9</div>
                        <div class="marker left-[75%]"></div> <div class="marker-label left-[75%]">15</div>
                        <div id="visceralBar" class="gauge-bar bg-gray-200 w-0"></div>
                    </div>
                     <div class="grid grid-cols-4 gap-1 text-[8px] sm:text-[9px] text-gray-400 font-semibold mt-4 text-center">
                        <span class="text-teal-600">ดีมาก(1-2)</span>
                        <span class="text-green-500">ปกติ(3-5)</span>
                        <span class="text-orange-400">เริ่มสูง(>5)</span>
                        <span class="text-red-500">อันตราย(>15)</span>
                    </div>
                </div>

                <!-- 4. Body Age Card -->
                <div class="bg-white rounded-xl shadow-sm p-3 border border-gray-100 flex flex-col justify-center">
                    <h3 class="font-bold text-gray-700 text-sm mb-2 text-center"><i class="fa-solid fa-hourglass-half mr-1 text-purple-500"></i> อายุร่างกาย (Body Age)</h3>
                    <div class="flex justify-between items-center text-sm px-4">
                         <div class="text-center">
                            <span class="block text-gray-400 text-xs">อายุจริง</span>
                            <span id="realAgeDisplay" class="font-bold text-lg text-gray-800">-</span>
                         </div>
                         <div class="text-gray-300"><i class="fa-solid fa-arrow-right"></i></div>
                         <div class="text-center">
                            <span class="block text-gray-400 text-xs">อายุร่างกาย</span>
                            <span id="bodyAgeDisplay" class="font-bold text-lg text-purple-600">-</span>
                         </div>
                    </div>
                    <div id="ageDiffTag" class="mt-2 text-center text-xs font-bold text-gray-400 py-1 rounded bg-gray-50">
                        -
                    </div>
                </div>

                <!-- 5. BMI Card -->
                <div class="bg-white rounded-xl shadow-sm p-3 border border-gray-100">
                    <div class="flex justify-between items-end">
                        <h3 class="font-bold text-gray-700 text-sm"><i class="fa-solid fa-weight-scale mr-1 text-blue-500"></i> BMI</h3>
                        <span id="bmiVal" class="text-2xl font-extrabold text-gray-800">-</span>
                    </div>
                    <div class="gauge-container">
                        <!-- Markers Scale 10-40 -->
                        <div class="marker left-[28.3%]"></div> <div class="marker-label left-[28.3%]">18.5</div>
                        <div class="marker left-[43.3%]"></div> <div class="marker-label left-[43.3%]">23.0</div>
                        <div class="marker left-[50%]"></div>   <div class="marker-label left-[50%]">25.0</div>
                        <div class="marker left-[66.6%]"></div> <div class="marker-label left-[66.6%]">30.0</div>
                        <div id="bmiBar" class="gauge-bar bg-gray-200 w-0"></div>
                    </div>
                    <p id="bmiText" class="text-xs font-bold text-right text-gray-400 mt-4">-</p>
                </div>

                <!-- 6. BMR Card (New) -->
                <div class="bg-white rounded-xl shadow-sm p-3 border border-gray-100">
                    <div class="flex justify-between items-end mb-2">
                        <h3 class="font-bold text-gray-700 text-sm"><i class="fa-solid fa-fire mr-1 text-orange-500"></i> อัตราการเผาผลาญ (BMR)</h3>
                        <div class="text-right">
                            <span id="bmrValDisplay" class="text-2xl font-extrabold text-gray-800">-</span>
                            <span class="text-xs text-gray-400">kcal</span>
                        </div>
                    </div>
                    <div class="bg-orange-50 p-2 rounded-lg border border-orange-100">
                        <p class="text-xs text-orange-800 text-center">
                            การเผาผลาญถ้าอยู่เฉยๆ ทานวันละเท่านี้ น้ำหนักไม่ขึ้นไม่ลด
                        </p>
                    </div>
                </div>

                <!-- Summary Box -->
                <div class="bg-gradient-to-r from-teal-50 to-white border border-teal-200 rounded-xl p-4 shadow-sm">
                    <div class="flex justify-between items-start">
                         <div>
                            <span class="text-[10px] font-bold text-gray-400 uppercase">น้ำหนักที่เหมาะสม</span>
                            <div id="idealWeightRange" class="text-lg font-bold text-teal-700">- kg</div>
                         </div>
                         <div class="text-right">
                            <span class="text-[10px] font-bold text-gray-400 uppercase">เป้าหมาย</span>
                            <div id="weightTarget" class="text-lg font-bold text-gray-700">-</div>
                         </div>
                    </div>
                    <div class="mt-2 pt-2 border-t border-teal-100">
                         <p id="analysisText" class="text-xs text-gray-600 leading-relaxed">
                            กรอกข้อมูลเพื่อดูผลวิเคราะห์...
                        </p>
                    </div>
                </div>
            </div>

            <div class="mt-6 text-center pb-4 text-[10px] text-gray-300 no-print">
                UP Labs Body Composition
            </div>
        </div>
    </div>

    <script>
        /* CONFIGURATION */
        const CRITERIA = {
            bmi: { under: 18.5, normal: 22.9, over: 24.9, obese1: 29.9 },
            visceral: { excellent: 2, safe: 5, startHigh: 9, high: 15 },
            fat: {
                male: { low: 10, normal: 20, high: 25 }, 
                female: { low: 20, normal: 30, high: 35 } 
            },
            muscle: {
                male: { low: 33, normal: 39 }, 
                female: { low: 24, normal: 30 } 
            }
        };

        const today = new Date();
        const dateStr = today.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });
        document.getElementById('printDate').innerText = dateStr;

        function toggleInputs() {
            const section = document.getElementById('inputSection');
            const btn = document.getElementById('toggleBtn');
            
            if(section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                btn.innerHTML = '<i class="fa-solid fa-eye-slash mr-1"></i> ซ่อนช่องกรอก';
            } else {
                section.classList.add('hidden');
                btn.innerHTML = '<i class="fa-solid fa-eye mr-1"></i> แสดงช่องกรอก';
            }
        }

        function updateAge() {
            const birthYear = document.getElementById('birthYear').value;
            const currentYear = new Date().getFullYear() + 543;
            if(birthYear && birthYear > 2400 && birthYear < currentYear) {
                document.getElementById('age').value = currentYear - birthYear;
                calculateAll();
            }
        }

        function calculateAll() {
            const weight = parseFloat(document.getElementById('weight').value);
            const height = parseFloat(document.getElementById('height').value);
            const gender = document.getElementById('gender').value;
            const fatPct = parseFloat(document.getElementById('fatPct').value);
            const visceral = parseFloat(document.getElementById('visceral').value);
            const musclePct = parseFloat(document.getElementById('musclePct').value);
            const bodyAge = parseFloat(document.getElementById('bodyAge').value);
            const realAge = parseFloat(document.getElementById('age').value);
            const bmr = parseFloat(document.getElementById('bmr').value);

            // Display Info
            if(realAge) document.getElementById('realAgeDisplay').innerText = realAge;
            if(bodyAge) document.getElementById('bodyAgeDisplay').innerText = bodyAge;
            if(bmr) document.getElementById('bmrValDisplay').innerText = bmr.toLocaleString(); // Add commas

            if (!weight || !height) return;

            // 1. BMI
            const heightM = height / 100;
            const bmi = weight / (heightM * heightM);
            document.getElementById('bmiVal').innerText = bmi.toFixed(1);
            updateBMIUI(bmi);

            // 2. Fat
            if (fatPct || fatPct === 0) {
                const fatMass = (weight * fatPct) / 100;
                document.getElementById('fatMassVal').innerText = fatMass.toFixed(1);
                document.getElementById('fatPctDisplay').innerText = fatPct.toFixed(1) + "%";
                updateFatUI(fatPct, gender);
            }

            // 3. Muscle
            if (musclePct || musclePct === 0) {
                const muscleMass = (weight * musclePct) / 100;
                document.getElementById('muscleMassVal').innerText = muscleMass.toFixed(1);
                document.getElementById('musclePctDisplay').innerText = musclePct.toFixed(1) + "%";
                updateMuscleUI(musclePct, gender);
            }

            // 4. Visceral
            if (visceral || visceral === 0) {
                document.getElementById('visceralValDisplay').innerText = visceral;
                updateVisceralUI(visceral);
            }

            // 5. Body Age
            checkBodyAge();

            // 6. Ideal Weight
            calculateIdealWeight(heightM, weight, bmi);
        }

        function updateBMIUI(bmi) {
            let status = "", colorClass = "";
            let widthPct = ((bmi - 10) / 30) * 100;
            if(widthPct < 0) widthPct = 0; if(widthPct > 100) widthPct = 100;

            if (bmi < CRITERIA.bmi.under) { status = "ผอมเกินไป"; colorClass = "bg-yellow-400"; }
            else if (bmi <= CRITERIA.bmi.normal) { status = "สมส่วน (ปกติ)"; colorClass = "bg-green-500"; }
            else if (bmi <= CRITERIA.bmi.over) { status = "ท้วม (Overweight)"; colorClass = "bg-orange-400"; }
            else if (bmi <= CRITERIA.bmi.obese1) { status = "อ้วนระดับ 1"; colorClass = "bg-red-500"; }
            else { status = "อ้วนระดับ 2 (อันตราย)"; colorClass = "bg-red-700"; }

            const bar = document.getElementById('bmiBar');
            bar.style.width = `${widthPct}%`;
            bar.className = `gauge-bar ${colorClass}`;
            
            const text = document.getElementById('bmiText');
            text.innerText = status;
            text.className = `text-xs font-bold text-right mt-4 ${colorClass.replace('bg-', 'text-')}`;
        }

        function updateFatUI(fatPct, gender) {
            const limit = CRITERIA.fat[gender];
            let status = "", color = "";
            let width = (fatPct / 50) * 100;
            if(width > 100) width = 100;

            if (fatPct < limit.low) { status = "น้อยกว่าเกณฑ์"; color = "bg-yellow-400"; }
            else if (fatPct <= limit.normal) { status = "ปกติ (Good)"; color = "bg-green-500"; }
            else if (fatPct <= limit.high) { status = "เริ่มสูง"; color = "bg-orange-400"; }
            else { status = "สูงมาก"; color = "bg-red-500"; }

            const bar = document.getElementById('fatBar');
            bar.style.width = `${width}%`;
            bar.className = `gauge-bar ${color}`;
            
            const text = document.getElementById('fatText');
            text.innerText = status;
            text.className = `text-xs font-bold mt-4 ${color.replace('bg-', 'text-')}`;

            document.getElementById('fatMarkers').innerHTML = `
                <div class="marker" style="left: ${(limit.low/50)*100}%"></div>
                <div class="marker-label" style="left: ${(limit.low/50)*100}%">${limit.low}</div>
                <div class="marker" style="left: ${(limit.normal/50)*100}%"></div>
                <div class="marker-label" style="left: ${(limit.normal/50)*100}%">${limit.normal}</div>
                <div class="marker" style="left: ${(limit.high/50)*100}%"></div>
                <div class="marker-label" style="left: ${(limit.high/50)*100}%">${limit.high}</div>
            `;
        }

        function updateMuscleUI(musclePct, gender) {
            const limit = CRITERIA.muscle[gender];
            let status = "", color = "";
            // Scale 10-60 (Range 50)
            let width = ((musclePct - 10) / 50) * 100;
            if(width < 0) width = 0; if(width > 100) width = 100;

            if (musclePct < limit.low) { status = "น้อย"; color = "bg-yellow-400"; }
            else if (musclePct <= limit.normal) { status = "มาตรฐาน"; color = "bg-green-500"; }
            else { status = "สูง (Excellent)"; color = "bg-green-600"; }

            const bar = document.getElementById('muscleBar');
            bar.style.width = `${width}%`;
            bar.className = `gauge-bar ${color}`;

            const text = document.getElementById('muscleText');
            text.innerText = status;
            text.className = `text-xs font-bold mt-4 ${color.replace('bg-', 'text-')}`;

            const lowPos = ((limit.low - 10) / 50) * 100;
            const normPos = ((limit.normal - 10) / 50) * 100;
            document.getElementById('muscleMarkers').innerHTML = `
                <div class="marker" style="left: ${lowPos}%"></div>
                <div class="marker-label" style="left: ${lowPos}%">${limit.low}</div>
                <div class="marker" style="left: ${normPos}%"></div>
                <div class="marker-label" style="left: ${normPos}%">${limit.normal}</div>
            `;
        }

        function updateVisceralUI(visceral) {
            let status = "", color = "";
            let width = (visceral / 20) * 100;
            if(width > 100) width = 100;

            if (visceral <= CRITERIA.visceral.excellent) { status = "ดีมาก"; color = "bg-teal-600"; }
            else if (visceral <= CRITERIA.visceral.safe) { status = "ปกติ"; color = "bg-green-500"; }
            else if (visceral <= CRITERIA.visceral.startHigh) { status = "เริ่มสูง"; color = "bg-orange-400"; }
            else if (visceral <= CRITERIA.visceral.high) { status = "สูงมาก"; color = "bg-red-500"; }
            else { status = "อันตราย"; color = "bg-red-700"; }

            const bar = document.getElementById('visceralBar');
            bar.style.width = `${width}%`;
            bar.className = `gauge-bar ${color}`;
        }

        function checkBodyAge() {
            const realAge = parseFloat(document.getElementById('age').value);
            const bodyAge = parseFloat(document.getElementById('bodyAge').value);
            
            const tag = document.getElementById('ageDiffTag');
            
            if(!realAge || !bodyAge) {
                tag.innerText = "รอข้อมูล...";
                tag.className = "mt-2 text-center text-xs font-bold text-gray-300 py-1 rounded bg-gray-50";
                return;
            }

            const diff = bodyAge - realAge;

            if (diff > 0) {
                tag.innerText = `แก่กว่าวัย +${diff} ปี`;
                tag.className = "mt-2 text-center text-xs font-bold text-red-600 py-1 rounded bg-red-100";
            } else if (diff < 0) {
                tag.innerText = `อ่อนกว่าวัย ${diff} ปี`;
                tag.className = "mt-2 text-center text-xs font-bold text-green-600 py-1 rounded bg-green-100";
            } else {
                tag.innerText = "เท่าอายุจริง (สมส่วน)";
                tag.className = "mt-2 text-center text-xs font-bold text-blue-600 py-1 rounded bg-blue-100";
            }
        }

        function calculateIdealWeight(heightM, weight, bmi) {
            const minW = CRITERIA.bmi.under * (heightM * heightM);
            const maxW = CRITERIA.bmi.normal * (heightM * heightM);
            document.getElementById('idealWeightRange').innerText = `${minW.toFixed(1)} - ${maxW.toFixed(1)} kg`;

            let targetText = "";
            if (weight < minW) {
                targetText = `เพิ่ม +${(minW - weight).toFixed(1)}`;
                document.getElementById('weightTarget').className = "text-lg font-bold text-yellow-600";
            } else if (weight > maxW) {
                targetText = `ลด -${(weight - maxW).toFixed(1)}`;
                document.getElementById('weightTarget').className = "text-lg font-bold text-red-500";
            } else {
                targetText = "Keep";
                document.getElementById('weightTarget').className = "text-lg font-bold text-green-600";
            }
            document.getElementById('weightTarget').innerText = targetText;
            
            const name = document.getElementById('name').value || "คุณลูกค้า";
            document.getElementById('analysisText').innerHTML = `<b>คุณ ${name}</b> รูปร่างอยู่ในเกณฑ์ <b>${document.getElementById('bmiText').innerText}</b> เป้าหมายคือ <b>${targetText}</b> เพื่อให้สุขภาพแข็งแรงครับ`;
        }

        function saveAsImage() {
            // Collapse inputs for cleaner image
            const section = document.getElementById('inputSection');
            const wasHidden = section.classList.contains('hidden');
            if(!wasHidden) toggleInputs(); 

            const element = document.getElementById("capture-area");
            const btn = event.currentTarget;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ...';

            html2canvas(element, {
                scale: 2, 
                useCORS: true,
                backgroundColor: "#f0fdfa",
                windowWidth: 375 // Force mobile width capture
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `Result-${document.getElementById('name').value || 'User'}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
                btn.innerHTML = originalText;
                
                // Restore state
                if(!wasHidden) toggleInputs();
            }).catch(err => {
                alert("Error: " + err);
                btn.innerHTML = originalText;
                if(!wasHidden) toggleInputs();
            });
        }
    </script>
</body>
</html>
